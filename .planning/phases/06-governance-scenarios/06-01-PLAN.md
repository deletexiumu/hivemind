---
phase: 06-governance-scenarios
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/context/governance/metrics-core.md
  - .claude/data-warehouse/context/governance/dq-rules-core.md
autonomous: true

must_haves:
  truths:
    - "三个治理场景可引用统一的指标分类和 Semantic Layer 格式定义"
    - "DQ 规则推断可引用字段类型驱动规则和分层阈值策略"
    - "每个 *-core.md 文件控制在 800-1000 tokens 以内"
  artifacts:
    - path: ".claude/data-warehouse/context/governance/metrics-core.md"
      provides: "指标分类体系（原子/派生/复合）+ Semantic Layer 2.0 格式要点"
      contains: "原子.*Atomic|派生.*Derived|复合.*Composite"
      max_tokens: 1000
    - path: ".claude/data-warehouse/context/governance/dq-rules-core.md"
      provides: "字段类型驱动规则表 + 分层阈值策略 + 新鲜度配置"
      contains: "_id.*unique|_amt.*not_null|ODS.*DWD.*ADS"
      max_tokens: 1000
  key_links:
    - from: "metrics-core.md"
      to: "Semantic Layer 场景"
      via: "includes 引用"
      pattern: "type: context-core"
    - from: "dq-rules-core.md"
      to: "Phase 5 检查清单"
      via: "规则 ID 对应"
      pattern: "G01|D0[1-9]"
---

<objective>
创建 2 个治理相关的精简版上下文文件，为 Phase 6 的三个场景提示（指标、DQ、血缘）提供共享知识基础。

Purpose: 与 Phase 4 创建的 *-core.md 保持一致的模式，新增治理专属的上下文文件，控制 token 预算，支持运行时注入。

Output: metrics-core.md（约 800-1000 tokens）、dq-rules-core.md（约 800-1000 tokens）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-governance-scenarios/06-CONTEXT.md
@.planning/phases/06-governance-scenarios/06-RESEARCH.md

# 参考 Phase 4 的 *-core.md 格式
@.claude/data-warehouse/context/methodology/dimensional-modeling-core.md
@.claude/data-warehouse/context/layers/layering-system-core.md

# 命名规范（字段后缀规则）
@.claude/data-warehouse/docs/naming-core.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 governance 上下文目录</name>
  <files>.claude/data-warehouse/context/governance/</files>
  <action>
创建 governance 上下文目录。目录路径：
`.claude/data-warehouse/context/governance/`

若目录已存在则跳过。
  </action>
  <verify>目录存在：`ls -la .claude/data-warehouse/context/governance/`</verify>
  <done>governance 上下文目录结构就绪</done>
</task>

<task type="auto">
  <name>Task 2: 创建 metrics-core.md（指标分类 + Semantic Layer 格式）</name>
  <files>.claude/data-warehouse/context/governance/metrics-core.md</files>
  <action>
创建指标相关的精简版上下文文件，包含以下内容：

**1. Frontmatter**
```yaml
---
type: context-core
domain: governance
document: metrics-core
source: 06-RESEARCH.md + dbt Semantic Layer 2.0
version: 1.0.0
token_budget: 1000
---
```

**2. 指标分类体系（三分法）**

| 类别 | 英文 | 定义 | MetricFlow 类型映射 | 示例 |
|------|------|------|---------------------|------|
| 原子指标 | Atomic | 直接聚合的基础度量，不依赖其他指标 | `type: simple` | `SUM(order_amount)` |
| 派生指标 | Derived | 基于原子指标的计算，引用 1-2 个指标 | `type: derived` / `type: ratio` | `订单总额 / 订单数` |
| 复合指标 | Composite | 多指标组合或复杂逻辑，引用 2+ 派生指标 | `type: derived`（嵌套） | `(销售额 - 退款额) / 用户数` |

**3. 派生/复合指标关联规则**
- 派生/复合指标**必须关联**已定义的原子指标 ID
- 在 `type_params.metrics` 中声明依赖
- 确保指标血缘可追溯

**4. Semantic Layer 2.0 格式速查**

**semantic_models 结构要点：**
- `entities`: 定义实体（primary + foreign）
- `dimensions`: 定义维度（time + categorical）
- `measures`: 定义度量（agg + expr）
- `defaults.agg_time_dimension`: 指定默认时间维度

**metrics 结构要点：**
- `type`: simple | derived | ratio | cumulative | conversion
- `type_params.measure`: 引用 semantic_models 中的 measure
- `type_params.expr` + `metrics`: 派生指标的表达式和依赖

**5. Stage 1 必问项（Codex 共识）**
- grain（粒度声明）
- 时间字段（用于 time dimension）
- 可切维度（用于 dimensions）

**6. 示例片段**
提供一个简化的 semantic_models + metrics YAML 示例（5-10 行关键配置）

控制在 ~800-1000 tokens（约 800-1000 中文字符 + YAML 示例）。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/context/governance/metrics-core.md`
- 包含三分法：`grep -E "原子.*Atomic|派生.*Derived|复合.*Composite" metrics-core.md`
- 包含 MetricFlow 映射：`grep -E "type: simple|type: derived" metrics-core.md`
- 包含 Source 标注：`grep "Source:" metrics-core.md`
  </verify>
  <done>metrics-core.md 包含指标分类体系、Semantic Layer 格式速查、必问项清单</done>
</task>

<task type="auto">
  <name>Task 3: 创建 dq-rules-core.md（字段类型驱动规则 + 分层阈值）</name>
  <files>.claude/data-warehouse/context/governance/dq-rules-core.md</files>
  <action>
创建 DQ 规则相关的精简版上下文文件，包含以下内容：

**1. Frontmatter**
```yaml
---
type: context-core
domain: governance
document: dq-rules-core
source: 06-RESEARCH.md + 06-CONTEXT.md + dbt-expectations
version: 1.0.0
token_budget: 1000
---
```

**2. 字段类型驱动规则映射表**

| 后缀模式 | 示例 | 推荐规则 | 严格程度 |
|----------|------|----------|----------|
| `_id`, `_sk`, `_key` | `customer_id`, `order_sk` | `unique` + `not_null` | P0 |
| `_amt`, `_amount` | `order_amt`, `total_amount` | `not_null` + 范围检测 `>= 0` | P1 |
| `_cnt`, `_count` | `item_cnt`, `order_count` | `not_null` + 范围检测 `>= 0` (INTEGER) | P1 |
| `_status`, `_type` | `order_status`, `pay_type` | `accepted_values` | P1 |
| `_date`, `_time` | `order_date`, `create_time` | `not_null` + 格式检查 | P1 |
| `is_`, `has_` | `is_deleted`, `has_coupon` | `accepted_values: [0, 1]` | P2 |
| `*_key` (FK) | `customer_key` | `relationships` | P2 |

**3. 分层阈值策略（Codex 共识）**

| 分层 | warn_if | error_if | 适用场景 |
|------|---------|----------|----------|
| ODS | 5% | 10% | 贴源数据，容忍度高 |
| DWD/DWS | 1% | 5% | 中间层，质量要求中等 |
| ADS | 0% | 1% | 应用层，质量要求严格 |

**4. 三类阈值实现方式（Codex 共识）**

| 类型 | 实现方式 | 示例 |
|------|----------|------|
| 0 容忍 | dbt 原生 tests | `unique`, `not_null` |
| 比例阈值 | dbt-expectations `mostly` | `mostly: 0.99` |
| 行数阈值 | `warn_if/error_if` | `warn_if: ">100"` |

**5. 新鲜度检测配置（T+1 标准）**
```yaml
freshness:
  warn_after: {count: 1, period: day}
  error_after: {count: 2, period: day}
loaded_at_field: etl_time
```

**6. dbt-hive 特定约束**
- 不给 `ephemeral` 挂 tests → 改挂下游物化模型
- SCD2 默认 `where` 只测当前有效行
- 默认加分区窗口过滤降低 Hive 成本：`where dt >= date_sub(current_date, N)`

**7. 与 Phase 5 检查清单的对应**
- G01（粒度主键唯一）→ `unique` test
- D01（description）→ schema.yml 配置
- D03（tests 覆盖）→ 本文件规则

控制在 ~800-1000 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/context/governance/dq-rules-core.md`
- 包含字段类型规则：`grep -E "_id.*unique|_amt.*not_null" dq-rules-core.md`
- 包含分层阈值：`grep -E "ODS.*5%|ADS.*0%" dq-rules-core.md`
- 包含新鲜度配置：`grep "warn_after" dq-rules-core.md`
- 包含 Source 标注：`grep "Source:" dq-rules-core.md`
  </verify>
  <done>dq-rules-core.md 包含字段类型驱动规则、分层阈值策略、新鲜度配置、dbt-hive 约束</done>
</task>

</tasks>

<verification>
1. governance 目录存在：`.claude/data-warehouse/context/governance/`
2. metrics-core.md 包含指标三分法、MetricFlow 映射、Semantic Layer 格式速查
3. dq-rules-core.md 包含字段类型驱动规则、分层阈值、三类阈值实现、新鲜度配置
4. 每个文件包含 frontmatter（type: context-core, domain: governance）
5. 每个文件包含 Source 标注
6. 单文件 token 数 < 1000（字数 < 1500）
7. 两个文件合计 token 数 < 2000
</verification>

<success_criteria>
- [ ] 创建 governance 上下文目录
- [ ] metrics-core.md 包含指标分类体系（三分法 + MetricFlow 映射）
- [ ] metrics-core.md 包含 Semantic Layer 2.0 格式速查
- [ ] metrics-core.md 包含 Stage 1 必问项清单
- [ ] dq-rules-core.md 包含字段类型驱动规则映射表
- [ ] dq-rules-core.md 包含分层阈值策略
- [ ] dq-rules-core.md 包含三类阈值实现方式
- [ ] dq-rules-core.md 包含 dbt-hive 特定约束
- [ ] 两个文件的 token 预算符合要求（合计 ~2000 tokens）
</success_criteria>

<output>
After completion, create `.planning/phases/06-governance-scenarios/06-01-SUMMARY.md`
</output>
