---
phase: 06-governance-scenarios
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/generate-dq-rules/prompt.md
  - .claude/data-warehouse/prompts/scenarios/generate-dq-rules/output-template.md
  - .claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/fact-table-dq.md
  - .claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/dim-table-dq.md
autonomous: true

must_haves:
  truths:
    - "用户可输入表/模型定义，系统输出 dbt tests 配置"
    - "自动生成 5 类检测：unique、not_null、accepted_values、relationships、freshness"
    - "两段式交互：Stage 1 规则清单预览，Stage 2 完整 dbt tests YAML"
    - "分层阈值自动适配（ODS 宽松 / ADS 严格）"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/generate-dq-rules/prompt.md"
      provides: "DQ 规则生成场景主提示文件"
      contains: "两段式交互|Stage 1|Stage 2|字段类型驱动"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-dq-rules/output-template.md"
      provides: "Stage 1 规则清单 + Stage 2 dbt tests YAML 模板"
      contains: "unique|not_null|accepted_values|relationships|freshness"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/fact-table-dq.md"
      provides: "事实表 DQ 规则案例"
      contains: "dwd_fact_|tests:"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/dim-table-dq.md"
      provides: "维度表 DQ 规则案例（含 SCD2 处理）"
      contains: "dim_|is_current|where:"
  key_links:
    - from: "prompt.md"
      to: "dq-rules-core.md"
      via: "includes 声明引用"
      pattern: "includes.*dq-rules-core"
    - from: "output-template.md"
      to: "dbt schema.yml"
      via: "tests 配置格式"
      pattern: "tests:|columns:"
---

<objective>
创建 DQ 规则生成场景（DQRULES）的完整提示系统，包括主提示、输出模板和案例库。

Purpose: 实现 DQRULES-01 ~ DQRULES-07 需求，使用户可以输入表/模型定义，获取完整的 dbt tests 配置。

Output: prompt.md（约 1,300 tokens）、output-template.md（约 700 tokens）、2 个案例（各约 600 tokens）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-governance-scenarios/06-CONTEXT.md
@.planning/phases/06-governance-scenarios/06-RESEARCH.md
@.planning/phases/06-governance-scenarios/06-01-SUMMARY.md

# 参考 Phase 4/5 的提示结构
@.claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md

# Plan 01 创建的上下文
@.claude/data-warehouse/context/governance/dq-rules-core.md

# 参考检查清单
@.claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 generate-dq-rules 场景目录</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-dq-rules/</files>
  <action>
创建 generate-dq-rules 场景目录结构：
```
.claude/data-warehouse/prompts/scenarios/generate-dq-rules/
├── examples/
```

若目录已存在则跳过。
  </action>
  <verify>目录存在：`ls -la .claude/data-warehouse/prompts/scenarios/generate-dq-rules/`</verify>
  <done>generate-dq-rules 场景目录结构就绪</done>
</task>

<task type="auto">
  <name>Task 2: 创建主提示文件 prompt.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-dq-rules/prompt.md</files>
  <action>
创建 DQ 规则生成场景主提示文件，采用与 Phase 4/5 一致的 4-block 结构。

**1. Frontmatter**
```yaml
---
type: scenario-prompt
scenario: generate-dq-rules
version: 1.0.0
token_budget: 1500
includes:
  - context/governance/dq-rules-core
  - context/layers/layering-system-core
  - context/platform/hive-constraints-core
  - context/platform/dbt-hive-limitations-core
  - docs/naming-core
---
```

**2. INSTRUCTIONS 块**
- 角色：数据质量工程师
- 任务：根据用户输入的表/模型定义，自动生成 dbt tests 配置
- 两段式交互（与 Phase 4/5 一致）：
  - Stage 1（默认）：输出规则清单（按字段类型推断的规则 + 分层阈值）+ 待确认问题
  - Stage 2（用户确认后）：输出完整的 dbt tests YAML + dbt-expectations 配置（如需要）
- 触发 Stage 2：用户回复"生成配置"/"继续"/"确认"
- 特殊情况：简单表（≤5 字段）且规则无歧义时，可自动合并输出

**3. CONTEXT 块**
```
{CONTEXT_PLACEHOLDER: 运行时注入的上下文}
```

**4. TASK 块**

**Stage 1 必问项清单（Codex 共识）：**

**A. 目标与载体（必问）：**
- 是 source 还是 model？
- 物化方式？（table/view/incremental/ephemeral）
- 若 ephemeral → 指定 tests 挂载的下游物化模型名

**B. 字段清单（必问）：**
- 字段列表：`name + type`（可选：中文含义）
- 关键角色字段标注：主键/候选键、外键、金额/数量、状态/类型、时间、分区、软删除

**C. 分区（必问）：**
- 分区列名、类型与格式
- 分区粒度：日/小时
- 数据写入频率

**D. 窗口（必问）：**
- 默认测试范围：最近 N 个分区/天
- 是否允许全量扫描？
- 迟到/回灌最大延迟

**E. SCD2 / 有效行条件（仅维表/历史表必问）：**
- 是否 SCD2/历史拉链？
- "当前有效行"过滤条件（`is_current = 1` / `end_dt is null`）
- 是否有软删除？

**F. 阈值策略（必问）：**
- 哪些规则 0 容忍（dbt 原生 tests）
- 哪些规则用比例阈值（dbt-expectations `mostly`）
- 哪些规则用行数阈值（`warn_if/error_if`）
- 分层口径（ODS/DWD/DWS/ADS）

**G. 新鲜度（必问）：**
- 对 source 是否启用 source freshness？
- 新鲜度依据字段：`load_dt`（优先）或 `event_time`

**H. Hive 成本/方言（建议必问）：**
- 允许的最大扫描分区数
- dt 类型决定过滤表达式

**5. OUTPUT FORMAT 块**
- Stage 1：规则清单预览格式引用
- Stage 2：dbt tests YAML 格式引用
- 说明 `### File: {path}` 输出格式

**6. 规则推断逻辑速查**
引用 dq-rules-core.md 的字段类型驱动规则表（简化版）

控制在 ~1,300 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/generate-dq-rules/prompt.md`
- 包含 4-block 结构：`grep -E "INSTRUCTIONS|CONTEXT|TASK|OUTPUT FORMAT" prompt.md`
- 包含两段式交互：`grep -E "Stage 1|Stage 2" prompt.md`
- 包含必问项：`grep -E "分区|窗口|SCD2|阈值策略|新鲜度" prompt.md`
  </verify>
  <done>prompt.md 包含完整的 4-block 结构、两段式交互机制、Stage 1 必问项清单</done>
</task>

<task type="auto">
  <name>Task 3: 创建输出模板文件 output-template.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-dq-rules/output-template.md</files>
  <action>
创建 Stage 1/Stage 2 的详细输出格式模板。

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: generate-dq-rules
document: output-template
version: 1.0.0
token_budget: 700
---
```

**2. Stage 1 输出模板：规则清单预览**

```markdown
# DQ 规则清单

## 目标信息

| 属性 | 值 |
|------|-----|
| **目标类型** | {source/model} |
| **表/模型名** | {table_name} |
| **分层** | {ODS/DWD/DWS/ADS} |
| **物化方式** | {table/view/incremental} |
| **分区列** | {partition_column} |

## 推断规则清单

| # | 字段 | 规则类型 | 依据 | 阈值 | 优先级 |
|---|------|----------|------|------|--------|
| 1 | order_sk | unique + not_null | _sk 后缀 | 0 容忍 | P0 |
| 2 | order_amount | not_null + 范围 | _amount 后缀 | 0 容忍 | P1 |
| 3 | order_status | accepted_values | _status 后缀 | mostly 99% | P1 |
| ... | ... | ... | ... | ... | ... |

## 分层阈值

| 类型 | 实现方式 | 值 |
|------|----------|-----|
| 严格规则 | dbt 原生 | 0 容忍 |
| 比例规则 | mostly | {layer_threshold}% |
| 行数规则 | warn_if/error_if | warn {N} / error {M} |

## 新鲜度检测

| 属性 | 值 |
|------|-----|
| **依据字段** | {freshness_field} |
| **warn_after** | {warn_value} |
| **error_after** | {error_value} |

{若为 SCD2/维表}
## 有效行过滤

- 测试范围：`WHERE {is_current_condition}`
- 原因：SCD2 历史行不参与唯一性检测

## 待确认问题

{列出需要用户确认的问题}

---

回复"**生成配置**"获取完整的 dbt tests YAML。
```

**3. Stage 2 输出模板：dbt tests YAML**

```markdown
# dbt Tests 配置

## 依赖说明

- dbt version: 1.7+
- 可选：dbt-expectations 0.10.x（复杂规则）

### File: models/{layer}/{table_name}.yml

```yaml
version: 2

models:
  - name: {table_name}
    description: "{description}"
    meta:
      layer: {layer}
      owner: {owner}

    # 表级测试（组合唯一性等）
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [{pk_columns}]
          config:
            where: "dt >= date_sub(current_date, {N})"  # Hive 分区过滤

    columns:
      # 主键/代理键
      - name: {pk_column}
        description: "{pk_description}"
        tests:
          - unique:
              config:
                where: "{partition_filter}"
          - not_null

      # 金额字段
      - name: {amount_column}
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: {max_value}
              config:
                severity: warn

      # 状态字段
      - name: {status_column}
        tests:
          - not_null
          - accepted_values:
              values: [{status_values}]
              config:
                severity: warn
                warn_if: ">0"
                error_if: ">{error_threshold}"

      # 外键字段
      - name: {fk_column}
        tests:
          - not_null
          - relationships:
              to: ref('{dim_table}')
              field: {dim_pk}
              config:
                where: "{partition_filter}"
```

{若为 source}
### File: models/sources/{source_name}.yml

```yaml
version: 2

sources:
  - name: {source_name}
    freshness:
      warn_after: {count: {warn_count}, period: day}
      error_after: {count: {error_count}, period: day}
    loaded_at_field: {freshness_field}

    tables:
      - name: {table_name}
        columns:
          - name: {pk_column}
            tests:
              - unique
              - not_null
```

## Hive 方言注意事项

- 日期过滤使用 `date_sub(current_date, N)`
- 正则函数使用 `regexp_like()` 或 `rlike`
- 确保 dt 分区列类型与过滤表达式匹配
```

控制在 ~700 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/generate-dq-rules/output-template.md`
- 包含 Stage 1/2 结构：`grep -E "Stage 1|Stage 2|规则清单" output-template.md`
- 包含 dbt tests 格式：`grep -E "tests:|columns:" output-template.md`
- 包含 Hive 分区过滤：`grep "date_sub" output-template.md`
  </verify>
  <done>output-template.md 包含 Stage 1 规则清单和 Stage 2 dbt tests YAML 的完整格式</done>
</task>

<task type="auto">
  <name>Task 4: 创建案例库（事实表 + 维度表）</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/fact-table-dq.md
    .claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/dim-table-dq.md
  </files>
  <action>
创建 2 个 DQ 规则生成案例，覆盖事实表和维度表两种典型场景。

**案例 1: fact-table-dq.md（订单明细事实表 DQ 规则）**

```yaml
---
type: scenario-example
scenario: generate-dq-rules
example: fact-table-dq
complexity: medium
---
```

**用户输入：**
```
表名：dwd_fact_order_detail
分层：DWD
物化：incremental
分区列：dt (STRING, 格式 YYYY-MM-DD)
测试范围：最近 7 天

字段清单：
- order_detail_sk (BIGINT) - 代理键
- order_no (STRING) - 订单号
- order_item_id (STRING) - 订单行 ID
- customer_key (BIGINT) - 客户维度外键
- product_key (BIGINT) - 产品维度外键
- line_amount (DECIMAL) - 行金额
- order_status (STRING) - 订单状态
- is_deleted (INT) - 删除标志
- dt (STRING) - 日期分区
```

**Stage 1 输出：**
- 推断规则清单（8+ 条规则）
- 组合唯一性建议：`order_no + order_item_id + dt`
- 分层阈值：DWD 适用 warn 1% / error 5%
- 待确认：order_status 的枚举值列表

**Stage 2 输出：**
- 完整的 dbt tests YAML
- 包含 where 分区过滤
- 包含 relationships 外键检测

**案例 2: dim-table-dq.md（客户维度表 DQ 规则 - SCD2）**

```yaml
---
type: scenario-example
scenario: generate-dq-rules
example: dim-table-dq
complexity: medium
---
```

**用户输入：**
```
表名：dim_customer
分层：DWD
物化：table
是 SCD2：是
有效行条件：is_current = 1

字段清单：
- customer_sk (BIGINT) - 代理键
- customer_id (STRING) - 自然键
- customer_name (STRING) - 客户名称
- customer_level (STRING) - 客户等级
- is_current (INT) - 当前有效标志
- dw_valid_from (DATE) - 生效日期
- dw_valid_to (DATE) - 失效日期
```

**Stage 1 输出：**
- 推断规则清单（6+ 条规则）
- SCD2 唯一性规则：`customer_sk` unique（当前有效行）
- 自然键规则：`customer_id` unique（当前有效行）
- 待确认：customer_level 的枚举值列表

**Stage 2 输出：**
- 完整的 dbt tests YAML
- 所有规则包含 `where: "is_current = 1"` 过滤
- 说明：SCD2 历史行不参与唯一性检测

每个案例控制在 ~600 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/generate-dq-rules/examples/`
- 事实表案例包含 dwd_fact_：`grep "dwd_fact_" examples/fact-table-dq.md`
- 维度表案例包含 SCD2 处理：`grep -E "is_current|where:" examples/dim-table-dq.md`
- 案例包含 tests 配置：`grep "tests:" examples/*.md`
  </verify>
  <done>2 个 DQ 规则案例创建完成，覆盖事实表和维度表两种典型场景</done>
</task>

</tasks>

<verification>
1. generate-dq-rules 目录结构完整
2. prompt.md 包含完整的 4-block 结构和两段式交互机制
3. prompt.md 包含 Stage 1 必问项清单（8 类必问项）
4. output-template.md 包含 Stage 1 规则清单和 Stage 2 dbt tests YAML 格式
5. 2 个案例分别覆盖事实表和维度表（含 SCD2 处理）
6. 所有文件的 token 预算符合要求（合计 ~3,200 tokens）
</verification>

<success_criteria>
- [ ] 创建 generate-dq-rules 场景目录结构
- [ ] prompt.md 包含 INSTRUCTIONS/CONTEXT/TASK/OUTPUT FORMAT 四个块
- [ ] prompt.md 实现两段式交互（Stage 1 规则清单 + Stage 2 dbt tests YAML）
- [ ] prompt.md 包含 Stage 1 必问项清单（分区、窗口、SCD2、阈值、新鲜度）
- [ ] output-template.md 包含规则清单预览格式
- [ ] output-template.md 包含 dbt tests YAML 格式（含 Hive 分区过滤）
- [ ] 事实表案例展示字段类型驱动规则推断
- [ ] 维度表案例展示 SCD2 有效行过滤（`where: "is_current = 1"`）
- [ ] 所有文件的 token 预算符合要求
</success_criteria>

<output>
After completion, create `.planning/phases/06-governance-scenarios/06-03-SUMMARY.md`
</output>
