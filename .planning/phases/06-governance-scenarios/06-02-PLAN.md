---
phase: 06-governance-scenarios
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/define-metrics/prompt.md
  - .claude/data-warehouse/prompts/scenarios/define-metrics/output-template.md
  - .claude/data-warehouse/prompts/scenarios/define-metrics/examples/atomic-metric.md
  - .claude/data-warehouse/prompts/scenarios/define-metrics/examples/derived-metric.md
autonomous: true

must_haves:
  truths:
    - "用户可输入指标名称和业务描述，系统输出标准化指标定义"
    - "两段式交互：Stage 1 指标规格书，Stage 2 Semantic Layer YAML"
    - "派生/复合指标强制关联已定义的原子指标 ID"
    - "输出格式为 dbt Semantic Layer 2.0 兼容 YAML"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/define-metrics/prompt.md"
      provides: "指标定义场景主提示文件"
      contains: "两段式交互|Stage 1|Stage 2|指标规格书"
    - path: ".claude/data-warehouse/prompts/scenarios/define-metrics/output-template.md"
      provides: "Stage 1 规格书 + Stage 2 Semantic Layer YAML 模板"
      contains: "semantic_models|metrics|grain"
    - path: ".claude/data-warehouse/prompts/scenarios/define-metrics/examples/atomic-metric.md"
      provides: "原子指标案例（订单总额）"
      contains: "type: simple"
    - path: ".claude/data-warehouse/prompts/scenarios/define-metrics/examples/derived-metric.md"
      provides: "派生指标案例（平均客单价）"
      contains: "type: derived"
  key_links:
    - from: "prompt.md"
      to: "metrics-core.md"
      via: "includes 声明引用"
      pattern: "includes.*metrics-core"
    - from: "output-template.md"
      to: "dbt Semantic Layer 2.0"
      via: "YAML 格式"
      pattern: "semantic_models:|metrics:"
---

<objective>
创建指标定义场景（METRICS）的完整提示系统，包括主提示、输出模板和案例库。

Purpose: 实现 METRICS-01 ~ METRICS-06 需求，使用户可以输入指标名称和业务描述，获取标准化的指标定义和 dbt Semantic Layer 兼容 YAML。

Output: prompt.md（约 1,200 tokens）、output-template.md（约 700 tokens）、2 个案例（各约 500 tokens）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-governance-scenarios/06-CONTEXT.md
@.planning/phases/06-governance-scenarios/06-RESEARCH.md
@.planning/phases/06-governance-scenarios/06-01-SUMMARY.md

# 参考 Phase 4/5 的提示结构
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md

# Plan 01 创建的上下文
@.claude/data-warehouse/context/governance/metrics-core.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 define-metrics 场景目录</name>
  <files>.claude/data-warehouse/prompts/scenarios/define-metrics/</files>
  <action>
创建 define-metrics 场景目录结构：
```
.claude/data-warehouse/prompts/scenarios/define-metrics/
├── examples/
```

若目录已存在则跳过。
  </action>
  <verify>目录存在：`ls -la .claude/data-warehouse/prompts/scenarios/define-metrics/`</verify>
  <done>define-metrics 场景目录结构就绪</done>
</task>

<task type="auto">
  <name>Task 2: 创建主提示文件 prompt.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/define-metrics/prompt.md</files>
  <action>
创建指标定义场景主提示文件，采用与 Phase 4/5 一致的 4-block 结构。

**1. Frontmatter**
```yaml
---
type: scenario-prompt
scenario: define-metrics
version: 1.0.0
token_budget: 1500
includes:
  - context/governance/metrics-core
  - context/methodology/fact-table-types-core
  - context/layers/layering-system-core
  - docs/naming-core
---
```

**2. INSTRUCTIONS 块**
- 角色：指标管理员 / 数据产品经理
- 任务：根据用户输入的指标名称和业务描述，输出标准化指标定义和 Semantic Layer YAML
- 两段式交互（与 Phase 4/5 一致）：
  - Stage 1（默认）：输出指标规格书（分类、公式、源表追踪、关联指标、待确认问题）
  - Stage 2（用户确认后）：输出 Semantic Layer YAML + 口径说明文档
- 触发 Stage 2：用户回复"生成 YAML"/"继续"/"确认"
- 特殊情况：原子指标且信息完整时，可自动合并输出精简版

**3. CONTEXT 块**
```
{CONTEXT_PLACEHOLDER: 运行时注入的上下文}
```
说明运行时注入机制

**4. TASK 块**

**输入格式（必填最小集）：**
| 字段 | 必填 | 说明 |
|------|------|------|
| 指标名称 | ✓ | 指标的业务名称 |
| 业务描述 | ✓ | 指标的业务含义和用途 |

**可选信息：**
| 字段 | 说明 | 缺失处理 |
|------|------|----------|
| 计算公式草稿 | 用户提供的初步公式 | 根据描述推断 |
| 关联模型 | dbt 模型名称 | Stage 2 追问 |
| 粒度 | 数据粒度（如"每日/每订单"）| 从描述推断 |

**Stage 1 必问项（Codex 共识）：**
- grain（粒度声明）— 必须明确
- 时间字段（用于 time dimension）— 必须明确
- 可切维度（用于 dimensions）— 推荐明确

**5. OUTPUT FORMAT 块**
- Stage 1：指标规格书格式引用
- Stage 2：Semantic Layer YAML 格式引用
- 说明 `### File: {path}` 输出格式（便于工具化落盘）

**6. 示例**
提供一个简化的 Stage 1 输出示例（订单总额指标）

控制在 ~1,200 tokens（约 1000-1200 中文字符）。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/define-metrics/prompt.md`
- 包含 4-block 结构：`grep -E "INSTRUCTIONS|CONTEXT|TASK|OUTPUT FORMAT" prompt.md`
- 包含两段式交互：`grep -E "Stage 1|Stage 2" prompt.md`
- 包含 includes 声明：`grep "includes:" prompt.md`
- 包含必问项：`grep -E "grain|时间字段|可切维度" prompt.md`
  </verify>
  <done>prompt.md 包含完整的 4-block 结构、两段式交互机制、必填最小集和必问项</done>
</task>

<task type="auto">
  <name>Task 3: 创建输出模板文件 output-template.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/define-metrics/output-template.md</files>
  <action>
创建 Stage 1/Stage 2 的详细输出格式模板。

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: define-metrics
document: output-template
version: 1.0.0
token_budget: 700
---
```

**2. Stage 1 输出模板：指标规格书**

```markdown
# 指标规格书

## 基本信息

| 属性 | 值 |
|------|-----|
| **指标名称** | {metric_name} |
| **指标 ID** | {metric_id}（自动生成，格式：`{domain}_{name}`） |
| **分类** | {原子/派生/复合} |
| **业务描述** | {description} |

## 计算定义

| 属性 | 值 |
|------|-----|
| **计算公式** | `{formula}` |
| **聚合方式** | {SUM/COUNT/AVG/COUNT_DISTINCT/...} |
| **粒度** | {grain_description} |
| **时间维度** | {time_dimension} |
| **可切维度** | {dimensions_list} |

## 数据来源

| 属性 | 值 |
|------|-----|
| **源模型** | {source_model} |
| **源字段** | {source_fields} |
| **数据分层** | {layer: DWD/DWS} |

{若为派生/复合指标}
## 指标依赖

| 依赖指标 ID | 指标名称 | 依赖类型 |
|-------------|----------|----------|
| {dep_id} | {dep_name} | {分子/分母/...} |

## 待确认问题

{列出需要用户确认的问题}

---

回复"**生成 YAML**"获取 dbt Semantic Layer 配置。
```

**3. Stage 2 输出模板：Semantic Layer YAML**

```markdown
# dbt Semantic Layer 配置

## 依赖说明

- dbt version: 1.7+
- 需要 MetricFlow 支持

### File: models/semantic/{domain}_semantic.yml

```yaml
semantic_models:
  - name: {semantic_model_name}
    model: ref('{dbt_model_name}')
    description: |
      {description}
    defaults:
      agg_time_dimension: {time_dimension}

    entities:
      - name: {primary_entity}
        type: primary
        expr: {primary_key}
      # 可选 foreign entities

    dimensions:
      - name: {time_dimension}
        type: time
        type_params:
          time_granularity: day
      # 其他 categorical 维度

    measures:
      - name: {measure_name}
        description: "{measure_description}"
        agg: {agg_type}
        expr: {expr}

metrics:
  - name: {metric_id}
    description: "{description}"
    type: {simple/derived}
    label: "{label}"
    type_params:
      measure: {measure_name}  # 原子指标
      # 或
      # expr: {formula}        # 派生指标
      # metrics:
      #   - name: {dep_metric_1}
      #   - name: {dep_metric_2}
    meta:
      owner: {owner}
      depends_on: [{dep_ids}]   # 指标血缘追溯
```

### File: docs/metrics/{metric_id}.md

```markdown
# {metric_name}

## 业务口径

{business_definition}

## 计算逻辑

{calculation_logic}

## 使用说明

{usage_notes}

## 变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | {date} | 初始版本 |
```
```

控制在 ~700 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/define-metrics/output-template.md`
- 包含 Stage 1/2 结构：`grep -E "Stage 1|Stage 2|指标规格书" output-template.md`
- 包含 Semantic Layer 格式：`grep -E "semantic_models|metrics:" output-template.md`
- 包含 meta.depends_on：`grep "depends_on" output-template.md`
  </verify>
  <done>output-template.md 包含 Stage 1 规格书和 Stage 2 Semantic Layer YAML 的完整格式</done>
</task>

<task type="auto">
  <name>Task 4: 创建案例库（原子指标 + 派生指标）</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/define-metrics/examples/atomic-metric.md
    .claude/data-warehouse/prompts/scenarios/define-metrics/examples/derived-metric.md
  </files>
  <action>
创建 2 个指标定义案例，覆盖原子指标和派生指标两种典型场景。

**案例 1: atomic-metric.md（订单总额 - 原子指标）**

```yaml
---
type: scenario-example
scenario: define-metrics
example: atomic-metric
complexity: simple
---
```

**用户输入：**
```
指标名称：订单总额
业务描述：统计一段时间内所有已完成订单的金额总和
```

**Stage 1 输出：**
- 指标规格书完整示例
- 分类判定：原子指标（直接聚合，不依赖其他指标）
- 公式推断：`SUM(order_amount)`
- 源表追踪：`dwd_fact_order_detail`
- 待确认：粒度（按日还是按订单？）、状态过滤（仅已完成？）

**Stage 2 输出：**
- 完整的 semantic_models + metrics YAML
- 口径说明文档

**案例 2: derived-metric.md（平均客单价 - 派生指标）**

```yaml
---
type: scenario-example
scenario: define-metrics
example: derived-metric
complexity: medium
---
```

**用户输入：**
```
指标名称：平均客单价
业务描述：每笔订单的平均金额，用于衡量客户消费水平
关联指标：订单总额、订单数
```

**Stage 1 输出：**
- 指标规格书完整示例
- 分类判定：派生指标（引用 2 个原子指标）
- 公式推断：`订单总额 / 订单数`
- 指标依赖清单（order_total_amount + order_count）
- 待确认：是否排除退款订单？

**Stage 2 输出：**
- 派生指标 YAML（`type: derived` + `type_params.expr` + `metrics`）
- `meta.depends_on` 包含依赖指标 ID
- 口径说明文档

每个案例控制在 ~500 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/define-metrics/examples/`
- 原子指标案例包含 `type: simple`：`grep "type: simple" examples/atomic-metric.md`
- 派生指标案例包含 `type: derived`：`grep "type: derived" examples/derived-metric.md`
- 派生指标案例包含依赖声明：`grep "depends_on" examples/derived-metric.md`
  </verify>
  <done>2 个指标案例创建完成，覆盖原子和派生两种典型场景</done>
</task>

</tasks>

<verification>
1. define-metrics 目录结构完整
2. prompt.md 包含完整的 4-block 结构和两段式交互机制
3. prompt.md 的 includes 声明正确引用 metrics-core 和 *-core.md 文档
4. output-template.md 包含 Stage 1 规格书和 Stage 2 Semantic Layer YAML 格式
5. 2 个案例分别覆盖原子指标和派生指标
6. 所有文件的 token 预算符合要求（合计 ~2,900 tokens）
</verification>

<success_criteria>
- [ ] 创建 define-metrics 场景目录结构
- [ ] prompt.md 包含 INSTRUCTIONS/CONTEXT/TASK/OUTPUT FORMAT 四个块
- [ ] prompt.md 实现两段式交互（Stage 1 规格书 + Stage 2 YAML）
- [ ] prompt.md 包含 Stage 1 必问项（grain、时间字段、可切维度）
- [ ] output-template.md 包含指标规格书格式
- [ ] output-template.md 包含 Semantic Layer 2.0 YAML 格式
- [ ] 原子指标案例展示 `type: simple` 指标
- [ ] 派生指标案例展示 `type: derived` 指标和 `meta.depends_on`
- [ ] 所有文件的 token 预算符合要求
</success_criteria>

<output>
After completion, create `.planning/phases/06-governance-scenarios/06-02-SUMMARY.md`
</output>
