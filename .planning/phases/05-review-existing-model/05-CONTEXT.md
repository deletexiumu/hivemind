# Phase 5: 评审已有模型 - Context

**Gathered:** 2026-01-31
**Status:** Ready for planning

<domain>
## Phase Boundary

实现"评审已有模型"场景的完整提示系统——用户输入模型 SQL/dbt 配置/DDL，系统输出问题清单 + 修复建议。评审维度包括命名规范、分层引用、粒度主键、字段类型、dbt 配置五大类。

**覆盖需求（REVIEW-01 ~ REVIEW-08）：**
- 问题清单包含严重级别（P0/P1/P2/P3）和位置定位
- 每个问题附带修复建议（代码片段 + 说明）
- 检查命名规范、分层引用、主键粒度、字段类型、dbt 配置的合规性

**不在范围内：**
- 自动修复功能（只提供建议，不执行修改）
- 跨模型整体评审（单模型评审，不是项目级审计）
- 实时集成（批量式评审，不是 IDE 插件）

</domain>

<decisions>
## Implementation Decisions

### 评审交互模式
- **两段式交互**：Stage 1 输出问题概览/分级，用户确认后 Stage 2 输出详细修复建议
- **输入必填最小集**：SQL 代码 + 元信息（分层/粒度声明），dbt 配置为可选增强
- **信息缺失处理**：主动追问缺失信息，待用户补充后再进行评审
- **评审范围**：智能范围——根据输入内容自动确定可评审的维度

### 问题分级与呈现
- **分级标准**：按影响程度分级
  - P0 严重：数据质量问题（粒度不清晰/主键重复/禁止跨层引用）
  - P1 高优：设计缺陷（命名不符/SCD 策略不合理/字段类型错误）
  - P2 中优：风险提示（度量可加性未标记/分区键可优化）
  - P3 低优：代码风格（命名过长/注释可完善）
- **评分机制**：加权扣分制
  - 从 100 分开始，P0 扣 25 分，P1 扣 10 分，P2 扣 3 分，P3 扣 1 分
- **问题排序**：按优先级排序（P0 → P3），严重问题先展示
- **重点推荐**：高亮展示所有 P0 问题作为必须修复项

### 检查项组织
- **分类方式**：按五大检查维度组织
  1. 命名规范检查（表名前缀、字段命名、保留字）
  2. 分层引用检查（跨层依赖、维度表引用）
  3. 粒度与主键检查（粒度声明、主键一致性、隐藏扇形）
  4. 字段类型与注释检查（类型合理性、注释完整性）
  5. dbt 配置检查（description、tests、meta 标签）
- **强制性**：所有检查项全部强制执行，不符合即报问题
- **检查透明度**：显示完整检查清单（✓/✗），包含通过项和失败项

### 修复建议格式
- **前后对比**：使用并排展示格式，分别显示"当前"和"修复后"
- **代码详细度**：Claude 自行判断——简单问题给完整代码，复杂问题给指引
- **复杂修复**：Claude 自行判断——超过 3 处变更时拆分为多步骤
- **修复理由**：每个修复建议必须包含"为什么要改"的说明

### Claude's Discretion
- 检查深度根据输入复杂度自动调整
- 代码片段详细程度根据问题复杂度判断
- 复杂修复是否分步骤根据变更数量判断

</decisions>

<specifics>
## Specific Ideas

- Stage 1 的问题概览应包含：问题总数、各级别数量、总分、是否通过（如 P0=0 且分数 ≥ 70）
- 检查清单可视化使用类似 `[✓] 表名前缀正确` 或 `[✗] 字段注释缺失` 格式
- 前后对比使用 markdown 两栏格式或代码块标注：
  ```
  当前：fact_orders
  修复：dwd_fact_orders
  原因：按命名规范，细节层表应以 dwd_ 前缀开头
  ```
- 借鉴 Phase 4 的 `### File: {path}` 格式输出修复后的 schema.yml

</specifics>

<deferred>
## Deferred Ideas

无——讨论过程中保持了阶段边界

</deferred>

---

*Phase: 05-review-existing-model*
*Context gathered: 2026-01-31*
