# Phase 5: 评审已有模型 - Context

**Gathered:** 2026-01-31
**Status:** Ready for planning

<domain>
## Phase Boundary

实现"评审已有模型"场景的完整提示系统——用户输入模型 SQL/dbt 配置/DDL，系统输出问题清单 + 修复建议。评审维度包括命名规范、分层引用、粒度主键、字段类型、dbt 配置五大类。

**覆盖需求（REVIEW-01 ~ REVIEW-08）：**
- 问题清单包含严重级别（P0/P1/P2/P3）和位置定位
- 每个问题附带修复建议（代码片段 + 说明）
- 检查命名规范、分层引用、主键粒度、字段类型、dbt 配置的合规性

**不在范围内：**
- 自动修复功能（只提供建议，不执行修改）
- 跨模型整体评审（单模型评审，不是项目级审计）
- 实时集成（批量式评审，不是 IDE 插件）

</domain>

<decisions>
## Implementation Decisions

### 评审交互模式
- **两段式交互**：Stage 1 输出问题概览/分级，用户确认后 Stage 2 输出详细修复建议
- **输入必填最小集**：SQL 代码（必填）；元信息（分层/粒度声明）强烈建议；schema.yml/dbt 配置为可选增强
- **信息缺失处理**：优先追问缺失信息；同时对可评审维度先输出部分评审，不可评审项标记为 `— 未评审`（不计分）
- **评审范围**：智能范围——根据输入内容自动确定可评审的维度
- **评审范围标签**：Stage 1 总览展示 `完整/部分（缺少 schema.yml）/部分（缺少元信息）`

### 问题分级与呈现
- **分级标准**：按影响程度分级
  - P0 严重：数据质量问题（粒度不清晰/主键重复/禁止跨层引用）
  - P1 高优：设计缺陷（命名不符/SCD 策略不合理/字段类型错误）
  - P2 中优：风险提示（度量可加性未标记/分区键可优化）
  - P3 低优：代码风格（命名过长/注释可完善）
- **评分机制**：门禁 + 质量分
  - **门禁（pass/fail）**：P0 > 0 → 结论 = 不通过
  - **质量分（quality_score）**：从 100 分开始，仅按 P1/P2/P3 扣分，最低 0 分
    - P1: -10
    - P2: -3
    - P3: -1
  - `— 未评审` 项不计分
- **结论（三态）**：
  - 不通过：P0 > 0
  - 通过：P0 = 0 且 quality_score >= 70
  - 有条件通过：P0 = 0 且 quality_score < 70
- **问题排序**：按优先级排序（P0 → P3），严重问题先展示
- **重点推荐**：高亮展示所有 P0 问题作为必须修复项

### 检查项组织
- **分类方式**：按五大检查维度组织
  1. 命名规范检查（表名前缀、字段命名、保留字）
  2. 分层引用检查（跨层依赖、维度表引用）
  3. 粒度与主键检查（粒度声明、主键一致性、隐藏扇形）
  4. 字段类型与注释检查（类型合理性、注释完整性）
  5. dbt 配置检查（description、tests、meta 标签）
- **强制性**：所有可评审检查项强制执行，不符合即报问题；不可评审项标记 `— 未评审`（不计分）
- **检查透明度**：默认输出按维度聚合视图（如 `命名规范检查 (5/7)`），仅展开 ✗；用户可请求完整清单（含 ✓/✗）

### 修复建议格式
- **前后对比**：S/M 档使用并排展示格式，分别显示"当前"和"修复后"
- **详细度分档**：按改动范围/风险/不确定性分为 S/M/L/XL
  - S（单点改动）→ 完整可粘贴片段
  - M（同文件多处联动）→ 最小变更块 + 同步修改清单
  - L（逻辑重构/高风险）→ 分步骤指引 + 关键代码骨架 + 验证 SQL
  - XL（多文件联动）→ 变更概览 + 按文件展开（`### File: {path}`）
- **修复理由**：每个修复建议必须包含"为什么要改"的说明

### Claude's Discretion
- 检查深度根据输入复杂度自动调整
- 在 S/M/L/XL 分档框架下选择合适详细度
- 复杂修复优先给出“最小可通过（P0 清零）”修复集，再给优化项

</decisions>

<specifics>
## Specific Ideas

- Stage 1 的问题概览应包含：结论、评审范围、质量分、P0 问题数、各级别数量
- 检查清单默认使用聚合视图（通过率 + 仅展开 ✗）；用户可请求完整清单（含 ✓）
- 前后对比使用 markdown 两栏格式或代码块标注：
  ```
  当前：fact_orders
  修复：dwd_fact_orders
  原因：按命名规范，细节层表应以 dwd_ 前缀开头
  ```
- 借鉴 Phase 4 的 `### File: {path}` 格式输出修复后的 schema.yml

</specifics>

<deferred>
## Deferred Ideas

无——讨论过程中保持了阶段边界

</deferred>

---

*Phase: 05-review-existing-model*
*Context gathered: 2026-01-31*
