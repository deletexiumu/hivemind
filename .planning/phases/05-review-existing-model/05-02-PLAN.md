---
phase: 05-review-existing-model
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/fix-suggestions.md
autonomous: true

must_haves:
  truths:
    - "用户可以输入 SQL/dbt 配置/DDL，系统输出带分级的问题清单"
    - "两段式交互：Stage 1 问题概览，Stage 2 详细修复建议"
    - "修复建议使用前后对比格式，包含修复理由"
    - "输出格式稳定，符合 output-template.md 定义"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md"
      provides: "评审场景主提示文件"
      contains: "两段式交互|Stage 1|Stage 2"
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md"
      provides: "Stage 1/Stage 2 输出格式模板"
      contains: "评审总览|检查清单|问题摘要"
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/fix-suggestions.md"
      provides: "修复建议格式模板（S/M/L/XL 分档）"
      contains: "当前|修复后|原因"
  key_links:
    - from: "prompt.md"
      to: "issue-classification.md, review-checklist.md"
      via: "includes 声明引用"
      pattern: "includes.*issue-classification|review-checklist"
    - from: "output-template.md"
      to: "issue-classification.md"
      via: "评分机制引用"
      pattern: "quality_score|门禁"
---

<objective>
创建评审场景的主提示文件、输出模板和修复建议模板，实现两段式交互机制。

Purpose: 实现 REVIEW-01 ~ REVIEW-08 需求，使用户可以输入模型代码，获取带分级的问题清单和可操作的修复建议。
Output: prompt.md（约 1,200 tokens）、output-template.md（约 600 tokens）、fix-suggestions.md（约 500 tokens）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-review-existing-model/05-CONTEXT.md
@.planning/phases/05-review-existing-model/05-RESEARCH.md
@.planning/phases/05-review-existing-model/05-01-SUMMARY.md

# 参考 Phase 4 的提示结构
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md

# Plan 01 创建的规则文档
@.claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建主提示文件 prompt.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md</files>
  <action>
创建评审场景主提示文件，采用与 Phase 4 一致的 4-block 结构。

**1. Frontmatter**
```yaml
---
type: scenario-prompt
scenario: review-existing-model
version: 1.0.0
token_budget: 1500
includes:
  - prompts/scenarios/review-existing-model/issue-classification
  - prompts/scenarios/review-existing-model/review-checklist
  - prompts/scenarios/review-existing-model/fix-suggestions
  - context/methodology/dimensional-modeling-core
  - context/methodology/fact-table-types-core
  - context/methodology/scd-strategies-core
  - context/layers/layering-system-core
  - context/platform/hive-constraints-core
  - context/platform/dbt-hive-limitations-core
  - docs/naming-core
---
```

**2. INSTRUCTIONS 块**
- 角色：资深数据建模师评审官
- 任务：根据用户输入的 SQL/dbt 配置/DDL，按五大维度执行评审
- 两段式交互（与 Phase 4 设计场景一致）：
  - Stage 1（默认）：输出问题概览 + 检查清单（聚合视图）+ 问题摘要
  - Stage 2（用户确认后）：输出每个问题的详细修复建议
- 触发 Stage 2：用户回复"查看修复建议"/"详细"/"继续"
- 特殊情况：当问题 ≤2 且无 P0 时，自动合并输出精简修复建议

**3. CONTEXT 块**
```
{CONTEXT_PLACEHOLDER: 运行时注入的上下文}
```
说明运行时注入机制（与 Phase 4 一致）

**4. TASK 块**
输入格式：
- 必填：SQL 代码
- 强烈建议：元信息（分层声明、粒度声明）
- 可选增强：schema.yml、DDL

智能范围评审（05-CONTEXT.md 决策）：
| 输入 | 可评审维度 |
|------|-----------|
| 仅 SQL | 命名、分层引用（从 ref/source 推断）、dbt 部分 |
| SQL + 元信息 | 命名、分层引用、粒度主键 |
| SQL + 元信息 + schema.yml | 命名、分层引用、粒度主键、dbt 配置 |
| SQL + 元信息 + schema.yml + DDL | 全部五个维度 |

信息缺失时的处理：
- 先做部分评审
- 主动追问缺失信息
- 不可评审项标记 `— 未评审`（不计分）

**5. OUTPUT FORMAT 块**
Stage 1 输出结构引用，Stage 2 引用 output-template.md

**6. 示例**
提供一个简化的 Stage 1 输出示例（参考 05-RESEARCH.md Example 1）

控制在 ~1,200 tokens（约 1000-1200 中文字符）。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md`
- 包含 4-block 结构：`grep -E "INSTRUCTIONS|CONTEXT|TASK|OUTPUT FORMAT" prompt.md`
- 包含两段式交互：`grep -E "Stage 1|Stage 2" prompt.md`
- 包含 includes 声明：`grep "includes:" prompt.md`
  </verify>
  <done>prompt.md 包含完整的 4-block 结构、两段式交互机制、智能范围评审规则</done>
</task>

<task type="auto">
  <name>Task 2: 创建输出模板文件 output-template.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md</files>
  <action>
创建 Stage 1/Stage 2 的详细输出格式模板。

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: review-existing-model
document: output-template
version: 1.0.0
token_budget: 600
---
```

**2. Stage 1 输出模板**

参考 05-RESEARCH.md Example 1，包含：

```markdown
# 模型评审报告

## 评审总览

| 指标 | 值 |
|------|-----|
| **结论** | {不通过/通过/有条件通过} |
| **评审范围** | {完整/部分（缺少 XXX）} |
| **质量分** | {N}/100 |
| **P0 问题** | {N} 个 |
| **P1 问题** | {N} 个 |
| **P2 问题** | {N} 个 |
| **P3 问题** | {N} 个 |

{若 P0 > 0}
**必须修复：** 存在 P0 问题，无法通过评审

---

## 检查清单（聚合视图）

> 默认仅展开 ✗；回复"完整清单"查看全部 ✓/✗

### 1. 命名规范检查 ({passed}/{total})
{仅列出 ✗ 的项}

### 2. 分层引用检查 ({passed}/{total})
...（五个维度）

---

## 问题摘要

| # | 级别 | 类别 | 问题 | 位置 |
|---|------|------|------|------|
| 1 | **P0** | ... | ... | ... |
...

---

回复"**查看修复建议**"获取每个问题的详细修复方案。
```

**3. Stage 2 输出模板**

```markdown
# 详细修复建议

## [P0] {问题标题}

**位置：** {文件/行号}

**问题说明：** {问题描述}

**当前：**
```{lang}
{当前代码}
```

**修复后：**
```{lang}
{修复后代码}
```

**修复理由：** {为什么要改，引用规范}

{若 L/XL 档}
**验证方法：**
```sql
-- 验证 SQL
```

---

（重复每个问题）
```

控制在 ~600 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md`
- 包含 Stage 1/2 结构：`grep -E "Stage 1|Stage 2" output-template.md`
- 包含评审总览：`grep "评审总览" output-template.md`
- 包含修复建议格式：`grep -E "当前|修复后|修复理由" output-template.md`
  </verify>
  <done>output-template.md 包含 Stage 1 问题概览和 Stage 2 修复建议的完整格式模板</done>
</task>

<task type="auto">
  <name>Task 3: 创建修复建议模板文件 fix-suggestions.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/fix-suggestions.md</files>
  <action>
创建修复建议的详细格式模板，包含 S/M/L/XL 分档规则。

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: review-existing-model
document: fix-suggestions
version: 1.0.0
token_budget: 500
---
```

**2. 修复建议详细度分档（05-CONTEXT.md 决策）**

| 档位 | 适用场景 | 输出格式 |
|------|----------|----------|
| S | 单点改动，确定性强 | "当前 vs 修复后" + 可粘贴片段 + 理由 |
| M | 同文件多处联动 | 最小变更块 + 同步修改清单 |
| L | 逻辑重构/高风险 | 分步骤指引 + 关键代码骨架 + 验证 SQL |
| XL | 多文件联动 | 变更概览 + 按 `### File: {path}` 分文件展开 |

**3. 各档位示例模板**

**S 档示例：**
```markdown
### [P1] 命名规范：表名前缀不符

**位置：** 表定义

**当前：**
```sql
CREATE TABLE fact_orders (...)
```

**修复后：**
```sql
CREATE TABLE dwd_fact_orders (...)
```

**原因：** 按 `naming-core.md`，细节层事实表应以 `dwd_fact_` 前缀开头
```

**M 档示例：**
```markdown
### [P1] 命名规范：字段命名不符（2 处）

**位置：** 第 8-9 行

**变更清单：**
| 当前 | 修复后 |
|------|--------|
| orderAmt | order_amt |
| custID | customer_id |

**原因：** 按 `naming-core.md`，字段名应全小写 + 下划线分隔
```

**L 档示例：**
```markdown
### [P0] 主键与粒度不一致

**位置：** 代理键生成逻辑

**问题说明：** ...

**修复步骤：**
1. 确认粒度声明
2. 修改代理键生成逻辑
3. 验证唯一性

**关键代码骨架：**
```sql
CAST(conv(substr(md5(concat_ws('||', order_id, order_item_id, dt)), 1, 15), 16, 10) AS BIGINT) AS order_detail_sk
```

**验证 SQL：**
```sql
SELECT order_detail_sk, COUNT(*) FROM ... GROUP BY 1 HAVING COUNT(*) > 1;
```
```

**XL 档示例：**
```markdown
### [P0] dbt 配置完全缺失

**变更概览：**
需要创建/修改 2 个文件：
1. `models/dwd/schema.yml` — 添加模型配置
2. `models/dwd/dwd_fact_orders.sql` — 添加 config 块

### File: models/dwd/schema.yml
（YAML 配置片段）

### File: models/dwd/dwd_fact_orders.sql
（SQL 头部 config 块片段）
```

控制在 ~500 tokens。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/fix-suggestions.md`
- 包含分档定义：`grep -E "S.*单点|M.*联动|L.*重构|XL.*多文件" fix-suggestions.md`
- 包含示例模板：`grep -E "当前|修复后|原因" fix-suggestions.md`
  </verify>
  <done>fix-suggestions.md 包含 S/M/L/XL 四档的详细格式模板和示例</done>
</task>

</tasks>

<verification>
1. prompt.md 包含完整的 4-block 结构和两段式交互机制
2. prompt.md 的 includes 声明正确引用 Plan 01 创建的文档和 *-core.md 文档
3. output-template.md 包含 Stage 1/Stage 2 的完整输出格式
4. fix-suggestions.md 包含 S/M/L/XL 四档的详细格式模板
5. 三个文件的 token 预算符合要求（合计 ~2,300 tokens）
</verification>

<success_criteria>
- [ ] prompt.md 包含 INSTRUCTIONS/CONTEXT/TASK/OUTPUT FORMAT 四个块
- [ ] prompt.md 实现两段式交互（Stage 1 概览 + Stage 2 修复建议）
- [ ] prompt.md 实现智能范围评审（根据输入内容确定可评审维度）
- [ ] output-template.md 包含 Stage 1 评审总览、检查清单、问题摘要的格式
- [ ] output-template.md 包含 Stage 2 修复建议的格式（前后对比 + 理由）
- [ ] fix-suggestions.md 包含 S/M/L/XL 四档的详细格式模板
- [ ] 三个文件的 token 预算符合要求
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-existing-model/05-02-SUMMARY.md`
</output>
