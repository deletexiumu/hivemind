---
phase: 05-review-existing-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md
autonomous: true

must_haves:
  truths:
    - "问题分级有明确的 P0/P1/P2/P3 定义和典型问题映射"
    - "检查清单覆盖五大维度的 60+ 条检查规则"
    - "每条检查规则可追溯到项目已有的 *-core.md 规范文档"
    - "评分机制清晰（门禁 + 质量分）"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md"
      provides: "问题分级标准与评分机制"
      contains: "P0.*严重|P1.*高优|P2.*中优|P3.*低优"
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md"
      provides: "五大检查维度的结构化检查清单"
      contains: "命名规范检查|分层引用检查|粒度与主键检查"
  key_links:
    - from: "review-checklist.md"
      to: "*-core.md 文档"
      via: "规则来源引用"
      pattern: "规则来源.*-core\\.md"
---

<objective>
创建评审场景的问题分级文档和检查清单文档，建立评审规则基础。

Purpose: 为主提示文件提供检查规则和评分标准的引用基础，确保评审标准与设计场景（Phase 4）一致。
Output: issue-classification.md（约 500 tokens）、review-checklist.md（约 1,000 tokens）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-review-existing-model/05-CONTEXT.md
@.planning/phases/05-review-existing-model/05-RESEARCH.md

# 规范来源（检查规则映射）
@.claude/data-warehouse/docs/naming-core.md
@.claude/data-warehouse/context/layers/layering-system-core.md
@.claude/data-warehouse/context/methodology/fact-table-types-core.md
@.claude/data-warehouse/context/methodology/scd-strategies-core.md
@.claude/data-warehouse/context/platform/hive-constraints-core.md
@.claude/data-warehouse/context/platform/dbt-hive-limitations-core.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建场景目录结构</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/</files>
  <action>
创建 review-existing-model 场景目录。目录路径：
`.claude/data-warehouse/prompts/scenarios/review-existing-model/`

若目录已存在则跳过。
  </action>
  <verify>目录存在：`ls -la .claude/data-warehouse/prompts/scenarios/review-existing-model/`</verify>
  <done>目录结构就绪</done>
</task>

<task type="auto">
  <name>Task 2: 创建问题分级文档 issue-classification.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md</files>
  <action>
创建问题分级文档，包含以下内容：

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: review-existing-model
document: issue-classification
version: 1.0.0
token_budget: 500
---
```

**2. 分级标准（用户决策 - 05-CONTEXT.md）**
按影响程度分为 P0/P1/P2/P3 四级：
- P0 严重：数据质量问题（粒度不清晰/主键重复/禁止跨层引用/dbt 配置完全缺失）
- P1 高优：设计缺陷（命名不符/SCD 策略不合理/字段类型错误/事实表缺少标准字段）
- P2 中优：风险提示（度量可加性未标记/分区键可优化/关键字段缺少 tests）
- P3 低优：代码风格（命名过长/注释可完善/非关键字段缺少 description）

**3. 评分机制（用户决策 - 05-CONTEXT.md）**
门禁 + 质量分：
- **门禁（pass/fail）**：P0 > 0 则结论 = 不通过
- **质量分（quality_score）**：从 100 分开始，仅按 P1(-10)/P2(-3)/P3(-1) 扣分，最低 0 分
- `— 未评审` 项不计分

**4. 结论（三态）**
- 不通过：P0 > 0
- 通过：P0 = 0 且 quality_score >= 70
- 有条件通过：P0 = 0 且 quality_score < 70

**5. 各级别具体问题映射表**
使用 Markdown 表格列出每个级别的典型问题。参考 05-RESEARCH.md "Issue Classification" 章节。

控制在 ~500 tokens（约 400-500 中文字符）。
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md`
- 包含四个级别：`grep -E "P0|P1|P2|P3" issue-classification.md`
- 包含评分机制：`grep "quality_score" issue-classification.md`
  </verify>
  <done>issue-classification.md 包含完整的分级标准、评分机制和问题映射</done>
</task>

<task type="auto">
  <name>Task 3: 创建检查清单文档 review-checklist.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md</files>
  <action>
创建五大检查维度的结构化检查清单，每条规则可追溯到 *-core.md 文档。

**1. Frontmatter**
```yaml
---
type: scenario-support
scenario: review-existing-model
document: review-checklist
version: 1.0.0
token_budget: 1000
---
```

**2. 五大检查维度**

按 05-RESEARCH.md "Example 3: 检查清单模块结构" 格式：

### 1. 命名规范检查
> 规则来源: `docs/naming-core.md`

| ID | 检查项 | 级别 | 规则 |
|----|--------|------|------|
| N01 | 分层前缀 | P1 | 表名必须以 ods_/dwd_/dws_/ads_/dim_ 开头 |
| N02 | 表名格式 | P1 | 全小写 + 下划线分隔 |
...（约 10 项）

### 2. 分层引用检查
> 规则来源: `context/layers/layering-system-core.md`

| ID | 检查项 | 级别 | 规则 |
|----|--------|------|------|
| L01 | DWD 引用 | P0 | DWD 仅可引用 ODS |
...（约 5 项）

### 3. 粒度与主键检查
> 规则来源: `context/methodology/fact-table-types-core.md`

| ID | 检查项 | 级别 | 规则 |
|----|--------|------|------|
| G01 | 粒度声明 | P0 | 必须有明确粒度声明 |
...（约 5 项）

### 4. 字段类型与注释检查
> 规则来源: `context/methodology/fact-table-types-core.md`, `docs/naming-core.md`

| ID | 检查项 | 级别 | 规则 |
|----|--------|------|------|
| F01 | 日期类型 | P1 | 日期用 DATE，时间用 TIMESTAMP |
...（约 6 项）

### 5. dbt 配置检查
> 规则来源: `context/platform/dbt-hive-limitations-core.md`

| ID | 检查项 | 级别 | 规则 |
|----|--------|------|------|
| D01 | description | P0 | 模型必须有 description |
...（约 7 项）

**要求：**
- 总计 30-40 条检查项（精简版，完整版在运行时引用 *-core.md）
- 每条规则标注 ID（便于引用）、级别（P0-P3）、规则描述
- 每个维度标注规则来源文档
- 控制在 ~1,000 tokens（约 800-1000 中文字符）
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md`
- 包含五大维度：`grep -E "命名规范|分层引用|粒度与主键|字段类型|dbt 配置" review-checklist.md`
- 包含规则来源：`grep "规则来源" review-checklist.md`
  </verify>
  <done>review-checklist.md 包含五大维度的 30-40 条检查规则，每条可追溯到规范文档</done>
</task>

</tasks>

<verification>
1. 目录结构完整：`.claude/data-warehouse/prompts/scenarios/review-existing-model/` 存在
2. issue-classification.md 包含 P0-P3 分级标准和评分机制
3. review-checklist.md 包含五大检查维度的结构化规则
4. 所有规则可追溯到项目已有的 *-core.md 文档
5. Token 预算符合要求（issue: ~500, checklist: ~1000）
</verification>

<success_criteria>
- [ ] 创建场景目录 review-existing-model
- [ ] issue-classification.md 包含完整分级标准（P0-P3）、评分机制（门禁+质量分）、三态结论
- [ ] review-checklist.md 包含五大检查维度的 30-40 条规则
- [ ] 每条检查规则有唯一 ID、级别标注、规则来源
- [ ] 两个文件的 token 预算符合要求（合计 ~1,500 tokens）
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-existing-model/05-01-SUMMARY.md`
</output>
