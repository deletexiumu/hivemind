---
phase: 05-review-existing-model
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/good-model.md
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/naming-issues.md
  - .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/multiple-issues.md
autonomous: true

must_haves:
  truths:
    - "案例覆盖从'非常好'到'有多个问题'的不同质量等级"
    - "每个案例展示完整的两段式交互（输入 -> Stage 1 -> Stage 2）"
    - "案例的评审结果与检查清单规则一致"
    - "案例可作为用户学习参考和质量基准"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/examples/good-model.md"
      provides: "高质量模型案例（通过评审）"
      contains: "结论.*通过|quality_score.*[89][0-9]|100"
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/examples/naming-issues.md"
      provides: "命名问题案例（有条件通过）"
      contains: "P1.*命名|有条件通过"
    - path: ".claude/data-warehouse/prompts/scenarios/review-existing-model/examples/multiple-issues.md"
      provides: "多问题案例（不通过）"
      contains: "P0|不通过"
  key_links:
    - from: "examples/*.md"
      to: "review-checklist.md"
      via: "检查规则引用"
      pattern: "N0[0-9]|L0[0-9]|G0[0-9]|F0[0-9]|D0[0-9]"
---

<objective>
创建评审场景的案例库，包含 3 个不同质量等级的模型评审案例。

Purpose: 验证评审提示系统的完整性，为用户提供学习参考和质量基准，确保评审结果可信度 > 85%。
Output: 3 个案例文件（good-model.md, naming-issues.md, multiple-issues.md）
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-review-existing-model/05-CONTEXT.md
@.planning/phases/05-review-existing-model/05-RESEARCH.md
@.planning/phases/05-review-existing-model/05-01-SUMMARY.md
@.planning/phases/05-review-existing-model/05-02-SUMMARY.md

# 评审场景文档
@.claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/issue-classification.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/review-checklist.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/output-template.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/fix-suggestions.md

# 参考 Phase 4 案例结构
@.claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建案例目录并创建高质量模型案例 good-model.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/examples/good-model.md</files>
  <action>
创建案例目录和第一个案例：高质量模型（通过评审）。

**1. 创建案例目录**
`.claude/data-warehouse/prompts/scenarios/review-existing-model/examples/`

**2. 案例结构**
参考 Phase 4 案例结构：输入 -> Stage 1 -> Stage 2 -> 要点

**3. good-model.md 内容**

```markdown
---
type: scenario-example
scenario: review-existing-model
example: good-model
quality_level: high
expected_result: 通过
expected_score: 95-100
---

# 案例：高质量订单事实表

## 输入

### SQL 代码

```sql
-- dwd_fact_order_detail.sql
-- 订单明细事实表，粒度：每个订单行

{{
  config(
    materialized='incremental',
    incremental_strategy='insert_overwrite',
    partition_by=['dt'],
    on_schema_change='fail'
  )
}}

WITH order_detail AS (
    SELECT
        order_id,
        order_item_id,
        ...
    FROM {{ ref('ods_order_detail') }}
    WHERE dt = '{{ var("ds") }}'
)

SELECT
    CAST(conv(substr(md5(concat_ws('||', order_id, order_item_id, dt)), 1, 15), 16, 10) AS BIGINT) AS order_detail_sk,
    order_id,
    order_item_id,
    customer_key,
    product_key,
    order_date,
    quantity,
    unit_price,
    line_amount,
    is_deleted,
    etl_date,
    dw_create_time,
    dw_modify_time,
    dt
FROM order_detail
```

### 元信息

| 项目 | 值 |
|------|-----|
| 分层 | DWD |
| 粒度 | 一个订单行（order_id + order_item_id） |

### schema.yml

```yaml
version: 2

models:
  - name: dwd_fact_order_detail
    description: "订单明细事实表，记录每个订单行的详细信息"
    meta:
      owner: data-team
      layer: dwd
      grain: order_item
    columns:
      - name: order_detail_sk
        description: "订单明细代理键"
        tests:
          - unique
          - not_null
      - name: order_id
        description: "订单ID"
        tests:
          - not_null
      - name: customer_key
        description: "客户维度外键"
        tests:
          - relationships:
              to: ref('dim_customer')
              field: customer_sk
      - name: line_amount
        description: "订单行金额（可加）"
        meta:
          additivity: additive
```

---

## Stage 1 输出

### 评审总览

| 指标 | 值 |
|------|-----|
| **结论** | 通过 |
| **评审范围** | 完整 |
| **质量分** | 97/100 |
| **P0 问题** | 0 个 |
| **P1 问题** | 0 个 |
| **P2 问题** | 1 个 |
| **P3 问题** | 0 个 |

### 检查清单（聚合视图）

### 1. 命名规范检查 (10/10) — 全部通过

### 2. 分层引用检查 (5/5) — 全部通过

### 3. 粒度与主键检查 (5/5) — 全部通过

### 4. 字段类型与注释检查 (5/6)
- [✗] 部分度量字段未标注可加性 ⚠️ P2

### 5. dbt 配置检查 (7/7) — 全部通过

### 问题摘要

| # | 级别 | 类别 | 问题 | 位置 |
|---|------|------|------|------|
| 1 | P2 | 可加性 | quantity、unit_price 未标注可加性 | schema.yml |

---

## Stage 2 输出

### [P2] 度量可加性未标注

**位置：** schema.yml columns 定义

**当前：**
```yaml
- name: quantity
  description: "数量"
- name: unit_price
  description: "单价"
```

**修复后：**
```yaml
- name: quantity
  description: "数量（可加）"
  meta:
    additivity: additive
- name: unit_price
  description: "单价（不可加）"
  meta:
    additivity: non-additive
```

**原因：** 按 `fact-table-types-core.md`，度量字段应标注可加性（additive/semi-additive/non-additive）

---

## 要点

1. **高质量模型特征**：命名规范、粒度清晰、主键正确、dbt 配置完整
2. **唯一问题（P2）**：可加性标注不完整，属于优化建议而非必须修复
3. **评审范围**：完整（提供了 SQL + 元信息 + schema.yml）
```

控制案例在合理长度（约 600-800 字）。
  </action>
  <verify>
- 目录存在：`ls -la .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/`
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/good-model.md`
- 包含预期结果：`grep "通过" good-model.md`
- 包含完整结构：`grep -E "输入|Stage 1|Stage 2|要点" good-model.md`
  </verify>
  <done>good-model.md 展示高质量模型的评审过程，结论为"通过"，质量分 95+</done>
</task>

<task type="auto">
  <name>Task 2: 创建命名问题案例 naming-issues.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/examples/naming-issues.md</files>
  <action>
创建第二个案例：存在命名规范问题的模型（有条件通过）。

**案例特征：**
- 无 P0 问题
- 2-3 个 P1 命名问题（表名前缀、字段命名）
- 1-2 个 P2/P3 问题
- 质量分 60-69，结论"有条件通过"

**案例结构：**

```markdown
---
type: scenario-example
scenario: review-existing-model
example: naming-issues
quality_level: medium
expected_result: 有条件通过
expected_score: 60-69
---

# 案例：命名规范问题模型

## 输入

### SQL 代码

```sql
-- fact_orders.sql （注意：缺少分层前缀）
-- 订单事实表

SELECT
    order_id AS OrderID,        -- 问题：camelCase
    customer_id AS CustID,      -- 问题：缩写 + camelCase
    orderAmount AS order_amt,   -- 问题：camelCase
    order_date,
    qty,                        -- 问题：缩写不一致
    ...
FROM ods_orders
```

### 元信息

| 项目 | 值 |
|------|-----|
| 分层 | DWD |
| 粒度 | 一个订单（order_id） |

---

## Stage 1 输出

### 评审总览

| 指标 | 值 |
|------|-----|
| **结论** | 有条件通过 |
| **评审范围** | 部分（缺少 schema.yml） |
| **质量分** | 67/100 |
| **P0 问题** | 0 个 |
| **P1 问题** | 3 个 |
| **P2 问题** | 0 个 |
| **P3 问题** | 1 个 |

### 检查清单（聚合视图）

### 1. 命名规范检查 (4/8)
- [✗] N01: 表名前缀不符（fact_orders 应为 dwd_fact_orders） ⚠️ P1
- [✗] N05: 字段命名不符规范（OrderID, CustID, orderAmount 使用 camelCase） ⚠️ P1
- [✗] N05: 字段命名不符规范（qty 缩写不一致，应为 quantity） ⚠️ P1
- [✗] N04: 命名缩写不一致（CustID vs customer_id） ⚠️ P3

### 2. 分层引用检查 (3/3) — 全部通过

### 3. 粒度与主键检查 — 未评审（缺少 DDL）

### 4. 字段类型与注释检查 — 未评审（缺少 DDL）

### 5. dbt 配置检查 — 未评审（缺少 schema.yml）

### 问题摘要

| # | 级别 | 类别 | 问题 | 位置 |
|---|------|------|------|------|
| 1 | P1 | 命名规范 | 表名前缀不符 | fact_orders |
| 2 | P1 | 命名规范 | 字段命名不符规范 | OrderID, CustID, orderAmount |
| 3 | P1 | 命名规范 | 字段命名不符规范 | qty 缩写 |
| 4 | P3 | 命名规范 | 命名缩写不一致 | CustID vs customer_id |

---

## Stage 2 输出

### [P1] 表名前缀不符 (S 档)

**位置：** 表定义

**当前：**
```sql
-- fact_orders.sql
```

**修复后：**
```sql
-- dwd_fact_orders.sql
```

**原因：** 按 `naming-core.md`，DWD 层事实表应以 `dwd_fact_` 前缀开头

---

### [P1] 字段命名不符规范 (M 档)

**位置：** SELECT 字段列表

**变更清单：**
| 当前 | 修复后 |
|------|--------|
| OrderID | order_id |
| CustID | customer_id |
| orderAmount | order_amt |
| qty | quantity |

**原因：** 按 `naming-core.md`，字段名应全小写 + 下划线分隔，避免缩写不一致

---

## 要点

1. **评审范围受限**：缺少 schema.yml 和 DDL，粒度/字段类型/dbt 配置无法评审
2. **主要问题**：命名规范（P1 x3），均可通过批量重命名修复
3. **质量分 67**：低于 70 分阈值，结论为"有条件通过"
4. **建议**：补充 schema.yml 后重新评审以获取完整评审结果
```
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/naming-issues.md`
- 包含预期结果：`grep "有条件通过" naming-issues.md`
- 包含命名问题：`grep -E "P1.*命名" naming-issues.md`
  </verify>
  <done>naming-issues.md 展示命名规范问题的评审过程，结论为"有条件通过"，质量分 60-69</done>
</task>

<task type="auto">
  <name>Task 3: 创建多问题案例 multiple-issues.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/review-existing-model/examples/multiple-issues.md</files>
  <action>
创建第三个案例：存在多个严重问题的模型（不通过）。

**案例特征：**
- 1-2 个 P0 问题（主键与粒度不一致、禁止跨层引用）
- 2-3 个 P1 问题
- 1-2 个 P2/P3 问题
- 结论"不通过"（P0 > 0）

**案例结构：**

```markdown
---
type: scenario-example
scenario: review-existing-model
example: multiple-issues
quality_level: low
expected_result: 不通过
expected_score: N/A (P0 门禁)
---

# 案例：多问题严重缺陷模型

## 输入

### SQL 代码

```sql
-- dws_order_summary.sql
-- 订单汇总表，粒度：每天每客户

SELECT
    customer_id,                          -- 问题：应该是 customer_key
    order_date,
    SUM(amount) AS total_amt,
    COUNT(*) AS order_cnt,
    dt
FROM {{ source('raw', 'raw_orders') }}    -- P0: DWS 直接引用 source（应引用 DWD）
GROUP BY customer_id, order_date, dt
```

### 元信息

| 项目 | 值 |
|------|-----|
| 分层 | DWS |
| 粒度 | 每天每客户 |

### schema.yml

```yaml
version: 2

models:
  - name: dws_order_summary
    # 问题：无 description
    columns:
      - name: customer_id
        # 问题：无 description，无 tests
```

---

## Stage 1 输出

### 评审总览

| 指标 | 值 |
|------|-----|
| **结论** | 不通过 |
| **评审范围** | 完整 |
| **质量分** | 72/100 |
| **P0 问题** | 2 个 |
| **P1 问题** | 2 个 |
| **P2 问题** | 1 个 |
| **P3 问题** | 1 个 |

**必须修复：** 存在 P0 问题，无法通过评审（质量分仅反映 P1-P3 设计质量）

### 检查清单（聚合视图）

### 1. 命名规范检查 (8/9)
- [✗] N06: 外键命名不符（customer_id 应为 customer_key） ⚠️ P1

### 2. 分层引用检查 (2/4)
- [✗] L02: DWS 禁止直接引用 source ⚠️ P0
- [✗] L05: DWS 应引用 DWD 层表 ⚠️ P0

### 3. 粒度与主键检查 (4/5)
- [✗] G02: 缺少主键/代理键定义 ⚠️ P1

### 4. 字段类型与注释检查 (5/6)
- [✗] F04: 度量可加性未标注 ⚠️ P2

### 5. dbt 配置检查 (4/6)
- [✗] D01: 模型缺少 description ⚠️ P0 → P3（已有 name 但无描述）
- [✗] D02: 主键字段缺少 unique/not_null tests ⚠️ P3

### 问题摘要

| # | 级别 | 类别 | 问题 | 位置 |
|---|------|------|------|------|
| 1 | **P0** | 分层引用 | DWS 直接引用 source | FROM 子句 |
| 2 | **P0** | 分层引用 | DWS 应引用 DWD 层表 | FROM 子句 |
| 3 | P1 | 命名规范 | 外键命名不符 | customer_id |
| 4 | P1 | 粒度主键 | 缺少主键定义 | 模型整体 |
| 5 | P2 | 可加性 | 度量可加性未标注 | total_amt, order_cnt |
| 6 | P3 | dbt 配置 | 模型缺少 description | schema.yml |

---

## Stage 2 输出

### [P0] DWS 直接引用 source (L 档)

**位置：** FROM 子句

**问题说明：**
DWS（汇总层）直接引用 `source('raw', 'raw_orders')`，违反分层引用规则。DWS 应仅引用 DWD 层表或维度表。

**修复步骤：**
1. 确认 DWD 层是否已有订单明细表（如 `dwd_fact_orders`）
2. 如果没有，先创建 DWD 层表
3. 修改 DWS 表引用 DWD 层表

**当前：**
```sql
FROM {{ source('raw', 'raw_orders') }}
```

**修复后：**
```sql
FROM {{ ref('dwd_fact_orders') }}
```

**原因：** 按 `layering-system-core.md`，DWS 仅可引用 DWD/DIM，禁止直接引用 ODS/source

**验证方法：**
```bash
# 检查 dbt lineage
dbt ls --select +dws_order_summary
# 确认上游仅包含 dwd_* 或 dim_* 表
```

---

### [P1] 缺少主键定义 (M 档)

**位置：** 模型整体

**问题说明：**
粒度声明为"每天每客户"，但模型未定义主键/代理键，无法保证数据唯一性。

**变更清单：**

**SQL 修改：**
```sql
SELECT
    CAST(conv(substr(md5(concat_ws('||', customer_key, order_date, dt)), 1, 15), 16, 10) AS BIGINT) AS order_summary_sk,
    ...
```

**schema.yml 修改：**
```yaml
columns:
  - name: order_summary_sk
    description: "订单汇总代理键"
    tests:
      - unique
      - not_null
```

**原因：** 按 `fact-table-types-core.md`，汇总表需要代理键唯一标识粒度

---

## 要点

1. **P0 门禁触发**：2 个分层引用 P0 问题导致"不通过"，质量分仅供参考
2. **核心问题**：DWS 直接引用 source，架构设计严重缺陷
3. **修复优先级**：先修复 P0（分层引用），再修复 P1（主键定义）
4. **完整评审**：提供了完整输入，五个维度均可评审
```
  </action>
  <verify>
- 文件存在：`ls .claude/data-warehouse/prompts/scenarios/review-existing-model/examples/multiple-issues.md`
- 包含预期结果：`grep "不通过" multiple-issues.md`
- 包含 P0 问题：`grep "P0" multiple-issues.md`
  </verify>
  <done>multiple-issues.md 展示严重缺陷模型的评审过程，结论为"不通过"（P0 门禁触发）</done>
</task>

</tasks>

<verification>
1. 案例目录存在：`.claude/data-warehouse/prompts/scenarios/review-existing-model/examples/`
2. 三个案例文件均存在且结构完整
3. good-model.md 结论为"通过"，质量分 95+
4. naming-issues.md 结论为"有条件通过"，质量分 60-69
5. multiple-issues.md 结论为"不通过"（P0 > 0）
6. 所有案例均展示完整的两段式交互（输入 -> Stage 1 -> Stage 2 -> 要点）
</verification>

<success_criteria>
- [ ] 创建案例目录 examples/
- [ ] good-model.md 展示高质量模型评审，结论"通过"
- [ ] naming-issues.md 展示命名问题评审，结论"有条件通过"
- [ ] multiple-issues.md 展示严重缺陷评审，结论"不通过"
- [ ] 每个案例包含完整结构：输入 -> Stage 1 -> Stage 2 -> 要点
- [ ] 案例覆盖评审范围的三种情况：完整、部分、完整
- [ ] 案例的评审结果与 review-checklist.md 规则一致
</success_criteria>

<output>
After completion, create `.planning/phases/05-review-existing-model/05-03-SUMMARY.md`
</output>
