---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .claude/data-warehouse/docs/naming.md
  - .claude/data-warehouse/docs/prompting.md
  - .claude/data-warehouse/docs/token-budget.md
autonomous: true

must_haves:
  truths:
    - "命名规范文档清晰定义表名、字段名、文件名的命名规则"
    - "命名规范包含 20+ 正例/反例，便于理解和执行"
    - "提示规范文档定义 <2000 token 单文件限制和 YAML frontmatter 格式"
    - "Token 预算文档采用保守估算原则（1 token ≈ 1 中文字符）"
  artifacts:
    - path: ".claude/data-warehouse/docs/naming.md"
      provides: "数据仓库命名规范"
      min_lines: 100
      contains: "表名规范"
    - path: ".claude/data-warehouse/docs/prompting.md"
      provides: "提示工程规范"
      min_lines: 80
      contains: "token"
    - path: ".claude/data-warehouse/docs/token-budget.md"
      provides: "Token 预算配置"
      min_lines: 30
      contains: "2000"
  key_links:
    - from: "docs/naming.md"
      to: "所有提示生成的 DDL 和 SQL"
      via: "命名规则引用"
      pattern: "dwd_|dws_|ads_|dim_"
      note: "ROADMAP 路径 governance/naming-conventions.md 为初始设想，RESEARCH.md 推荐 docs/（人类可读文档集中管理）"
    - from: "docs/prompting.md"
      to: "prompts/**/*.md"
      via: "frontmatter 规范"
      pattern: "type:.*prompt"
---

<objective>
编写命名规范和提示规范文档，建立数据仓库对象命名标准和 AI 提示工程规范。

Purpose: 确保所有后续 Phase 生成的代码和提示遵循统一的命名约定和 token 限制，避免 Mega-Prompt 反模式。
Output: 命名规范文档（20+ 实例）+ 提示规范文档 + Token 预算配置
</objective>

<execution_context>
@./.claude/hivemind/workflows/execute-plan.md
@./.claude/hivemind/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 编写命名规范文档</name>
  <files>
    .claude/data-warehouse/docs/naming.md
  </files>
  <action>
创建 `docs/naming.md`，定义数据仓库对象的命名规范。

**文件结构：**

```markdown
---
type: context
title: 数据仓库命名规范
status: active
version: 1.0.0
domain: global
owner: data-platform
updated_at: 2026-01-30
---

# 数据仓库命名规范

> 本文档定义 HiveMind 数仓系统中所有数据库对象、文件和标识符的命名规则。

## 通用原则

1. **全小写** - 所有名称使用小写字母（Hive 大小写不敏感）
2. **下划线分隔** - 使用 `_` 连接多词，不用驼峰
3. **英文命名** - 表名、字段名使用英文，注释用中文
4. **避免保留字** - 不使用 SQL/Hive 保留字作为名称
5. **语义清晰** - 名称应自解释，避免过度缩写

---

## 1. Schema/数据库命名

（规则 + 正反例...）

## 2. 表名命名规范

### 2.1 分层前缀（必须）
...

### 2.2 表类型标识（可选）
...

### 2.3 完整命名模式
...

## 3. 字段命名规范
...

## 4. 标准字段规范
...

## 5. 文件/目录命名规范
...

## 6. 命名检查清单
...
```

**必须覆盖的规范内容：**

**1. Schema/数据库命名：**
- 格式：`{layer}_db` 或直接使用分层名（如 `ods`, `dwd`, `dws`, `ads`, `dim`）
- 正例：`dwd_db`, `dim_db`, `ads_db`
- 反例：`DWD_DB`（大写）, `data-warehouse`（连字符）

**2. 表名命名规范（核心）：**

**分层前缀（必须）：**
| 前缀 | 含义 | 示例 |
|------|------|------|
| `ods_` | 操作数据层/贴源层 | `ods_mysql_orders` |
| `dwd_` | 明细数据层 | `dwd_fact_order_detail` |
| `dws_` | 汇总数据层 | `dws_order_daily` |
| `ads_` | 应用数据层 | `ads_gmv_report` |
| `dim_` | 维度表 | `dim_customer` |
| `stg_` | 临时/暂存表 | `stg_orders_cleaned` |
| `tmp_` | 临时表（会被删除） | `tmp_order_calc` |

**表类型标识（可选，跟在分层前缀后）：**
| 标识 | 含义 | 示例 |
|------|------|------|
| `fact_` | 事实表 | `dwd_fact_orders` |
| `bridge_` | 桥接表 | `dwd_bridge_order_product` |
| `agg_` | 聚合表 | `dws_agg_order_monthly` |

**完整命名模式：**
`{layer}_{type?}_{domain}_{entity}_{suffix?}`

- `layer`: 分层前缀（必须）
- `type`: 表类型（可选，事实表/桥接表等）
- `domain`: 业务域（如 order, customer, product）
- `entity`: 实体名（如 orders, details, daily）
- `suffix`: 存储策略后缀（可选，如 `_di` 增量, `_df` 全量）

**正例（20+ 个）：**
```
dwd_fact_order_detail      -- DWD 层订单明细事实表
dwd_fact_payment           -- DWD 层支付事实表
dim_customer               -- 客户维度表
dim_product                -- 产品维度表
dim_date                   -- 日期维度表
dws_order_daily            -- DWS 层订单日汇总
dws_user_behavior_weekly   -- DWS 层用户行为周汇总
ads_gmv_report             -- ADS 层 GMV 报表
ads_user_retention         -- ADS 层用户留存报表
ods_mysql_orders           -- ODS 层 MySQL 订单原始数据
ods_kafka_user_event       -- ODS 层 Kafka 用户事件
stg_orders_cleaned         -- 暂存层清洗后订单
dwd_bridge_order_product   -- 订单-产品桥接表
dws_agg_sales_monthly      -- 月度销售聚合表
```

**反例：**
```
fact_orders           -- 缺少分层前缀 ✗
DWD_FACT_ORDERS       -- 大写 ✗
dwd-fact-orders       -- 使用连字符 ✗
dwd_fact_ord_dtl      -- 过度缩写 ✗
orders_dwd_fact       -- 前缀顺序错误 ✗
```

**3. 字段命名规范：**
- 格式：全小写 + 下划线分隔
- 主键：`{entity}_id`（如 `order_id`, `customer_id`）
- 外键：`{referenced_entity}_id`（如 `customer_id`）
- 日期：`{action}_date` 或 `{action}_time`（如 `order_date`, `create_time`）
- 金额：`{desc}_amt` 或 `{desc}_amount`（如 `order_amt`, `payment_amount`）
- 数量：`{desc}_cnt` 或 `{desc}_count`（如 `order_cnt`, `item_count`）
- 标志：`is_{desc}` 或 `has_{desc}`（如 `is_deleted`, `has_refund`）
- 比率：`{desc}_rate` 或 `{desc}_ratio`（如 `refund_rate`）

**4. 标准字段规范（事实表/维度表必须包含）：**
| 字段名 | 类型 | 含义 | 适用表类型 |
|--------|------|------|-----------|
| `dw_create_time` | TIMESTAMP | 数据创建时间 | 所有表 |
| `dw_modify_time` | TIMESTAMP | 数据最后修改时间 | 所有表 |
| `etl_date` | DATE | ETL 处理日期 | 所有表 |
| `is_deleted` | TINYINT | 逻辑删除标识 (0/1) | 事实表 |
| `dw_valid_from` | DATE | SCD Type 2 有效起始日期 | 维度表 |
| `dw_valid_to` | DATE | SCD Type 2 有效截止日期 | 维度表 |
| `is_current` | TINYINT | 是否当前有效版本 (0/1) | 维度表 |

**5. 文件/目录命名规范：**
- 目录名：kebab-case（如 `data-warehouse/`, `design-new-model/`）
- 文档文件名：kebab-case（如 `naming.md`, `zh-en-terms.md`）
- 模型文件名：snake_case，与表名一致（如 `dwd_fact_orders.sql`）

**6. 命名检查清单（10+ 项）：**
提供可执行的检查项，用于评审模型命名合规性。
  </action>
  <verify>
验证命令：
```bash
# 检查文件存在
test -f .claude/data-warehouse/docs/naming.md && echo "naming.md exists"

# 检查包含 YAML frontmatter
head -10 .claude/data-warehouse/docs/naming.md | grep -c "^---"

# 检查核心内容覆盖
grep -c "表名" .claude/data-warehouse/docs/naming.md
grep -c "字段" .claude/data-warehouse/docs/naming.md
grep -c "正例" .claude/data-warehouse/docs/naming.md
grep -c "反例" .claude/data-warehouse/docs/naming.md

# 检查正例数量（目标 20+）
grep -E "^dwd_|^dws_|^ads_|^dim_|^ods_|^stg_" .claude/data-warehouse/docs/naming.md | wc -l
```
  </verify>
  <done>
- naming.md 文件创建成功
- 包含 YAML frontmatter（type: context, status: active）
- 覆盖 Schema、表名、字段名、标准字段、文件命名 5 大类
- 包含 20+ 正例和对应的反例
- 包含命名检查清单
  </done>
</task>

<task type="auto">
  <name>Task 2: 编写提示规范和 Token 预算文档</name>
  <files>
    .claude/data-warehouse/docs/prompting.md
    .claude/data-warehouse/docs/token-budget.md
  </files>
  <action>
**Part A: 创建 `docs/prompting.md` - 提示工程规范**

```markdown
---
type: context
title: 提示工程规范
status: active
version: 1.0.0
domain: global
owner: data-platform
updated_at: 2026-01-30
---

# 提示工程规范

> 本文档定义 HiveMind 数仓助手的提示文件编写规范，确保可维护性和 Claude 兼容性。

## 核心原则

1. **模块化设计** - 避免 Mega-Prompt，单文件 < 2000 tokens
2. **可组合架构** - 提示 + 上下文分离，运行时按需组装
3. **人类可读** - 使用 Markdown 格式，便于版本控制和协作
4. **版本可追溯** - 所有文件必须包含版本标记

---

## 1. 文件类型定义

| 类型 | 目录 | 用途 | 示例 |
|------|------|------|------|
| `prompt` | prompts/ | 场景提示，包含指令和输出格式 | scenarios/design-new-model.md |
| `context` | context/ | 知识库，被提示引用 | methodology/kimball.md |
| `glossary` | glossary/ | 术语定义，跨文档共享 | terms.md |
| `docs` | docs/ | 规范文档，供人类阅读 | naming.md |

---

## 2. YAML Frontmatter 规范

所有 `prompts/**/*.md` 和 `context/**/*.md` 必须包含 frontmatter。

### 2.1 最小必填字段（Phase 1）

\`\`\`yaml
---
type: prompt              # prompt | context
title: <标题>
status: active            # draft | active | deprecated
version: 1.0.0            # 语义化版本
domain: <domain>          # global 或具体领域名
owner: <负责人或团队>
updated_at: YYYY-MM-DD
includes:                 # 可选，引用的上下文文件
  - context/global/sql-style
  - context/domains/sales
---
\`\`\`

### 2.2 id 推导规则

- `id` 字段可省略；缺省时按路径推导为默认 ID
- 推导规则：`id = <仓库相对路径去掉扩展名>`
- 示例：`prompts/scenarios/order-refund.md` → `prompts/scenarios/order-refund`

### 2.3 deprecated 处理

当 `status=deprecated` 时，应添加：
\`\`\`yaml
deprecated_to: <目标路径ID>
\`\`\`

---

## 3. Token 限制规范

### 3.1 单文件上限

| 类型 | 上限 | 说明 |
|------|------|------|
| prompt 文件 | < 2000 tokens | 可维护性红线 |
| context 文件 | < 2000 tokens | 超过必须拆分 |
| 单个 example 块 | < 400 tokens | few-shot 单块建议 |

### 3.2 估算规则

**保守估算原则：** 1 token ≈ 1 中文字符

| 场景 | 估算 |
|------|------|
| 中文内容 | 1 token ≈ 1-2 中文字符（保守取 1:1） |
| 英文内容 | 4 字符 ≈ 1 token |
| 代码/标点 | 波动较大，按字符数估算 |

**重要：** 任何上线内容以实际 tokenizer 统计为准（Phase 8 工具提供检查）。

### 3.3 超限处理

当文件超过 2000 tokens：
1. 拆分为多个聚焦文件
2. 使用 `includes` 引用关系
3. 保持单个文件职责单一

---

## 4. 提示结构模板

### 4.1 场景提示模板

\`\`\`markdown
---
type: prompt
title: <场景名称>
status: active
version: 1.0.0
domain: <业务域>
owner: data-platform
updated_at: YYYY-MM-DD
includes:
  - context/methodology/kimball
  - context/platform/hive-constraints
---

# <场景名称>

<context>
你是一位 [角色描述]，专注于 [领域]...
</context>

<instructions>
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]
</instructions>

<output_format>
## [输出部分 1]
[格式说明]

## [输出部分 2]
[格式说明]
</output_format>

<examples>
### 示例 1: [场景]
**输入：** ...
**输出：** ...
</examples>
\`\`\`

### 4.2 上下文文件模板

\`\`\`markdown
---
type: context
title: <知识主题>
status: active
version: 1.0.0
domain: <领域>
owner: data-platform
updated_at: YYYY-MM-DD
---

# <知识主题>

## 概述
[简要介绍]

## 核心概念
[详细内容]

## 示例
[代码或场景示例]

## 注意事项
[约束和陷阱]
\`\`\`

---

## 5. XML 标签使用规范

遵循 Claude 官方最佳实践，使用 XML 标签分隔提示的不同部分：

| 标签 | 用途 | 示例 |
|------|------|------|
| `<context>` | 角色定义和背景 | 系统角色描述 |
| `<instructions>` | 执行步骤 | 有序的操作指令 |
| `<output_format>` | 输出格式要求 | Markdown 结构模板 |
| `<examples>` | Few-shot 示例 | 输入输出对 |
| `<constraints>` | 约束条件 | 不允许的操作 |

---

## 6. 版本管理规则

### 6.1 版本号格式

使用语义化版本：`MAJOR.MINOR.PATCH`

- MAJOR: 不兼容的重大变更
- MINOR: 向后兼容的功能新增
- PATCH: 向后兼容的问题修复

### 6.2 变更记录

每次修改时更新：
- `version` 字段
- `updated_at` 字段
- 文件末尾可选添加 CHANGELOG 部分

---

## 7. 检查清单

编写或修改提示文件时，确认以下事项：

- [ ] 包含完整的 YAML frontmatter
- [ ] type 正确设置（prompt/context）
- [ ] status 设置为 draft 或 active
- [ ] 文件大小 < 2000 tokens（保守估算 < 2000 中文字符）
- [ ] 使用正确的 XML 标签结构
- [ ] 示例清晰且可复现
- [ ] 无硬编码的敏感信息
```

**Part B: 创建 `docs/token-budget.md` - Token 预算配置**

```markdown
---
type: context
title: Token 预算配置
status: active
version: 1.0.0
domain: global
owner: data-platform
updated_at: 2026-01-30
---

# Token Budget Profile: default

本文档定义 HiveMind 数仓助手的 Token 预算配置，用于控制提示组装和运行时上下文。

## 1. 模型上下文预算

| item | tokens | 说明 |
|------|-------:|------|
| model_context_window | 200000 | Claude 模型上下文上限 |
| reserve_system | 2000 | 系统提示/框架提示预留 |
| reserve_tools | 1000 | 工具定义预留（如有） |
| reserve_history | 10000 | 对话历史预留（如多轮） |
| reserve_output | 4000 | 期望最大输出预留 |
| reserve_safety_buffer | 20000 | 安全缓冲（~10%） |
| **available_for_inputs** | **163000** | = context_window - 上述所有 reserve |

## 2. 单文件治理上限（File Caps）

| file_type | cap_tokens | 备注 |
|-----------|----------:|------|
| prompt_file | 2000 | 可维护性上限，强制 |
| context_file | 2000 | 超过必须拆分 |
| example_block | 400 | few-shot 单块建议上限 |
| glossary_section | 500 | 术语表单个分组建议 |

## 3. 组装预算（Phase 8 工具使用）

| scenario | max_assembled_tokens | 组成 |
|----------|--------------------:|------|
| design-new-model | 4000 | system + methodology + platform + prompt |
| review-existing-model | 4000 | system + methodology + governance + prompt |
| generate-sql | 3500 | system + platform + prompt |
| define-metrics | 3000 | system + metrics-context + prompt |
| generate-dq-rules | 3000 | system + dq-context + prompt |
| analyze-lineage | 3500 | system + lineage-context + prompt |

## 4. Token 估算规则

### 4.1 保守估算原则

**中文内容：** 1 token ≈ 1 中文字符（保守）

实际范围：1 token ≈ 1-2 中文字符，但为确保不超限，统一按 1:1 估算。

**英文内容：** 4 字符 ≈ 1 token

### 4.2 经验范围（仅参考）

| 场景 | 估算 | 说明 |
|------|------|------|
| 纯中文 2000 tokens | ~2000-4000 字符 | 保守取下限 |
| 混合中英文 | 按字符数估算 | 代码按英文规则 |
| 含代码块 | 代码行 × 10 tokens/行 | 粗略估算 |

### 4.3 验证方法

Phase 8 将提供精确 token 统计工具：
```bash
# 预期用法（Phase 8 实现）
npm run gsd -- /gsd:count-tokens --file prompts/scenarios/design-new-model.md
```

## 5. 超限处理策略

当文件或组装结果超过预算：

1. **拆分文件** - 按职责拆分为多个小文件
2. **精简示例** - 减少 few-shot 示例数量
3. **分级加载** - context-level: minimal/standard/full
4. **延迟加载** - 仅在需要时加载特定上下文

## 6. 监控指标（Phase 8 实现）

| 指标 | 阈值 | 动作 |
|------|------|------|
| 单文件 > 1800 tokens | 警告 | 提示接近上限 |
| 单文件 > 2000 tokens | 错误 | 阻止提交 |
| 组装结果 > 3600 tokens | 警告 | 建议精简 |
| 组装结果 > 4000 tokens | 错误 | 必须精简 |
```
  </action>
  <verify>
验证命令：
```bash
# 检查文件存在
test -f .claude/data-warehouse/docs/prompting.md && echo "prompting.md exists"
test -f .claude/data-warehouse/docs/token-budget.md && echo "token-budget.md exists"

# 检查 prompting.md 核心内容
grep -c "2000" .claude/data-warehouse/docs/prompting.md  # token 限制
grep -c "frontmatter" .claude/data-warehouse/docs/prompting.md
grep -c "XML" .claude/data-warehouse/docs/prompting.md

# 检查 token-budget.md 核心内容
grep -c "2000" .claude/data-warehouse/docs/token-budget.md
grep -c "保守" .claude/data-warehouse/docs/token-budget.md
grep "available_for_inputs" .claude/data-warehouse/docs/token-budget.md
```
  </verify>
  <done>
- prompting.md 创建成功，定义提示文件规范
- token-budget.md 创建成功，定义 Token 预算配置
- 单文件 < 2000 tokens 限制已明确
- 保守估算原则（1 token ≈ 1 中文字符）已记录
- YAML frontmatter 格式已定义
- 提示结构模板已提供
  </done>
</task>

</tasks>

<verification>
整体验证：

1. **文件完整性：**
   ```bash
   ls -la .claude/data-warehouse/docs/
   # 应包含：naming.md, prompting.md, token-budget.md
   ```

2. **内容验证：**
   ```bash
   # 命名规范正例数量
   grep -E "^dwd_|^dws_|^ads_|^dim_|^ods_" .claude/data-warehouse/docs/naming.md | wc -l
   # 应 >= 20

   # Token 限制提及次数
   grep -c "2000" .claude/data-warehouse/docs/prompting.md
   # 应 >= 3
   ```

3. **格式验证：**
   - 所有文件包含 YAML frontmatter
   - 使用正确的 Markdown 格式
</verification>

<success_criteria>
1. naming.md 包含完整的命名规范（表名、字段名、文件名）
2. naming.md 包含 20+ 正例和对应反例
3. prompting.md 定义 < 2000 token 单文件限制
4. prompting.md 包含 YAML frontmatter 规范和提示模板
5. token-budget.md 定义预算配置和保守估算原则
6. 所有文件包含正确的 YAML frontmatter
</success_criteria>

<output>
完成后创建 `.planning/phases/01-infrastructure/01-02-SUMMARY.md`
</output>
