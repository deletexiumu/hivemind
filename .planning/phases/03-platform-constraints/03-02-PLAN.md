---
phase: 03-platform-constraints
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/context/platform/dbt-hive-limitations.md
  - .claude/data-warehouse/context/platform/incremental-strategies.md
  - .claude/data-warehouse/context/platform/index.md
autonomous: true

must_haves:
  truths:
    - "用户能快速识别 dbt-hive 不支持的功能（Snapshots/Ephemeral）"
    - "每个 dbt-hive 限制有明确的替代方案"
    - "用户能理解 T+1 + lookback 回刷模式的完整流程"
    - "增量策略文档包含可直接复用的 dbt 模型代码"
  artifacts:
    - path: ".claude/data-warehouse/context/platform/dbt-hive-limitations.md"
      provides: "dbt-hive 能力边界文档"
      contains: "不支持 Snapshots|不支持 Ephemeral|分区列.*末尾"
    - path: ".claude/data-warehouse/context/platform/incremental-strategies.md"
      provides: "增量策略文档"
      contains: "insert_overwrite|lookback|T\\+1"
  key_links:
    - from: ".claude/data-warehouse/context/platform/dbt-hive-limitations.md"
      to: "incremental-strategies.md"
      via: "替代方案链接"
      pattern: "\\[.*\\]\\(.*incremental-strategies\\.md\\)"
    - from: ".claude/data-warehouse/context/platform/incremental-strategies.md"
      to: "../methodology/scd-strategies.md"
      via: "SCD 策略引用"
      pattern: "scd-strategies\\.md"
---

<objective>
创建 dbt-hive 能力边界文档（PLATFORM-02）和增量策略文档（PLATFORM-03），完成平台约束库的核心内容。

Purpose: 明确 dbt-hive 适配器的功能限制及规避方案，建立 T+1 离线数仓的标准增量模式。

Output:
- `context/platform/dbt-hive-limitations.md` - dbt-hive 能力边界与替代方案
- `context/platform/incremental-strategies.md` - T+1 增量策略与 lookback 模式
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md (Phase 3 section)
@.planning/STATE.md
@.planning/phases/03-platform-constraints/03-RESEARCH.md
@.planning/phases/03-platform-constraints/03-CONTEXT.md
@.claude/data-warehouse/context/platform/index.md (已创建的索引页)
@.claude/data-warehouse/context/platform/hive-constraints.md (Plan 01 创建的约束文档)
@.claude/data-warehouse/context/methodology/scd-strategies.md (SCD 策略文档)
@.claude/data-warehouse/docs/prompting.md (文档规范)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 编写 dbt-hive 能力边界文档 (PLATFORM-02)</name>
  <files>
    .claude/data-warehouse/context/platform/dbt-hive-limitations.md
  </files>
  <action>
编写 dbt-hive 能力边界文档，重点说明功能限制和替代方案。

**文档结构：**

1. **Frontmatter:**
   - type: context
   - title: dbt-hive 能力边界
   - status: stable
   - domain: platform/dbt-hive
   - version: 1.0.0

2. **TL;DR:**
   - dbt-hive 不支持 Snapshots、Ephemeral
   - 分区列必须在 SELECT 末尾
   - 非 ACID 表只能用 insert_overwrite 策略
   - 核心观点：接受限制，用分区回刷模式替代行级操作

3. **版本兼容性矩阵（来自 RESEARCH）：**
   | dbt-hive | dbt-core | Python | 备注 |
   | 1.10.x | 1.10.x | >= 3.9 | 当前版本 |
   | 1.7.x | 1.7.x | >= 3.8 | 稳定版本 |

4. **支持的物化策略：**
   | 物化类型 | 支持状态 | 说明 |
   | table | ✓ | 全量重建 |
   | view | ✓ | 视图 |
   | incremental | ✓ | 仅 insert_overwrite 和 append |
   | snapshot | ✗ | 不支持，用增量模型替代 |
   | ephemeral | ✗ | 不支持，用 view 替代 |

5. **功能限制详解（使用统一模板）：**

   ### [P0] DBT-HIVE-001: 不支持 Snapshots
   **约束 ID:** DBT-HIVE-001
   **原因:** dbt-hive 适配器未实现 snapshot 物化类型
   **违反后果:** dbt 执行报错，模型无法创建
   **规避方案:**
   1. 使用自定义增量模型实现 SCD Type 2
   2. 参考 [SCD 策略文档](../methodology/scd-strategies.md)
   **链接:** [增量策略](./incremental-strategies.md)

   ### [P0] DBT-HIVE-002: 不支持 Ephemeral
   **约束 ID:** DBT-HIVE-002
   **原因:** dbt-hive 不支持 CTE 内联机制
   **违反后果:** dbt 执行报错
   **规避方案:**
   1. 使用 View 物化替代
   2. 将逻辑拆分为独立模型

   ### [P0] DBT-HIVE-003: 分区列必须在 SELECT 末尾
   **约束 ID:** DBT-HIVE-003
   **原因:** Hive 动态分区语法要求
   **违反后果:** Hive 报错 "partition column must be last"
   **规避方案:** 调整 SELECT 列顺序，分区列放末尾
   **示例:** 正/反代码对比

   ### [P0] DBT-HIVE-004: insert_overwrite 必须配合 partition_by
   **约束 ID:** DBT-HIVE-004
   **原因:** 否则会覆盖全表
   **违反后果:** 历史数据丢失
   **规避方案:** 始终配置 partition_by 参数
   **示例:** dbt config 正确配置

   ### [P0] DBT-HIVE-005: 非 ACID 表不支持 merge 策略
   **约束 ID:** DBT-HIVE-005
   **原因:** MERGE 语句需要 ACID 事务表
   **违反后果:** 执行失败
   **规避方案:** 使用 insert_overwrite 分区回刷

6. **dbt 模型配置最佳实践：**
   完整的 dbt config 示例（来自 RESEARCH Example 1）

7. **已知 Quirks 与规避：**
   - Kerberos 仅支持 Unix
   - 某些 Hive 函数需要特殊处理

8. **参考文献:**
   - dbt-hive Official Documentation
   - dbt-hive GitHub Repository
   - Cloudera Hive Setup

**Token 预算：** < 1500
  </action>
  <verify>
文档包含：
- 版本兼容性矩阵
- 支持的物化策略表格
- >=5 个编号限制（DBT-HIVE-001 ~ 005）
- 每个限制有替代方案
- P0 限制有代码示例
  </verify>
  <done>dbt-hive 限制文档完整，每个限制有明确替代方案</done>
</task>

<task type="auto">
  <name>Task 2: 编写增量策略文档 (PLATFORM-03)</name>
  <files>
    .claude/data-warehouse/context/platform/incremental-strategies.md
  </files>
  <action>
编写增量策略文档，重点说明 T+1 回刷模式和 lookback 机制。

**文档结构：**

1. **Frontmatter:**
   - type: context
   - title: 增量策略
   - status: stable
   - domain: platform/incremental
   - version: 1.0.0

2. **TL;DR:**
   - 离线数仓使用 T+1 增量模式
   - 核心策略：insert_overwrite 分区回刷
   - 默认 lookback 7 天覆盖迟到数据
   - 核心观点：分区幂等 + 窗口回刷 = 数据最终一致

3. **T+1 离线数仓模式原理：**
   - 什么是 T+1（昨日数据今日可用）
   - 数据流转时间线图（Mermaid）
   - 调度时间点说明（08:00 开始 ODS 同步）

4. **增量策略对比矩阵：**
   | 策略 | 适用场景 | 优点 | 缺点 | 推荐度 |
   | insert_overwrite | 分区回刷 | 幂等、简单 | 全分区重算 | ★★★★★ |
   | append | 纯追加 | 性能高 | 不支持更新 | ★★☆☆☆ |
   | merge (ACID) | 行级更新 | 精确 | 需要 ACID | ★★★☆☆ |

5. **insert_overwrite 分区回刷机制：**
   - 原理说明（覆盖指定分区，其他分区不变）
   - 幂等性保证（重跑不会产生重复数据）
   - 分区键选择原则（日期列、低基数）

6. **lookback 回刷模式（核心章节）：**

   ### 为什么需要 lookback
   - 迟到数据（Late Arriving Data）问题
   - 数据修正场景

   ### lookback 配置
   | 层级 | 默认 lookback | 原因 |
   | ODS | 7 天 | 源系统同步延迟 |
   | DWD-DWS | 30 天 | 业务修正窗口 |
   | ADS | 90 天 | 报表重算需求 |

   ### dbt 模型示例（来自 RESEARCH Codex Review）
   完整的 dbt 增量模型代码：
   ```sql
   {{ config(
       materialized='incremental',
       incremental_strategy='insert_overwrite',
       partition_by=['dt'],
       file_format='orc'
   ) }}

   SELECT
       order_id,
       user_id,
       order_amount,
       updated_at,
       dt
   FROM {{ source('ods', 'orders') }}
   WHERE dt >= date_sub('{{ var("ds") }}', {{ var("lookback_days", 7) }})
     AND dt <= '{{ var("ds") }}'
     AND dt IS NOT NULL
     AND dt RLIKE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'
   ```

   ### 运行命令示例
   ```bash
   dbt run --select dwd_fact_orders --vars '{"ds":"2026-01-31","lookback_days":7}'
   ```

7. **分区内去重模式：**
   - 为什么需要去重（同一业务键多版本）
   - row_number 去重示例（取最新版本）
   - dbt test 唯一性检测

8. **全量重跑 vs 增量跑决策矩阵：**
   | 场景 | 选择 | 原因 |
   | 日常调度 | 增量（lookback N天）| 效率 |
   | Schema 变更 | 全量重跑 | 结构一致性 |
   | 历史数据修正 | 扩大 lookback | 覆盖修正范围 |
   | 初始化 | 全量 | 无历史数据 |

9. **故障重试与数据一致性：**
   - 幂等性保证重试安全
   - 分区锁防止并发冲突
   - DQ 检测确认数据完整

10. **与 SCD 策略的关系：**
    - 增量策略用于事实表
    - SCD 策略用于维度表
    - 链接到 [SCD 策略文档](../methodology/scd-strategies.md)

11. **参考文献:**
    - dbt Incremental Models
    - Hive INSERT OVERWRITE

**Token 预算：** < 1800
  </action>
  <verify>
文档包含：
- T+1 模式原理说明
- 增量策略对比矩阵
- lookback 配置表（ODS/DWD-DWS/ADS）
- 完整的 dbt 增量模型代码示例
- 运行命令示例
- 全量/增量决策矩阵
  </verify>
  <done>增量策略文档完整，包含 T+1 + lookback 模式的完整实现</done>
</task>

<task type="auto">
  <name>Task 3: 更新索引页完成 Phase 03</name>
  <files>
    .claude/data-warehouse/context/platform/index.md
  </files>
  <action>
更新索引页完成 Phase 03：

1. 将所有文档状态从 `planned` 改为 `stable`
   - hive-constraints.md: stable（Plan 01 已完成）
   - dbt-hive-limitations.md: stable
   - incremental-strategies.md: stable

2. 将索引页自身状态从 `draft` 改为 `stable`

3. 确认约束速查表完整：
   - 包含所有 HIVE-xxx 约束
   - 包含所有 DBT-HIVE-xxx 约束
   - 确认 P0 约束高亮/置顶

4. 验证所有文档链接正确可访问
  </action>
  <verify>
- 索引页 status: stable
- 所有文档状态为 stable
- 约束速查表包含所有 P0 约束
  </verify>
  <done>Phase 03 平台约束库完成，所有文档状态为 stable</done>
</task>

</tasks>

<verification>
Phase 03 Plan 02 完成标准：

1. **dbt-hive 文档：** dbt-hive-limitations.md 覆盖 PLATFORM-02
2. **增量策略文档：** incremental-strategies.md 覆盖 PLATFORM-03
3. **限制数量：** >=5 个编号限制（DBT-HIVE-001 ~ 005）
4. **替代方案：** 每个限制有明确替代方案
5. **代码示例：** 完整的 dbt 增量模型代码
6. **lookback 配置：** 包含 ODS/DWD-DWS/ADS 三层配置
7. **索引页更新：** 所有文档状态为 stable
8. **Token 预算：** dbt-hive <1500, 增量策略 <1800
</verification>

<success_criteria>
- [ ] context/platform/dbt-hive-limitations.md 存在且覆盖 PLATFORM-02
- [ ] context/platform/incremental-strategies.md 存在且覆盖 PLATFORM-03
- [ ] 每个 dbt-hive 限制有替代方案
- [ ] 增量策略包含完整的 dbt 模型代码
- [ ] lookback 模式有 ODS/DWD-DWS/ADS 配置
- [ ] 索引页所有文档状态为 stable
- [ ] 文档符合 token 预算限制
</success_criteria>

<output>
完成后创建 `.planning/phases/03-platform-constraints/03-02-SUMMARY.md`
</output>
