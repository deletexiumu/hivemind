---
phase: 04-design-new-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/context/methodology/dimensional-modeling-core.md
  - .claude/data-warehouse/context/methodology/fact-table-types-core.md
  - .claude/data-warehouse/context/methodology/scd-strategies-core.md
  - .claude/data-warehouse/context/layers/layering-system-core.md
  - .claude/data-warehouse/context/platform/hive-constraints-core.md
  - .claude/data-warehouse/context/platform/dbt-hive-limitations-core.md
  - .claude/data-warehouse/docs/naming-core.md
autonomous: true

must_haves:
  truths:
    - "场景提示可以引用精简版上下文文件实现运行时注入"
    - "精简版文件包含可执行规则和决策树，无冗长解释"
    - "每个 *-core 文件控制在 1k-2k tokens 以内"
  artifacts:
    - path: ".claude/data-warehouse/context/methodology/dimensional-modeling-core.md"
      provides: "Kimball 四步法、星型设计要点"
      contains: "grain"
    - path: ".claude/data-warehouse/context/methodology/fact-table-types-core.md"
      provides: "事实表类型决策树、可加性规则"
      contains: "decision"
    - path: ".claude/data-warehouse/context/methodology/scd-strategies-core.md"
      provides: "SCD 选型决策树、FK→SK 规则"
      contains: "Type 2"
    - path: ".claude/data-warehouse/context/layers/layering-system-core.md"
      provides: "分层落点决策规则"
      contains: "DWD"
    - path: ".claude/data-warehouse/context/platform/hive-constraints-core.md"
      provides: "Hive P0 约束速查"
      contains: "HIVE-"
    - path: ".claude/data-warehouse/context/platform/dbt-hive-limitations-core.md"
      provides: "dbt-hive 边界与替代方案"
      contains: "DBT-HIVE-"
    - path: ".claude/data-warehouse/docs/naming-core.md"
      provides: "命名/标准字段/键命名约定精简版"
      contains: "is_deleted"
  key_links:
    - from: "*-core.md files"
      to: "原始长文档"
      via: "Source 标注"
      pattern: "Source:.*\\.md"
---

<objective>
创建 7 个 `*-core` 精简版上下文文件，为 Phase 4 场景提示提供运行时可注入的知识库。

Purpose: 原始方法论/平台约束文档篇幅较长（单文件 3k-8k tokens），直接注入会超出场景组装预算。精简版仅保留"可执行规则/决策树/检查项"，单文件控制在 1k-2k tokens。

Output: 7 个 `*-core.md` 文件，供 Plan 02 的 prompt.md 通过 `includes` 引用
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-design-new-model/04-RESEARCH.md
@.claude/data-warehouse/context/methodology/dimensional-modeling.md
@.claude/data-warehouse/context/methodology/fact-table-types.md
@.claude/data-warehouse/context/methodology/scd-strategies.md
@.claude/data-warehouse/context/layers/layering-system.md
@.claude/data-warehouse/context/platform/hive-constraints.md
@.claude/data-warehouse/context/platform/dbt-hive-limitations.md
@.claude/data-warehouse/docs/naming.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建方法论精简版上下文（3 个文件）</name>
  <files>
    .claude/data-warehouse/context/methodology/dimensional-modeling-core.md
    .claude/data-warehouse/context/methodology/fact-table-types-core.md
    .claude/data-warehouse/context/methodology/scd-strategies-core.md
  </files>
  <action>
    从原始文档提取可执行规则，创建精简版：

    **dimensional-modeling-core.md** (~800-1000 tokens):
    - Kimball 四步设计法（业务过程→粒度→维度→事实）
    - 星型模型优于雪花（Hive 场景）
    - 粒度声明模板（何时、何物、何值）
    - 一致性维度要点
    - 退化维度判断规则
    - 来源标注：`Source: dimensional-modeling.md | Updated: {date}`

    **fact-table-types-core.md** (~600-800 tokens):
    - 事实表类型决策树（Mermaid flowchart）
    - 可加性规则表（完全可加/半可加/不可加 + 典型字段）
    - 类型选择矩阵（业务事件/定期状态/流程追踪 → 类型）
    - 来源标注

    **scd-strategies-core.md** (~800-1000 tokens):
    - SCD 选型决策树（Mermaid flowchart）
    - Type 1/2/3 快速对比表
    - 键策略规则：事实表 FK 使用 `*_key` 指向维度 `*_sk`
    - 迟到维处理：Unknown 成员占位 (sk=-1)
    - dbt-hive 实现要点（insert_overwrite + 有效期字段）
    - 来源标注

    格式要求：
    - 使用表格、决策树、检查清单
    - 不写长篇解释段落
    - 每个文件开头添加 frontmatter：type: context-core, source: {原文件路径}
  </action>
  <verify>
    统计每个文件 token 数（wc -w 估算：中文 1 token ≈ 1.5 字）：
    - dimensional-modeling-core.md < 1000 tokens
    - fact-table-types-core.md < 800 tokens
    - scd-strategies-core.md < 1000 tokens
  </verify>
  <done>
    3 个方法论精简版文件创建完成，每个文件包含可执行规则和决策树，无冗长解释
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建平台约束精简版上下文（3 个文件）</name>
  <files>
    .claude/data-warehouse/context/layers/layering-system-core.md
    .claude/data-warehouse/context/platform/hive-constraints-core.md
    .claude/data-warehouse/context/platform/dbt-hive-limitations-core.md
  </files>
  <action>
    从原始文档提取可执行规则，创建精简版：

    **layering-system-core.md** (~600-800 tokens):
    - 四层定义速查表（ODS/DWD/DWS/ADS 一行描述）
    - 分层落点决策规则（事实表→DWD，维度表→DWD dim_前缀，汇总→DWS，应用→ADS）
    - 跨层引用规则（允许/禁止矩阵）
    - 维度表跨层引用说明
    - 来源标注

    **hive-constraints-core.md** (~800-1000 tokens):
    - P0 约束速查表（ID + 一句话 + 规避要点）
    - 分区规则要点：dt 在 SELECT 末尾、非空、格式校验
    - 存储格式：ORC + Snappy
    - 动态分区配置模板
    - 禁止 SELECT * 规则
    - 来源标注

    **dbt-hive-limitations-core.md** (~600-800 tokens):
    - 5 个 P0 限制速查表（DBT-HIVE-001~005）
    - 关键替代方案摘要：
      - 无 Snapshots → insert_overwrite + SCD 有效期字段
      - 无 Ephemeral → CTE 或临时表
      - 无 MERGE → insert_overwrite 分区回刷
    - 增量模型标准配置模板
    - 来源标注

    格式要求：同 Task 1
  </action>
  <verify>
    统计每个文件 token 数：
    - layering-system-core.md < 800 tokens
    - hive-constraints-core.md < 1000 tokens
    - dbt-hive-limitations-core.md < 800 tokens
  </verify>
  <done>
    3 个平台约束精简版文件创建完成，每个文件包含 P0 约束速查和替代方案
  </done>
</task>

<task type="auto">
  <name>Task 3: 创建命名规范精简版 + 验证全部文件</name>
  <files>
    .claude/data-warehouse/docs/naming-core.md
  </files>
  <action>
    **naming-core.md** (~600-800 tokens):
    - 分层前缀速查表（ods_/dwd_/dws_/ads_/dim_/stg_）
    - 表类型标识（fact_/bridge_/agg_/snapshot_）
    - 完整命名模式：`{layer}_{type?}_{domain}_{entity}_{suffix?}`
    - 字段类型后缀速查（_id/_date/_time/_amt/_cnt/_rate/_pct/is_/has_）
    - 事实表标准字段清单（is_deleted/data_source/dw_create_time/dw_modify_time/etl_date）
    - 维度表 SCD 标准字段（dw_valid_from/dw_valid_to/is_current）
    - 键命名约定：事实表 FK 用 `*_key`，维度表 SK 用 `*_sk`
    - 来源标注

    **验证步骤：**
    - 检查全部 7 个 *-core.md 文件是否创建成功
    - 验证每个文件包含 frontmatter（type: context-core, source: ...）
    - 验证每个文件包含 Source 标注
    - 统计总 token 数（目标：7 个文件合计 < 6000 tokens）
  </action>
  <verify>
    ```bash
    # 检查文件存在
    ls -la .claude/data-warehouse/context/methodology/*-core.md
    ls -la .claude/data-warehouse/context/layers/*-core.md
    ls -la .claude/data-warehouse/context/platform/*-core.md
    ls -la .claude/data-warehouse/docs/naming-core.md

    # 估算 token 数（wc -w 作为参考）
    wc -w .claude/data-warehouse/**/*-core.md .claude/data-warehouse/docs/naming-core.md
    ```
  </verify>
  <done>
    7 个 *-core.md 精简版上下文文件全部创建完成，合计 token 数 < 6000，可供场景提示引用
  </done>
</task>

</tasks>

<verification>
1. 7 个 *-core.md 文件全部存在
2. 每个文件包含 frontmatter（type: context-core, source: 原文件路径）
3. 每个文件包含 Source 标注（可追溯到原始文档）
4. 单文件 token 数 < 2000（保守估算：字数 ÷ 1.5）
5. 7 个文件合计 token 数 < 6000
6. 内容为可执行规则/决策树/检查清单，无冗长解释段落
</verification>

<success_criteria>
- 7 个精简版上下文文件创建完成
- 每个文件控制在 1k-2k tokens 以内
- 内容可追溯到原始文档
- 格式统一（frontmatter + 表格/决策树/检查清单）
- Plan 02 的 prompt.md 可通过 includes 引用这些文件
</success_criteria>

<output>
After completion, create `.planning/phases/04-design-new-model/04-01-SUMMARY.md`
</output>
