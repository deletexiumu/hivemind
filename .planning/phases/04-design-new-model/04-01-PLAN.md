---
phase: 04-design-new-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ".claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md"
  - ".claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md"
autonomous: true

must_haves:
  truths:
    - "用户可以输入业务事件/粒度描述，获得结构化设计指导"
    - "提示系统能根据输入推荐事实表类型、SCD 策略、分层落点"
    - "输出模板定义了完整的星型模型输出结构"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md"
      provides: "设计新模型场景主提示"
      contains: "INSTRUCTIONS"
      min_lines: 80
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md"
      provides: "标准输出格式模板"
      contains: "Mermaid"
      min_lines: 100
  key_links:
    - from: "prompt.md"
      to: "output-template.md"
      via: "includes 引用"
      pattern: "output-template"
    - from: "prompt.md"
      to: "context/methodology/*.md"
      via: "includes 引用方法论"
      pattern: "includes.*methodology"
---

<objective>
创建"设计新模型"场景的核心提示框架：主提示文件和输出模板文件。

Purpose: 建立场景提示的核心架构，定义输入解析、决策指导、输出格式标准，为后续案例库提供基础。

Output:
- `prompts/scenarios/design-new-model/prompt.md` — 主提示（~1,500 tokens）
- `prompts/scenarios/design-new-model/output-template.md` — 输出模板（~800 tokens）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-design-new-model/04-CONTEXT.md
@.planning/phases/04-design-new-model/04-RESEARCH.md
@.claude/data-warehouse/docs/token-budget.md
@.claude/data-warehouse/docs/naming.md
@.claude/data-warehouse/context/methodology/dimensional-modeling.md
@.claude/data-warehouse/context/methodology/fact-table-types.md
@.claude/data-warehouse/context/methodology/scd-strategies.md
@.claude/data-warehouse/context/layers/layering-system.md
@.claude/data-warehouse/context/platform/hive-constraints.md
@.claude/data-warehouse/context/platform/dbt-hive-limitations.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建主提示文件 prompt.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md</files>
  <action>
创建场景主提示文件，遵循 4-block 结构化提示模式（INSTRUCTIONS / CONTEXT / TASK / OUTPUT FORMAT）。

**文件结构要求：**

1. **Frontmatter（YAML）**
   - type: scenario
   - name: design-new-model
   - includes: 引用已有方法论和平台约束文档
     - context/methodology/dimensional-modeling
     - context/methodology/fact-table-types
     - context/methodology/scd-strategies
     - context/layers/layering-system
     - context/platform/hive-constraints
     - docs/naming

2. **INSTRUCTIONS 块**
   - 角色定义：资深数据仓库架构师，专注 Kimball 维度建模
   - 核心能力：根据业务事件/指标/粒度设计星型模型
   - 决策指导原则：
     - 事实表类型推荐（事务/周期快照/累积快照/无度量）+ 推荐原因
     - SCD 策略推荐（Type 1/2/3）+ 推荐原因（不逐个询问）
     - 分层落点建议（DWD/DWS/ADS）+ 各选项利弊
     - 度量可加性标注（完全可加/半可加/不可加）
   - 缺失信息处理策略：先推断 + 请用户确认

3. **输入格式说明**
   - 支持两种格式：YAML 模板 / 自由文本描述
   - 必填最小集：业务事件 + 粒度
   - 可选字段：指标需求、维度列表、字段清单
   - 多事件支持：允许一次输入多个相关业务事件

4. **输出引用**
   - 引用 output-template.md 定义输出格式
   - 说明输出包含 5 个核心部分：
     - 星型模型可视化（Mermaid + ASCII）
     - 事实表规格（粒度、度量、DDL、schema.yml）
     - 维度表规格（SCD、键、DDL、schema.yml）
     - 分层落点表（表名、分层、理由）
     - dbt 模板代码

5. **内嵌简单案例**（作为格式参考，约 300 tokens）
   - 使用电商订单场景的简化版
   - 展示输入 → 输出的完整流程
   - 标记"完整案例参见 examples/"

**Token 预算：** 目标 1,500 tokens（上限 2,000）

**注意事项：**
- 不重复定义已有文档中的概念（通过 includes 引用）
- 决策逻辑引用方法论文档中的决策树
- 标准字段列表引用 naming.md
  </action>
  <verify>
- 文件存在且非空
- 包含 frontmatter（`---` 开头结尾）
- 包含 INSTRUCTIONS 块
- 包含 includes 引用 6 个上下文文档
- 中文字符数 < 1,500（保守估算 tokens）
- 使用 `wc -m` 检查字符数
  </verify>
  <done>
prompt.md 创建完成，包含完整的 4-block 结构、决策指导逻辑、输入格式说明、内嵌简单案例，token 数在预算内
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建输出模板文件 output-template.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md</files>
  <action>
创建输出格式模板文件，定义"设计新模型"场景的标准输出结构。

**文件结构要求：**

1. **Frontmatter（YAML）**
   - type: template
   - name: design-new-model-output
   - version: 1.0.0

2. **输出结构总览**
   - 说明完整输出包含 5 个核心部分
   - 提供目录导航

3. **Part 1: 星型模型可视化**
   - Mermaid ER 图模板（erDiagram 语法）
   - ASCII 文本图模板（备选方案）
   - 图表标注规范：PK/FK/BK、可加性

4. **Part 2: 事实表规格**
   - 粒度声明模板（何时、何物、何值）
   - 度量字段清单模板（字段名、类型、描述、可加性标注：meta.additivity）
   - 维度引用清单
   - 标准字段（必须包含）：
     - is_deleted (TINYINT)
     - data_source (STRING)
     - dw_create_time (TIMESTAMP)
     - dw_modify_time (TIMESTAMP)
     - etl_date (DATE)
     - dt (STRING) — 分区键
   - Hive DDL 模板（分区、存储格式 ORC、COMMENT）
   - dbt schema.yml 模板（description、tests、meta）

5. **Part 3: 维度表规格**
   - 每个维度表包含：
     - 维度表名（遵循 dim_ 前缀规范）
     - 自然键定义（Business Key）
     - 代理键定义（Surrogate Key）
     - SCD 策略决策（Type 1/2/3）+ 推荐原因
     - 属性清单（缓慢变化/快速变化标记）
     - Type 2 特有字段：dw_valid_from, dw_valid_to, is_current
     - Hive DDL 模板
     - dbt schema.yml 模板

6. **Part 4: 分层落点表**
   - 表格格式：表名 | 分层 | 理由
   - 分层选项：DWD（细节层）/ DWS（汇总层）/ ADS（应用层）
   - 维度表落层：DWD

7. **Part 5: dbt 模板代码**
   - 事实表 dbt SQL 模板（insert_overwrite + partition_by）
   - 维度表 dbt SQL 模板（按 SCD 类型区分）
   - 配置块：materialized、incremental_strategy、partition_by、file_format
   - 分区列必须在 SELECT 末尾（HIVE-001 约束）

8. **质量检查清单**
   - 粒度是否清晰且一致性维度完整
   - 度量字段可加性是否标记
   - SCD 策略选择是否有依据
   - 标准字段是否完整（6 个）
   - 分层落点是否符合规范
   - 分区列位置是否正确

**Token 预算：** 目标 800 tokens（上限 1,000）

**注意事项：**
- 使用占位符标记可变部分（如 `{表名}`、`{字段列表}`）
- 提供代码示例但控制长度
- 强调 DESIGN-06 要求的标准字段
  </action>
  <verify>
- 文件存在且非空
- 包含 5 个核心部分（星型图、事实表、维度表、分层、dbt 模板）
- 包含 Mermaid ER 图模板
- 包含标准字段列表（6 个）
- 包含 meta.additivity 可加性标注
- 包含质量检查清单
- 使用 `wc -m` 检查字符数 < 1,000
  </verify>
  <done>
output-template.md 创建完成，包含 5 个核心输出部分、标准字段、可加性标注、质量检查清单，token 数在预算内
  </done>
</task>

</tasks>

<verification>
整体验证：

1. **文件结构验证**
   ```bash
   ls -la .claude/data-warehouse/prompts/scenarios/design-new-model/
   # 应存在 prompt.md 和 output-template.md
   ```

2. **Token 预算验证**
   ```bash
   wc -m .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
   wc -m .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
   # prompt.md < 1,500 字符，output-template.md < 1,000 字符
   ```

3. **内容完整性验证**
   - prompt.md 包含 INSTRUCTIONS、输入格式、输出引用、内嵌案例
   - output-template.md 包含 5 个核心部分、标准字段、质量清单

4. **引用验证**
   - prompt.md 的 includes 引用存在的文件
   - output-template.md 被 prompt.md 引用
</verification>

<success_criteria>
- [x] prompt.md 创建，包含 4-block 结构、决策指导、输入格式、内嵌案例
- [x] output-template.md 创建，包含 5 个核心输出部分
- [x] 两个文件 token 数在预算内（prompt < 1,500，template < 1,000）
- [x] 标准字段（DESIGN-06）在模板中明确列出
- [x] 度量可加性标注（meta.additivity）在模板中要求
- [x] 分区列位置（HIVE-001）在模板中强调
</success_criteria>

<output>
After completion, create `.planning/phases/04-design-new-model/04-01-SUMMARY.md`
</output>
