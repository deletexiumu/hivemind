---
phase: 04-design-new-model
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
  - .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md
  - .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md
autonomous: true

# 备注：3 个案例合计约 2800 tokens，单计划 3 任务接近边界。
# 如执行时遇到上下文压力，可将复杂案例 e-commerce-order.md 拆分到单独 plan。
# 当前保持合并以减少 plan 数量，建议执行时优先处理复杂案例。

must_haves:
  truths:
    - "案例覆盖电商、用户行为、金融三个领域"
    - "案例覆盖事务事实表、事件事实表、周期快照事实表三种类型"
    - "案例包含完整的输入->输出示例"
    - "案例展示不同复杂度梯度"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md"
      provides: "电商订单案例（复杂：多维度 + SCD Type 2）"
      contains: "dim_customer"
      min_tokens: 900
      max_tokens: 1200
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md"
      provides: "用户行为案例（中等：事件类）"
      contains: "page_view"
      min_tokens: 600
      max_tokens: 800
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md"
      provides: "财务收入案例（中等：周期快照类型）"
      contains: "revenue"
      min_tokens: 600
      max_tokens: 800
  key_links:
    - from: "examples/*.md"
      to: "output-template.md"
      via: "输出格式一致性"
      pattern: "### File:"
---

<objective>
创建 3 个完整案例，覆盖不同业务领域和事实表类型，作为提示系统的参考样例和质量基准。

Purpose: 案例库为用户提供可参考的输入->输出示例，同时作为人工评审的测试集（ROADMAP 成功标准第 4 条）。

Output:
- e-commerce-order.md（电商订单，复杂案例）
- user-behavior-pv.md（用户行为，中等案例）
- finance-revenue.md（财务收入，中等案例）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-design-new-model/04-CONTEXT.md
@.planning/phases/04-design-new-model/04-RESEARCH.md
@.planning/phases/04-design-new-model/04-01-SUMMARY.md
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建电商订单案例（复杂）</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
  </files>
  <action>
    创建电商订单复杂案例，展示多维度 + SCD Type 2 场景：

    **Frontmatter:**
    ```yaml
    ---
    type: example
    scenario: design-new-model
    domain: e-commerce
    complexity: complex
    fact_type: transaction
    dimensions: 5
    scd_types: [Type1, Type2]
    ---
    ```

    **案例结构：**

    **1. 输入（~200 tokens）**
    - 业务事件：订单明细（每个订单行一条记录）
    - 粒度声明：一个订单 + 一个商品 = 一行
    - 度量需求：数量、单价、订单金额、折扣金额、实付金额
    - 维度需求：客户（SCD2）、商品（SCD1）、门店、日期、订单状态
    - 数据源：ODS MySQL 订单表 + 订单明细表

    **2. Stage 1 输出示例（~300 tokens）**
    - 输入解析结果
    - 决策摘要：
      - 事实表类型：事务事实表（每笔订单行是独立事件）
      - SCD 策略：客户 Type 2（需追踪历史），商品 Type 1（覆盖即可）
      - 分层落点：事实表->DWD，维度表->DWD dim_前缀
      - 键策略：事实表 FK 使用 customer_key 指向 dim_customer.customer_sk
    - 假设清单
    - 待确认问题

    **3. Stage 2 输出示例（~600 tokens）**
    - 星型图（Mermaid ER 图）
    - 事实表 DDL + schema.yml（dwd_fact_order_detail）
    - 维度表 DDL（dim_customer, dim_product, dim_store, dim_date）
    - 分层落点表
    - dbt SQL 模板（完整可运行代码）
    - 自检清单结果

    **4. 案例要点总结（~100 tokens）**
    - 关键决策点
    - 适用场景
    - 注意事项

    **输出格式要求：**
    - Stage 2 中每个文件使用 `### File: {path}` 格式标注路径
    - 与 output-template.md 格式保持一致

    总计目标：~1200 tokens
  </action>
  <verify>
    ```bash
    # 检查文件存在
    cat .claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md | head -50

    # 估算 token 数
    wc -w .claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
    # 目标：字数 < 1800（对应 ~1200 tokens）

    # 验证输出格式符合 output-template.md（File: 路径契约）
    grep -E '### File:' .claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
    ```
  </verify>
  <done>
    电商订单复杂案例创建完成，包含多维度 + SCD Type 2 场景的完整输入->输出示例，输出格式符合 output-template.md
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建用户行为案例（中等）</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md
  </files>
  <action>
    创建用户行为中等案例，展示事件类事实表场景：

    **Frontmatter:**
    ```yaml
    ---
    type: example
    scenario: design-new-model
    domain: analytics
    complexity: medium
    fact_type: transaction
    dimensions: 3
    scd_types: [Type1]
    ---
    ```

    **案例结构：**

    **1. 输入（~150 tokens）**
    - 业务事件：用户页面浏览（PV）
    - 粒度声明：一个用户 + 一次浏览 = 一行
    - 度量需求：停留时长（半可加）、是否跳出（不可加）
    - 维度需求：用户、页面、日期/时间
    - 特点：高频事件、无复杂 SCD 需求

    **2. Stage 1 输出示例（~200 tokens）**
    - 输入解析结果
    - 决策摘要：
      - 事实表类型：事务事实表（每次浏览是独立事件）
      - SCD 策略：全部 Type 1（用户行为维度无需历史追踪）
      - 分层落点：事实表->DWD
    - 完整度评估：可生成可运行 SQL

    **3. Stage 2 输出示例（~400 tokens）**
    - 星型图（简化版）
    - 事实表 DDL + schema.yml（dwd_fact_user_pv）
    - 维度表 DDL（dim_user, dim_page）
    - dbt SQL 模板

    **4. 案例要点总结（~50 tokens）**
    - 与电商订单案例的差异点
    - 高频事件处理建议

    **输出格式要求：**
    - Stage 2 中每个文件使用 `### File: {path}` 格式标注路径
    - 与 output-template.md 格式保持一致

    总计目标：~800 tokens
  </action>
  <verify>
    ```bash
    # 检查文件存在
    cat .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md | head -50

    # 估算 token 数
    wc -w .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md
    # 目标：字数 < 1200（对应 ~800 tokens）

    # 验证输出格式符合 output-template.md（File: 路径契约）
    grep -E '### File:' .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md
    ```
  </verify>
  <done>
    用户行为中等案例创建完成，展示事件类事务事实表的简化场景，输出格式符合 output-template.md
  </done>
</task>

<task type="auto">
  <name>Task 3: 创建财务收入案例（中等）</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md
  </files>
  <action>
    创建财务收入中等案例，展示周期快照事实表场景：

    **Frontmatter:**
    ```yaml
    ---
    type: example
    scenario: design-new-model
    domain: finance
    complexity: medium
    fact_type: periodic_snapshot
    dimensions: 3
    scd_types: [Type1, Type2]
    ---
    ```

    **案例结构：**

    **1. 输入（~150 tokens）**
    - 业务事件：月度收入统计
    - 粒度声明：一个部门 + 一个月份 = 一行
    - 度量需求：本月收入（可加）、累计收入（半可加）、收入达成率（不可加）
    - 维度需求：部门（SCD2）、时间周期、收入类别
    - 特点：定期快照、不是事件驱动

    **2. Stage 1 输出示例（~200 tokens）**
    - 输入解析结果
    - 决策摘要：
      - 事实表类型：周期快照事实表（定期记录状态）
      - 决策理由对比：为什么不是事务事实表
      - 半可加度量处理说明
      - SCD 策略：部门 Type 2（组织架构变更需追踪）

    **3. Stage 2 输出示例（~400 tokens）**
    - 星型图
    - 事实表 DDL + schema.yml（dws_snapshot_revenue_monthly）
    - 注意：周期快照表落层 DWS（不是 DWD）
    - 维度表 DDL（dim_department, dim_revenue_category）
    - dbt SQL 模板

    **4. 案例要点总结（~50 tokens）**
    - 周期快照 vs 事务事实的关键差异
    - 半可加度量的 schema.yml 标注

    **输出格式要求：**
    - Stage 2 中每个文件使用 `### File: {path}` 格式标注路径
    - 与 output-template.md 格式保持一致

    总计目标：~800 tokens
  </action>
  <verify>
    ```bash
    # 检查文件存在
    cat .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md | head -50

    # 估算 token 数
    wc -w .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md
    # 目标：字数 < 1200（对应 ~800 tokens）

    # 验证输出格式符合 output-template.md（File: 路径契约）
    grep -E '### File:' .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md
    ```
  </verify>
  <done>
    财务收入中等案例创建完成，展示周期快照事实表场景，与事务事实表形成对比，输出格式符合 output-template.md
  </done>
</task>

</tasks>

<verification>
1. 3 个案例文件全部存在于 examples/ 目录
2. 案例覆盖：
   - 领域：电商、用户行为/流量、金融
   - 事实表类型：事务事实表（2 个）、周期快照（1 个）
   - 复杂度：复杂（1 个）、中等（2 个）
   - SCD 类型：包含 Type 1 和 Type 2
3. 每个案例包含完整的输入->Stage 1->Stage 2 输出示例
4. 输出格式与 output-template.md 一致（使用 `### File:` 路径契约）
5. 每个案例 token 数合理（复杂 ~1200，中等 ~800）
</verification>

<success_criteria>
- 3 个案例覆盖不同业务领域和事实表类型
- 案例包含完整的输入->输出示例
- 输出格式符合 output-template.md 规范（File: 路径契约）
- 案例可作为人工评审的测试集
- 案例展示关键决策点和适用场景
</success_criteria>

<output>
After completion, create `.planning/phases/04-design-new-model/04-03-SUMMARY.md`
</output>
