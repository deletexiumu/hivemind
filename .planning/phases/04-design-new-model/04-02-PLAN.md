---
phase: 04-design-new-model
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
  - .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
autonomous: true

must_haves:
  truths:
    - "用户输入业务事件/粒度/指标需求，系统输出完整星型模型设计"
    - "提示支持两段式交互：Stage 1 建模规格书 + Stage 2 完整产物"
    - "输出包含 5 个核心部分：星型图、事实表定义、维度定义、分层映射、dbt 模板"
    - "提示可在标准 Claude 上下文中运行（单次交互不超出模型限制）"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md"
      provides: "设计新模型场景的主提示文件"
      contains: "INSTRUCTIONS"
      min_tokens: 1200
      max_tokens: 2000
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md"
      provides: "输出格式模板"
      contains: "File:"
      min_tokens: 600
      max_tokens: 1000
  key_links:
    - from: "prompt.md"
      to: "*-core.md files"
      via: "frontmatter includes"
      pattern: "includes:"
    - from: "prompt.md"
      to: "output-template.md"
      via: "OUTPUT FORMAT 引用"
      pattern: "output-template"
---

<objective>
创建"设计新模型"场景的主提示文件和输出模板，实现 DESIGN-01 ~ DESIGN-06 需求。

Purpose: 这是 Phase 4 的核心交付物，用户通过此提示输入业务事件/粒度/指标需求，获得完整的星型模型设计（事实表、维度表、DDL、schema.yml、dbt SQL 模板）。

Output:
- prompt.md（主提示，~1500 tokens）
- output-template.md（输出格式模板，~800 tokens）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-design-new-model/04-CONTEXT.md
@.planning/phases/04-design-new-model/04-RESEARCH.md
@.planning/phases/04-design-new-model/04-01-SUMMARY.md

# Plan 01 创建的精简版上下文（待引用）
@.claude/data-warehouse/context/methodology/dimensional-modeling-core.md
@.claude/data-warehouse/context/methodology/fact-table-types-core.md
@.claude/data-warehouse/context/methodology/scd-strategies-core.md
@.claude/data-warehouse/context/layers/layering-system-core.md
@.claude/data-warehouse/context/platform/hive-constraints-core.md
@.claude/data-warehouse/context/platform/dbt-hive-limitations-core.md
@.claude/data-warehouse/docs/naming-core.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建场景目录结构</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/
  </files>
  <action>
    创建目录结构：
    ```
    .claude/data-warehouse/prompts/scenarios/design-new-model/
    ├── prompt.md           (Task 2 创建)
    ├── output-template.md  (Task 3 创建)
    └── examples/           (Plan 03 创建)
    ```

    创建目录：
    ```bash
    mkdir -p .claude/data-warehouse/prompts/scenarios/design-new-model/examples
    ```
  </action>
  <verify>
    ```bash
    ls -la .claude/data-warehouse/prompts/scenarios/design-new-model/
    ```
  </verify>
  <done>
    场景目录结构创建完成
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建主提示文件 prompt.md</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
  </files>
  <action>
    创建主提示文件，采用 4-block 结构化提示模式：

    **Frontmatter (~50 tokens):**
    ```yaml
    ---
    type: scenario-prompt
    scenario: design-new-model
    version: 1.0.0
    token_budget: 1500
    includes:
      - context/methodology/dimensional-modeling-core
      - context/methodology/fact-table-types-core
      - context/methodology/scd-strategies-core
      - context/layers/layering-system-core
      - context/platform/hive-constraints-core
      - context/platform/dbt-hive-limitations-core
      - docs/naming-core
    ---
    ```

    **INSTRUCTIONS 块 (~400 tokens):**
    - 角色定义：资深数据仓库架构师，专注 Kimball 维度建模
    - 两段式交互说明：Stage 1 (默认) vs Stage 2 (用户确认后)
    - 决策指导原则（3 条）：
      1. 事实表类型推荐 — 根据业务特征自动推荐，解释原因
      2. SCD 策略推荐 — 根据维度属性特征推荐，不逐个询问
      3. 分层落点建议 — 列出选项和利弊，给出推荐

    **CONTEXT 块 (~100 tokens):**
    - 占位符说明：`{CONTEXT_PLACEHOLDER: 运行时注入的上下文}`
    - 运行时注入机制：执行工具读取 frontmatter 中的 includes 列表，依次加载对应的 *-core.md 文件内容，替换 CONTEXT_PLACEHOLDER
    - 标注：Phase 4 由执行者手动组装/注入，Phase 8 工具化自动组合

    **TASK 块 (~300 tokens):**
    - 输入格式说明（混合模式：YAML 模板 + 自由文本）
    - 必填最小集：业务事件 + 粒度
    - 推荐信息（强烈建议提供）：指标需求（度量字段清单）
    - 可选信息：维度清单、字段清单、数据源信息
    - 缺失信息处理策略：
      - 若缺少指标需求：先根据业务事件推断常见度量，列出假设清单，请用户确认或补充
      - 其他缺失信息：先推断，列出假设清单
    - 支持多事件统一建模

    **OUTPUT FORMAT 块 (~400 tokens):**
    - Stage 1 输出结构：
      1. 输入解析结果（结构化字段）
      2. 决策摘要（事实表类型、SCD 策略、分层落点、键策略）
      3. 假设清单（对缺失信息的推断）
      4. 完整度评估（缺少哪些输入导致无法生成可运行 SQL）
      5. 待确认问题（只问关键缺口）
    - Stage 2 触发条件：用户回复"确认/OK/按此执行"或 mode: full
    - Stage 2 输出：引用 output-template.md

    **内嵌简单案例 (~250 tokens):**
    - 一个简单案例作为答复样例（1-2 个维度的事务事实表）
    - 展示 Stage 1 输出格式

    总计目标：~1500 tokens
  </action>
  <verify>
    ```bash
    # 检查文件存在
    cat .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md | head -100

    # 估算 token 数（wc -w 作为参考，中文 1 token ≈ 1.5 字）
    wc -w .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
    # 目标：字数 < 2250（对应 ~1500 tokens）

    # 验证 includes 声明存在
    grep -E 'includes:' .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md

    # 验证 CONTEXT_PLACEHOLDER 存在（用于运行时注入）
    grep -E 'CONTEXT_PLACEHOLDER|运行时注入' .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md

    # 验证指标需求作为推荐信息
    grep -E '指标需求|推荐信息' .claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
    ```
  </verify>
  <done>
    主提示文件 prompt.md 创建完成，包含 4-block 结构、两段式交互说明、决策指导原则、运行时注入机制、指标需求作为推荐信息、内嵌简单案例
  </done>
</task>

<task type="auto">
  <name>Task 3: 创建输出模板文件 output-template.md</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
  </files>
  <action>
    创建输出模板文件，定义 Stage 2 完整产物的输出格式：

    **Frontmatter:**
    ```yaml
    ---
    type: output-template
    scenario: design-new-model
    version: 1.0.0
    ---
    ```

    **输出结构（5 个核心部分）:**

    **1. 星型模型图 (~100 tokens)**
    - Mermaid ER 图模板
    - ASCII 图模板（备选）
    - 图例说明（PK/FK/BK 标记）

    **2. 事实表定义 (~200 tokens)**
    - 粒度声明模板（何时、何物、何值）
    - 事实表类型 + 推荐理由
    - 度量字段清单模板（字段名 + 类型 + 可加性 + 说明）
    - 维度引用清单模板（维度名 + FK 字段 + 引用规则）
    - 标准字段清单（DESIGN-06 要求：is_deleted/data_source/dw_create_time/dw_modify_time/etl_date）
    - DDL 模板（含分区、存储格式 ORC、TBLPROPERTIES）

    **3. 维度表定义 (~150 tokens)**
    - 每个维度表模板：
      - 自然键定义
      - SCD 策略 + 决策理由
      - 属性清单（缓慢/快速变化分类）
      - 代理键处理
      - DDL 模板
    - 迟到维处理说明（Unknown 成员 sk=-1）

    **4. 分层落点表 (~100 tokens)**
    - 表格模板：表名 | 分层 | 类型 | 理由
    - 包含所有事实表和维度表

    **5. dbt 模板代码 (~150 tokens)**
    - schema.yml 模板（version 2，含 description/tests/meta）
    - SQL 模型模板（config + CTE 结构 + SELECT）
    - 文件路径契约格式：`### File: models/dwd/xxx.sql`

    **输出交付契约 (~50 tokens)**
    - 每个文件必须有明确路径，使用格式：`### File: {path}`
    - 代码块语言必须正确（sql/yaml/mermaid）
    - 不确定部分用 TODO 标记

    **自检清单 (~50 tokens)**
    - 结构完整性
    - 键规则正确性
    - Hive 约束合规性
    - 标准字段完整性
    - schema.yml 完整性

    总计目标：~800 tokens
  </action>
  <verify>
    ```bash
    # 检查文件存在
    cat .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md | head -80

    # 估算 token 数
    wc -w .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
    # 目标：字数 < 1200（对应 ~800 tokens）

    # 验证 File: 路径契约格式存在
    grep -E '### File:|File:' .claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
    ```
  </verify>
  <done>
    输出模板文件 output-template.md 创建完成，包含 5 个核心部分 + 输出交付契约（File: 路径格式） + 自检清单
  </done>
</task>

</tasks>

<verification>
1. 目录结构 `.claude/data-warehouse/prompts/scenarios/design-new-model/` 存在
2. prompt.md 文件存在且包含：
   - frontmatter (includes 声明 7 个 *-core 文件)
   - INSTRUCTIONS 块（角色 + 两段式交互 + 决策原则）
   - CONTEXT 块（占位符 + 运行时注入机制说明）
   - TASK 块（输入格式 + 必填最小集 + 指标需求作为推荐信息）
   - OUTPUT FORMAT 块（Stage 1 + Stage 2 引用）
   - 内嵌简单案例
3. output-template.md 文件存在且包含：
   - 5 个核心部分模板
   - 输出交付契约（File: 路径格式）
   - 自检清单
4. prompt.md 字数 < 2250（token 数 < 1500，可在标准上下文中运行）
5. output-template.md 字数 < 1200（token 数 < 800）
6. prompt.md 正确引用 output-template.md
</verification>

<success_criteria>
- prompt.md 实现 DESIGN-01 ~ DESIGN-06 需求覆盖
- 两段式交互设计完整
- 输出模板覆盖 5 个核心部分
- Token 预算合规，可在标准 Claude 上下文中运行
- 可与 Plan 01 的 *-core 文件配合使用
</success_criteria>

<output>
After completion, create `.planning/phases/04-design-new-model/04-02-SUMMARY.md`
</output>
