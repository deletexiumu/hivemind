---
phase: 04-design-new-model
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md"
  - ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md"
  - ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md"
autonomous: true

must_haves:
  truths:
    - "用户可以参考电商订单案例学习完整的星型模型设计流程"
    - "用户可以参考用户行为案例理解流量/事件类建模"
    - "用户可以参考财务收入案例理解金融领域建模特点"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md"
      provides: "电商订单星型模型完整案例"
      contains: "dwd_fact_order"
      min_lines: 150
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md"
      provides: "用户行为/流量星型模型案例"
      contains: "dwd_fact_page_view"
      min_lines: 120
    - path: ".claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md"
      provides: "财务收入星型模型案例"
      contains: "周期快照"
      min_lines: 120
  key_links:
    - from: "examples/*.md"
      to: "output-template.md"
      via: "遵循输出模板结构"
      pattern: "Part [1-5]"
    - from: "examples/*.md"
      to: "prompt.md"
      via: "案例遵循提示定义的决策逻辑"
      pattern: "SCD.*Type"
---

<objective>
创建"设计新模型"场景的案例库，覆盖电商、用户行为、财务三个领域。

Purpose: 提供多领域的完整设计案例，帮助用户学习星型模型设计流程，同时作为 Claude 输出的格式参考。

Output:
- `examples/e-commerce-order.md` — 电商订单案例（复杂，多维度 + 多事实）
- `examples/user-behavior-pv.md` — 用户行为/流量案例（中等，事件类）
- `examples/finance-revenue.md` — 财务收入案例（中等，周期快照类型）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-design-new-model/04-CONTEXT.md
@.planning/phases/04-design-new-model/04-RESEARCH.md
@.planning/phases/04-design-new-model/04-01-SUMMARY.md

# 核心引用 - prompt 和 output-template
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md

# 方法论引用
@.claude/data-warehouse/context/methodology/dimensional-modeling.md
@.claude/data-warehouse/context/methodology/fact-table-types.md
@.claude/data-warehouse/context/methodology/scd-strategies.md
@.claude/data-warehouse/context/layers/layering-system.md
@.claude/data-warehouse/docs/naming.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建电商订单案例 e-commerce-order.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md</files>
  <action>
创建电商订单星型模型的完整设计案例，作为复杂场景的参考示例。

**案例定位：** 复杂案例（4-5 个维度 + 多事件 + SCD Type 2）

**文件结构：**

1. **Frontmatter**
   - type: example
   - scenario: design-new-model
   - domain: e-commerce
   - complexity: complex
   - fact_type: transaction
   - dimensions_count: 5

2. **案例背景**
   - 业务场景：电商平台订单分析
   - 分析需求：订单金额、商品销量、客户分布、时间趋势
   - 数据特点：订单明细级、多渠道、客户信息变化

3. **输入示例**
   ```yaml
   business_event: 订单支付
   grain: 一个订单商品行（订单明细）
   measures:
     - name: quantity
       desc: 商品数量
     - name: unit_price
       desc: 商品单价
     - name: line_amount
       desc: 订单行金额
     - name: discount_amount
       desc: 折扣金额
   dimensions:
     - 时间（订单日期）
     - 客户（支持历史追溯）
     - 商品
     - 门店/渠道
     - 促销活动
   ```

4. **输出示例（遵循 output-template.md 结构）**

   **Part 1: 星型模型可视化**
   - Mermaid ER 图（完整版，展示 5 个维度）
   - ASCII 图（简化版）

   **Part 2: 事实表规格**
   - 表名：dwd_fact_order_detail
   - 粒度声明：一个订单中的一个商品行
   - 事实类型推荐：事务事实表 + 决策依据
   - 度量字段（含可加性标注）：
     - quantity: additive（可加）
     - unit_price: non_additive（不可加）
     - line_amount: additive（可加）
     - discount_amount: additive（可加）
   - 标准字段（6 个全部列出）
   - Hive DDL（完整可执行）
   - schema.yml（含 tests + meta.additivity）

   **Part 3: 维度表规格**
   - dim_customer（SCD Type 2 — 客户等级变化需追溯）
   - dim_product（SCD Type 1 — 商品名称变更覆盖）
   - dim_store（SCD Type 1 — 门店信息稳定）
   - dim_promotion（SCD Type 1 — 活动结束后不变）
   - dim_date（无 SCD — 静态日期维度）
   - 每个维度表：DDL + schema.yml

   **Part 4: 分层落点表**
   | 表名 | 分层 | 理由 |
   |------|------|------|
   | dwd_fact_order_detail | DWD | 订单明细事实表，保留原子粒度 |
   | dim_customer | DWD | 一致性维度，支持多事实表引用 |
   | dim_product | DWD | 商品维度，业务稳定 |
   | ... | ... | ... |

   **Part 5: dbt 模板代码**
   - 事实表 SQL（insert_overwrite + 分区回刷）
   - dim_customer SQL（SCD Type 2 实现）
   - 配置完整（materialized、partition_by 等）

5. **质量检查结果**
   - 逐项打勾展示检查通过

**Token 预算：** 目标 800-1,000 tokens（复杂案例可稍长）

**注意事项：**
- 完整展示 5 个核心输出部分
- SCD Type 2 使用 dbt-hive 兼容的 insert_overwrite 实现
- 标准字段必须完整（DESIGN-06）
- 分区列在 SELECT 末尾（HIVE-001）
  </action>
  <verify>
- 文件存在且非空
- 包含 Part 1-5 完整输出结构
- 包含 Mermaid ER 图
- 包含 5 个维度表定义
- dim_customer 使用 SCD Type 2
- 事实表包含 6 个标准字段
- schema.yml 包含 meta.additivity
- DDL 分区列在最后
  </verify>
  <done>
e-commerce-order.md 创建完成，展示复杂电商订单场景的完整星型模型设计，包含 5 个维度、SCD Type 2、完整 DDL 和 schema.yml
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建用户行为案例和财务收入案例</name>
  <files>
    .claude/data-warehouse/prompts/scenarios/design-new-model/examples/user-behavior-pv.md
    .claude/data-warehouse/prompts/scenarios/design-new-model/examples/finance-revenue.md
  </files>
  <action>
创建两个中等复杂度的案例，覆盖不同的建模模式。

---

## 案例 A: 用户行为/流量案例 (user-behavior-pv.md)

**案例定位：** 中等案例（3 个维度 + 无度量事实表特征）

**文件结构：**

1. **Frontmatter**
   - type: example
   - scenario: design-new-model
   - domain: user-behavior
   - complexity: medium
   - fact_type: transaction (with factless characteristics)
   - dimensions_count: 3

2. **案例背景**
   - 业务场景：用户页面浏览行为分析
   - 分析需求：PV/UV 统计、页面热度、用户路径
   - 数据特点：事件级、高频、无金额度量

3. **输入示例**
   ```yaml
   business_event: 页面浏览
   grain: 一次页面浏览事件
   measures:
     - name: stay_seconds
       desc: 停留时长（秒）
     - name: scroll_depth
       desc: 滚动深度（百分比）
   dimensions:
     - 时间（事件时间戳）
     - 用户
     - 页面
   ```

4. **输出示例（完整 5 部分）**
   - 事实表：dwd_fact_page_view
   - 事实类型：事务事实表（每次浏览一条记录）
   - 特殊说明：停留时长为半可加（semi_additive），不能跨时间加总
   - 维度：dim_user（SCD Type 1）、dim_page（SCD Type 1）、dim_date
   - 分层：全部落 DWD

5. **与电商案例的差异说明**
   - 无金额类度量
   - 维度更少
   - SCD 策略更简单（无 Type 2）

---

## 案例 B: 财务收入案例 (finance-revenue.md)

**案例定位：** 中等案例（3 个维度 + 周期快照事实表）

**文件结构：**

1. **Frontmatter**
   - type: example
   - scenario: design-new-model
   - domain: finance
   - complexity: medium
   - fact_type: periodic_snapshot
   - dimensions_count: 3

2. **案例背景**
   - 业务场景：月度收入汇总分析
   - 分析需求：月度收入趋势、部门对比、同比环比
   - 数据特点：月度快照、金额类度量

3. **输入示例**
   ```yaml
   business_event: 月度收入结算
   grain: 一个部门一个月的收入快照
   measures:
     - name: revenue_amount
       desc: 收入金额
     - name: cost_amount
       desc: 成本金额
     - name: profit_amount
       desc: 利润金额
   dimensions:
     - 时间（月度）
     - 部门
     - 产品线
   ```

4. **输出示例（完整 5 部分）**
   - 事实表：dwd_fact_monthly_revenue
   - 事实类型：**周期快照事实表** + 决策依据（月度状态量，需跨期对比）
   - 度量可加性：
     - revenue_amount: semi_additive（跨时间不可加，因为是余额类）
     - cost_amount: semi_additive
     - profit_amount: semi_additive
   - 维度：dim_department（SCD Type 2）、dim_product_line（SCD Type 1）、dim_date_month
   - 分层：落 DWD（明细快照）或可汇总到 DWS

5. **与事务事实表的差异说明**
   - 粒度是"时间周期 + 实体"
   - 度量多为半可加
   - 关键决策：周期快照 vs 事务

**Token 预算：** 每个案例目标 600-800 tokens

**注意事项：**
- 两个案例展示不同的事实表类型（事务 vs 周期快照）
- 展示不同的可加性标注（additive vs semi_additive）
- 维度数量适中（3 个）
- 遵循 output-template.md 结构但可适当精简
  </action>
  <verify>
- user-behavior-pv.md 存在且非空
- finance-revenue.md 存在且非空
- user-behavior-pv.md 包含 dwd_fact_page_view 事实表
- finance-revenue.md 包含周期快照事实表
- finance-revenue.md 包含 semi_additive 标注
- 两个文件都包含 Part 1-5 结构
- 两个文件都包含标准字段
  </verify>
  <done>
user-behavior-pv.md 和 finance-revenue.md 创建完成，分别展示事务事实表和周期快照事实表的建模差异，覆盖用户行为和财务领域
  </done>
</task>

</tasks>

<verification>
整体验证：

1. **文件结构验证**
   ```bash
   ls -la .claude/data-warehouse/prompts/scenarios/design-new-model/examples/
   # 应存在 3 个案例文件
   ```

2. **领域覆盖验证**
   - e-commerce-order.md — 电商领域 ✓
   - user-behavior-pv.md — 用户行为/流量领域 ✓
   - finance-revenue.md — 财务/金融领域 ✓

3. **事实表类型覆盖验证**
   - 事务事实表 (transaction) — e-commerce, user-behavior ✓
   - 周期快照事实表 (periodic_snapshot) — finance ✓

4. **SCD 策略覆盖验证**
   - SCD Type 1 — 所有案例都有
   - SCD Type 2 — e-commerce (dim_customer), finance (dim_department)

5. **可加性覆盖验证**
   - additive — e-commerce (line_amount, quantity)
   - semi_additive — finance (revenue_amount)
   - non_additive — e-commerce (unit_price)

6. **格式一致性验证**
   - 所有案例遵循 output-template.md 的 5 部分结构
   - 所有案例包含标准字段
   - 所有案例包含质量检查清单
</verification>

<success_criteria>
- [x] 3 个案例文件全部创建
- [x] 覆盖 3 个领域：电商、用户行为、财务
- [x] 覆盖 2 种事实表类型：事务、周期快照
- [x] 展示 SCD Type 1 和 Type 2
- [x] 展示 additive、semi_additive、non_additive 三种可加性
- [x] 所有案例遵循 output-template.md 结构
- [x] 所有案例包含 6 个标准字段
</success_criteria>

<output>
After completion, create `.planning/phases/04-design-new-model/04-02-SUMMARY.md`
</output>
