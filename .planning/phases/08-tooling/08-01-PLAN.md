---
phase: 08-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/config/scenarios.yaml
  - .claude/data-warehouse/config/platforms.yaml
  - .claude/data-warehouse/config/assembly-rules.yaml
  - .claude/data-warehouse/schemas/input/design-new-model.schema.json
  - .claude/data-warehouse/schemas/input/review-existing-model.schema.json
  - .claude/data-warehouse/schemas/input/generate-sql.schema.json
  - .claude/data-warehouse/schemas/input/define-metrics.schema.json
  - .claude/data-warehouse/schemas/input/generate-dq-rules.schema.json
  - .claude/data-warehouse/schemas/input/analyze-lineage.schema.json
  - .claude/data-warehouse/schemas/output/design-new-model.schema.json
  - .claude/data-warehouse/schemas/output/review-existing-model.schema.json
  - .claude/data-warehouse/schemas/output/generate-sql.schema.json
  - .claude/data-warehouse/schemas/output/define-metrics.schema.json
  - .claude/data-warehouse/schemas/output/generate-dq-rules.schema.json
  - .claude/data-warehouse/schemas/output/analyze-lineage.schema.json
autonomous: true

must_haves:
  truths:
    - "配置文件定义了 6 个场景及其关联的上下文"
    - "配置文件定义了 hive 平台的上下文文件清单"
    - "每个场景都有对应的 JSON Schema（输入+输出）"
    - "Schema 包含中文错误提示（errorMessage）"
  artifacts:
    - path: ".claude/data-warehouse/config/scenarios.yaml"
      provides: "6 场景配置映射"
      contains: "design-new-model"
    - path: ".claude/data-warehouse/config/platforms.yaml"
      provides: "平台上下文配置"
      contains: "hive"
    - path: ".claude/data-warehouse/config/assembly-rules.yaml"
      provides: "组装规则（token 预算、优先级）"
      contains: "max_tokens"
    - path: ".claude/data-warehouse/schemas/input/design-new-model.schema.json"
      provides: "设计场景输入校验"
      contains: "$schema"
  key_links:
    - from: "scenarios.yaml"
      to: "prompts/scenarios/*/prompt.md"
      via: "prompt_file 字段引用"
      pattern: "prompt_file:.*prompt\\.md"
    - from: "*.schema.json"
      to: "ajv 校验器"
      via: "draft-2020-12 格式"
      pattern: "\\$schema.*json-schema\\.org/draft/2020-12"
---

<objective>
创建配置文件和 JSON Schema，为提示组装和规格校验提供数据基础。

Purpose: 建立场景、平台、组装规则的配置中心，以及输入输出校验的 Schema 定义。这些是后续命令文件和脚本的基础。

Output:
- 3 个 YAML 配置文件（scenarios.yaml, platforms.yaml, assembly-rules.yaml）
- 12 个 JSON Schema 文件（6 场景 x 2 输入/输出）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tooling/08-RESEARCH.md

# 现有场景提示文件（参考 includes 和 token_budget）
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/review-existing-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/generate-sql/prompt.md
@.claude/data-warehouse/prompts/scenarios/define-metrics/prompt.md
@.claude/data-warehouse/prompts/scenarios/generate-dq-rules/prompt.md
@.claude/data-warehouse/prompts/scenarios/analyze-lineage/prompt.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建配置文件</name>
  <files>
    .claude/data-warehouse/config/scenarios.yaml
    .claude/data-warehouse/config/platforms.yaml
    .claude/data-warehouse/config/assembly-rules.yaml
  </files>
  <action>
创建 `.claude/data-warehouse/config/` 目录，然后创建 3 个配置文件：

**scenarios.yaml:**
- 定义 6 个场景的配置映射
- 每个场景包含：id, name（中文）, description（中文）, prompt_file（指向 prompt.md）, output_template（指向 output-template.md）, requires_context（上下文依赖列表，从 prompt.md frontmatter includes 提取）, max_tokens（从 prompt.md frontmatter token_budget 提取，默认 1500）
- 场景列表：design-new-model, review-existing-model, generate-sql, define-metrics, generate-dq-rules, analyze-lineage

**platforms.yaml:**
- 定义平台配置
- hive 平台：id, name（中文：Hive 数仓）, context_files（列出 platform/ 下的 core 文件：hive-constraints-core.md, dbt-hive-limitations-core.md）

**assembly-rules.yaml:**
- 定义组装规则
- context_levels: always/scenario/onDemand 三级
- always 级别：总是加载的 core 文件（hive-constraints-core.md, dbt-hive-limitations-core.md, naming-core.md）
- max_tokens: 4000（组装后总上限）
- reserve_output: 1500（输出预留）
- priority_order: 定义上下文文件的加载优先级（platform > methodology > layers > governance）

格式使用 YAML 1.2，添加中文注释说明各字段用途。
  </action>
  <verify>
    - 3 个配置文件存在且格式正确
    - `cat .claude/data-warehouse/config/scenarios.yaml | head -50` 显示场景配置
    - YAML 语法正确（无解析错误）
  </verify>
  <done>
    - scenarios.yaml 包含 6 个完整的场景配置
    - platforms.yaml 包含 hive 平台配置
    - assembly-rules.yaml 包含三级上下文加载规则和 token 预算
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建输入/输出 JSON Schema</name>
  <files>
    .claude/data-warehouse/schemas/input/design-new-model.schema.json
    .claude/data-warehouse/schemas/input/review-existing-model.schema.json
    .claude/data-warehouse/schemas/input/generate-sql.schema.json
    .claude/data-warehouse/schemas/input/define-metrics.schema.json
    .claude/data-warehouse/schemas/input/generate-dq-rules.schema.json
    .claude/data-warehouse/schemas/input/analyze-lineage.schema.json
    .claude/data-warehouse/schemas/output/design-new-model.schema.json
    .claude/data-warehouse/schemas/output/review-existing-model.schema.json
    .claude/data-warehouse/schemas/output/generate-sql.schema.json
    .claude/data-warehouse/schemas/output/define-metrics.schema.json
    .claude/data-warehouse/schemas/output/generate-dq-rules.schema.json
    .claude/data-warehouse/schemas/output/analyze-lineage.schema.json
  </files>
  <action>
创建 `.claude/data-warehouse/schemas/input/` 和 `.claude/data-warehouse/schemas/output/` 目录，然后为每个场景创建输入和输出 Schema。

**Schema 规范：**
- 使用 JSON Schema draft-2020-12
- 添加 `$id` 字段：`dw:{scenario}:{input|output}:v1`
- 每个字段添加 `description`（中文）
- 必填字段使用 `errorMessage` 提供友好中文错误提示（需要 ajv-errors）
- 添加 `schema_version: 1` 字段支持未来迁移

**各场景输入 Schema 必填字段（从各 prompt.md 的"必填最小集"提取）：**

1. **design-new-model:** business_event（业务事件）, grain（粒度）
2. **review-existing-model:** model_code（模型代码，SQL/dbt）
3. **generate-sql:** requirement（取数需求）, source_tables（数据源表）
4. **define-metrics:** metric_name（指标名称）, business_desc（业务描述）
5. **generate-dq-rules:** model_name（模型名称）, columns（字段清单）
6. **analyze-lineage:** target_model（目标模型）

**输出 Schema：**
- 定义各场景的输出结构骨架
- 参考对应的 output-template.md 确定必须包含的 section
- design-new-model: fact_table_definition, dimension_definitions, layer_mapping, dbt_template
- review-existing-model: summary, issues, quality_score
- generate-sql: sql_code, explanation, performance_hints
- define-metrics: metric_definition, semantic_layer_yaml
- generate-dq-rules: dbt_tests_yaml, rules_summary
- analyze-lineage: table_lineage, column_lineage (可选), mermaid_diagram
  </action>
  <verify>
    - 12 个 schema 文件存在
    - 每个文件是合法的 JSON
    - 包含 `$schema` 和 `$id` 字段
    - 输入 schema 包含 `errorMessage` 字段
  </verify>
  <done>
    - 6 个输入 Schema 定义了各场景的必填字段和校验规则
    - 6 个输出 Schema 定义了各场景输出的结构骨架
    - 所有 Schema 使用 draft-2020-12 格式，包含中文 errorMessage
  </done>
</task>

</tasks>

<verification>
- 配置目录 `.claude/data-warehouse/config/` 存在且包含 3 个 YAML 文件
- Schema 目录 `.claude/data-warehouse/schemas/input/` 和 `schemas/output/` 各包含 6 个 JSON 文件
- YAML 配置可被正确解析
- JSON Schema 格式合法
</verification>

<success_criteria>
- [ ] 3 个配置文件创建完成，定义了场景/平台/组装规则
- [ ] 12 个 JSON Schema 创建完成（6 输入 + 6 输出）
- [ ] 配置文件与现有 prompt.md 的 includes/token_budget 一致
- [ ] Schema 包含中文 description 和 errorMessage
</success_criteria>

<output>
After completion, create `.planning/phases/08-tooling/08-01-SUMMARY.md`
</output>
