---
phase: 08-tooling
plan: 05
type: execute
wave: 3
depends_on: ["08-03", "08-04"]
files_modified:
  - .claude/data-warehouse/README.md
  - .claude/data-warehouse/docs/extending.md
autonomous: true

must_haves:
  truths:
    - "README.md 说明了所有 /dw:* 命令的用法"
    - "扩展文档说明了如何添加新场景"
    - "扩展文档说明了如何添加新平台支持"
    - "文档包含完整的目录结构说明"
  artifacts:
    - path: ".claude/data-warehouse/README.md"
      provides: "工具使用指南"
      min_lines: 100
    - path: ".claude/data-warehouse/docs/extending.md"
      provides: "扩展开发指南"
      min_lines: 80
  key_links:
    - from: "README.md"
      to: ".claude/commands/dw/*.md"
      via: "命令列表引用"
      pattern: "/dw:(design|review|generate-sql)"
    - from: "extending.md"
      to: "scripts/scaffold.js"
      via: "脚手架使用说明"
      pattern: "/dw:new-scenario"
---

<objective>
创建使用文档和扩展指南，完成工具化阶段的文档交付。

Purpose: 让用户能够快速上手使用 `/dw:*` 命令系列，并了解如何扩展系统（添加新场景、新平台）。

Output:
- README.md: 工具使用指南
- docs/extending.md: 扩展开发指南
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 参考已创建的命令和配置
# .claude/commands/dw/*.md
# .claude/data-warehouse/config/*.yaml
# .claude/data-warehouse/scripts/*.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 README.md</name>
  <files>
    .claude/data-warehouse/README.md
  </files>
  <action>
创建 `.claude/data-warehouse/README.md`，包含以下内容：

```markdown
# HiveMind 数仓助手

> Hive + dbt 数仓的中文提示系统，覆盖六大高频场景。

## 快速开始

### 安装依赖

```bash
cd .claude/data-warehouse
npm install
```

### 场景命令

| 命令 | 用途 | 示例 |
|------|------|------|
| `/dw:design` | 设计新模型 | `/dw:design 订单支付事实表` |
| `/dw:review` | 评审已有模型 | `/dw:review` |
| `/dw:generate-sql` | 生成取数 SQL | `/dw:generate-sql 最近30天订单` |
| `/dw:define-metric` | 定义指标口径 | `/dw:define-metric 订单总额` |
| `/dw:generate-dq` | 生成 DQ 规则 | `/dw:generate-dq` |
| `/dw:analyze-lineage` | 分析血缘 | `/dw:analyze-lineage` |

### 工具命令

| 命令 | 用途 |
|------|------|
| `/dw:assemble` | 组装完整提示 |
| `/dw:validate` | 校验输入/输出 |
| `/dw:new-scenario` | 创建新场景脚手架 |

## 目录结构

```
.claude/data-warehouse/
├── prompts/
│   ├── system/              # 系统级提示
│   └── scenarios/           # 6 个场景
│       └── {scenario}/
│           ├── prompt.md       # 场景主提示
│           ├── output-template.md
│           ├── input-template.md
│           └── examples/
├── context/                 # 上下文知识库
│   ├── methodology/         # 方法论
│   ├── platform/            # 平台约束
│   ├── layers/              # 分层规范
│   └── governance/          # 治理规范
├── config/                  # 配置文件
│   ├── scenarios.yaml       # 场景配置
│   ├── platforms.yaml       # 平台配置
│   └── assembly-rules.yaml  # 组装规则
├── schemas/                 # JSON Schema
│   ├── input/               # 输入校验
│   └── output/              # 输出校验
├── scripts/                 # 辅助脚本
│   ├── assemble.js          # 组装逻辑
│   ├── validate.js          # 校验逻辑
│   └── scaffold.js          # 脚手架
├── glossary/                # 术语表
└── docs/                    # 文档
```

## 使用指南

### 1. 设计新模型

```
/dw:design
```

支持两种输入方式：
- 自由文本：描述业务事件和粒度
- YAML 模板：结构化输入

两段式交互：
1. Stage 1：输出建模规格书 → 确认
2. Stage 2：生成完整产物（DDL + dbt 模板）

### 2. 评审已有模型

```
/dw:review
```

粘贴模型代码（SQL 或 dbt 模型），系统将：
- 检查命名规范
- 检查分层引用
- 检查粒度定义
- 输出问题清单 + 修复建议

### 3. 生成取数 SQL

```
/dw:generate-sql 最近30天按城市的订单总额
```

输出：
- Hive SQL（含分区裁剪）
- 口径说明
- 性能提示

### 4. 组装提示（高级用法）

```
/dw:assemble design-new-model --context-level=standard
```

用于调试或集成场景。

## 技术栈

- 平台：Hive 4.x + dbt-hive 1.10.0
- 方法论：Kimball 维度建模
- 分层：ODS/DWD/DWS/ADS

## 扩展开发

参见 [docs/extending.md](docs/extending.md)
```
  </action>
  <verify>
    - README.md 存在
    - 包含命令列表表格
    - 包含目录结构说明
    - 包含使用指南
  </verify>
  <done>
    - README.md 完整覆盖所有命令的用法
    - 包含快速开始、目录结构、使用指南
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建扩展文档</name>
  <files>
    .claude/data-warehouse/docs/extending.md
  </files>
  <action>
创建 `.claude/data-warehouse/docs/extending.md`，包含以下内容：

```markdown
# 扩展开发指南

本文档说明如何扩展 HiveMind 数仓助手：添加新场景、新平台支持。

## 添加新场景

### 方式一：使用脚手架（推荐）

```bash
/dw:new-scenario my-new-scenario --name="我的新场景"
```

自动生成：
- `prompts/scenarios/my-new-scenario/prompt.md`
- `prompts/scenarios/my-new-scenario/output-template.md`
- `prompts/scenarios/my-new-scenario/input-template.md`
- `prompts/scenarios/my-new-scenario/examples/`
- `schemas/input/my-new-scenario.schema.json`
- `schemas/output/my-new-scenario.schema.json`
- 更新 `config/scenarios.yaml`

### 方式二：手动创建

1. **创建场景目录**
   ```
   prompts/scenarios/{scenario-id}/
   ```

2. **创建 prompt.md**
   ```yaml
   ---
   type: scenario-prompt
   scenario: {scenario-id}
   version: 1.0.0
   token_budget: 1500
   includes:
     - context/methodology/xxx-core
     - context/platform/xxx-core
   ---

   # 场景标题

   ## INSTRUCTIONS
   ...
   ```

3. **创建 input-template.md 和 output-template.md**

4. **创建 JSON Schema**
   - `schemas/input/{scenario-id}.schema.json`
   - `schemas/output/{scenario-id}.schema.json`

5. **更新配置**
   在 `config/scenarios.yaml` 添加：
   ```yaml
   {scenario-id}:
     name: "场景名称"
     description: "场景描述"
     prompt_file: prompts/scenarios/{scenario-id}/prompt.md
     output_template: prompts/scenarios/{scenario-id}/output-template.md
     requires_context:
       - context/xxx
     max_tokens: 1500
   ```

6. **创建命令文件**
   `.claude/commands/dw/{scenario-id}.md`

### 场景设计原则

- **单一职责**：一个场景解决一类问题
- **两段式交互**：Stage 1 确认 → Stage 2 生成
- **Token 预算**：单个提示 < 2000 tokens
- **中文输出**：代码标识符英文，输出中文

## 添加新平台支持

### 1. 创建平台上下文

在 `context/platform/` 下创建：
- `{platform}-constraints.md` — 完整文档
- `{platform}-constraints-core.md` — 精简版（<1000 tokens）

### 2. 更新平台配置

在 `config/platforms.yaml` 添加：
```yaml
{platform-id}:
  name: "平台名称"
  context_files:
    - context/platform/{platform}-constraints-core.md
```

### 3. 更新组装规则

在 `config/assembly-rules.yaml` 的 `always` 或 `scenario` 级别添加新平台文件。

### 平台文档规范

参考现有 Hive 文档：
- 分区策略
- 数据类型限制
- 性能优化原则
- 已知限制及规避方案

## 配置文件说明

### scenarios.yaml

```yaml
{scenario-id}:
  name: "场景中文名"           # 显示名称
  description: "场景描述"       # 简短描述
  prompt_file: "..."           # 主提示文件路径
  output_template: "..."       # 输出模板路径
  requires_context: []         # 依赖的上下文列表
  max_tokens: 1500             # Token 预算
```

### assembly-rules.yaml

```yaml
context_levels:
  always: []        # 始终加载
  scenario: {}      # 按场景加载
  onDemand: []      # 按需加载

max_tokens: 4000    # 组装后总上限
reserve_output: 1500 # 输出预留

priority_order:     # 加载优先级（裁剪时使用）
  - platform
  - methodology
  - layers
  - governance
```

## 测试新场景

1. **校验输入**
   ```
   /dw:validate {scenario-id} --input=test-input.yaml
   ```

2. **组装提示**
   ```
   /dw:assemble {scenario-id} --json
   ```
   检查 token 数是否在预算内。

3. **端到端测试**
   运行场景命令，验证输出符合预期。

## 常见问题

### Q: Token 超限怎么办？

A: 检查 `prompt.md` 的 includes 列表，移除非必要上下文。或在 `assembly-rules.yaml` 中将部分上下文移到 onDemand 级别。

### Q: 如何调试组装逻辑？

A: 使用 `/dw:assemble {scenario} --trace` 查看上下文来源。

### Q: 新场景的 Schema 如何设计？

A: 参考现有场景的 Schema，使用 JSON Schema draft-2020-12，添加 `errorMessage` 提供中文错误提示。
```
  </action>
  <verify>
    - extending.md 存在
    - 包含添加新场景的完整步骤
    - 包含添加新平台的完整步骤
    - 包含配置文件说明
  </verify>
  <done>
    - extending.md 覆盖新场景和新平台的扩展方法
    - 包含脚手架使用说明和手动创建步骤
    - 包含配置文件格式说明和常见问题
  </done>
</task>

</tasks>

<verification>
- README.md 和 docs/extending.md 存在
- README.md 包含完整的命令列表和使用指南
- extending.md 包含新场景和新平台的扩展步骤
- 文档中引用的路径与实际目录结构一致
</verification>

<success_criteria>
- [ ] README.md 创建，包含命令列表、目录结构、使用指南
- [ ] extending.md 创建，包含添加新场景和新平台的完整步骤
- [ ] 文档使用中文编写，代码示例准确
- [ ] 文档引用的文件路径正确
</success_criteria>

<output>
After completion, create `.planning/phases/08-tooling/08-05-SUMMARY.md`
</output>
