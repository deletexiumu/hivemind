---
phase: 08-tooling
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - .claude/data-warehouse/scripts/assemble.js
  - .claude/data-warehouse/scripts/validate.js
  - .claude/data-warehouse/scripts/scaffold.js
  - .claude/data-warehouse/package.json
autonomous: true

must_haves:
  truths:
    - "assemble.js 能根据场景组装完整提示"
    - "validate.js 能校验输入/输出并返回分级结果"
    - "scaffold.js 能生成新场景的脚手架文件"
    - "脚本支持 --json 输出模式"
    - "npm install 成功且脚本可运行"
  artifacts:
    - path: ".claude/data-warehouse/scripts/assemble.js"
      provides: "提示组装逻辑"
      min_lines: 100
    - path: ".claude/data-warehouse/scripts/validate.js"
      provides: "规格校验逻辑"
      min_lines: 80
    - path: ".claude/data-warehouse/scripts/scaffold.js"
      provides: "脚手架生成逻辑"
      min_lines: 50
    - path: ".claude/data-warehouse/package.json"
      provides: "依赖声明"
      contains: "gray-matter"
  key_links:
    - from: "assemble.js"
      to: "config/scenarios.yaml"
      via: "读取场景配置"
      pattern: "scenarios\\.yaml"
    - from: "validate.js"
      to: "schemas/input/*.schema.json"
      via: "ajv 校验"
      pattern: "ajv.*compile"
    - from: "package.json"
      to: "node_modules"
      via: "npm install"
      pattern: "dependencies.*gray-matter"
---

<objective>
创建核心辅助脚本（TOOLS-01/02），实现提示组装、规格校验、脚手架生成功能。

Purpose: 提供可被 `/dw:*` 命令调用的脚本，实现动态组装和校验逻辑。脚本遵循 08-RESEARCH.md 的技术栈建议（gray-matter, yaml, ajv）。

Output:
- assemble.js: 提示组装脚本
- validate.js: 规格校验脚本
- scaffold.js: 脚手架生成脚本
- package.json: 依赖声明
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tooling/08-RESEARCH.md

# 配置文件（Plan 01 创建）
# .claude/data-warehouse/config/scenarios.yaml
# .claude/data-warehouse/config/platforms.yaml
# .claude/data-warehouse/config/assembly-rules.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 package.json 和 assemble.js</name>
  <files>
    .claude/data-warehouse/package.json
    .claude/data-warehouse/scripts/assemble.js
  </files>
  <action>
**package.json:**

创建 `.claude/data-warehouse/package.json`：
```json
{
  "name": "dw-prompt-tools",
  "version": "1.0.0",
  "description": "HiveMind 数仓助手提示工具",
  "type": "module",
  "engines": {
    "node": ">=22"
  },
  "scripts": {
    "assemble": "node scripts/assemble.js",
    "validate": "node scripts/validate.js",
    "scaffold": "node scripts/scaffold.js"
  },
  "dependencies": {
    "gray-matter": "^4.0.3",
    "yaml": "^2.6.0",
    "ajv": "^8.17.1",
    "ajv-formats": "^3.0.1",
    "ajv-errors": "^3.0.0",
    "commander": "^12.1.0"
  }
}
```

**assemble.js:**

创建 `.claude/data-warehouse/scripts/assemble.js`，实现：

1. **CLI 接口:**
   ```
   node assemble.js <scenario> [--context-level=standard] [--platform=hive] [--json] [--trace]
   ```

2. **核心逻辑:**
   - 读取 `config/scenarios.yaml` 获取场景配置
   - 读取 `config/assembly-rules.yaml` 获取组装规则
   - 根据场景的 `requires_context` 加载上下文文件
   - 使用 gray-matter 解析 prompt.md，提取 frontmatter 和 content
   - 按 assembly-rules 的 priority_order 排序上下文
   - 组装：system prompt + context + scenario prompt + output template
   - 计算总 token 数（保守估算：1 中文字符 = 1 token）
   - 如超限，按优先级裁剪 onDemand 级别上下文

3. **输出:**
   - 默认：Markdown 格式（直接可用的组装提示）
   - --json：JSON 格式（含 trace、token breakdown）
   - --trace：在输出中包含上下文来源追踪

4. **错误处理:**
   - 场景不存在：清晰错误消息
   - 文件缺失：列出缺失文件
   - Token 超限：警告并提示裁剪

使用 ESM 模块格式（import/export）。
参考 08-RESEARCH.md 的 Pattern 2: Progressive Disclosure 实现渐进加载逻辑。
  </action>
  <verify>
    - package.json 存在且 JSON 格式正确
    - assemble.js 存在且 ESM 格式正确
    - `node --check .claude/data-warehouse/scripts/assemble.js` 无语法错误
  </verify>
  <done>
    - package.json 声明了所有必需依赖
    - assemble.js 实现了场景组装逻辑，支持 --json 和 --trace 参数
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建 validate.js 和 scaffold.js</name>
  <files>
    .claude/data-warehouse/scripts/validate.js
    .claude/data-warehouse/scripts/scaffold.js
  </files>
  <action>
**validate.js:**

创建 `.claude/data-warehouse/scripts/validate.js`，实现：

1. **CLI 接口:**
   ```
   node validate.js <scenario> --input=<file> [--output=<file>] [--json] [--strict]
   ```

2. **核心逻辑:**
   - 加载对应场景的 JSON Schema（input/*.schema.json, output/*.schema.json）
   - 使用 ajv + ajv-formats + ajv-errors 进行校验
   - 分级处理（参考 08-RESEARCH.md Pattern 4）：
     - CRITICAL：必填字段缺失、schema 版本不支持 → exit 1
     - WARNING：命名不符、轻微超预算 → 警告但继续
     - INFO：可选字段未填 → 仅提示
   - --strict 模式：WARNING 也导致 exit 1

3. **输出:**
   - 默认：人类可读报告（Markdown 格式）
   - --json：JSON 格式报告
   - 包含：校验结果、错误列表、合规性评分

4. **错误消息:**
   - 使用 schema 中定义的 errorMessage（中文）
   - 如无 errorMessage，提供默认中文翻译

**scaffold.js:**

创建 `.claude/data-warehouse/scripts/scaffold.js`，实现：

1. **CLI 接口:**
   ```
   node scaffold.js <scenario-id> [--name="场景名称"]
   ```

2. **核心逻辑:**
   - 在 `prompts/scenarios/<scenario-id>/` 创建目录
   - 生成模板文件：
     - prompt.md（带标准 frontmatter）
     - output-template.md（骨架）
     - input-template.md（骨架）
     - examples/ 目录
   - 在 `schemas/input/` 和 `schemas/output/` 创建空 schema
   - 更新 `config/scenarios.yaml` 添加新场景条目

3. **输出:**
   - 列出创建的所有文件
   - 提示下一步：填充具体内容

使用 ESM 模块格式。
  </action>
  <verify>
    - validate.js 和 scaffold.js 存在
    - `node --check .claude/data-warehouse/scripts/validate.js` 无语法错误
    - `node --check .claude/data-warehouse/scripts/scaffold.js` 无语法错误
  </verify>
  <done>
    - validate.js 实现了分级校验逻辑，支持 --json 和 --strict 参数
    - scaffold.js 实现了新场景脚手架生成，自动更新配置文件
  </done>
</task>

<task type="auto">
  <name>Task 3: 安装依赖并验证脚本可运行</name>
  <files>
    .claude/data-warehouse/node_modules (generated)
    .claude/data-warehouse/package-lock.json (generated)
  </files>
  <action>
1. **安装依赖:**
   ```bash
   cd .claude/data-warehouse && npm install
   ```

2. **验证脚本可运行:**
   ```bash
   # 验证 assemble.js
   cd .claude/data-warehouse && node scripts/assemble.js --help

   # 验证 validate.js
   cd .claude/data-warehouse && node scripts/validate.js --help

   # 验证 scaffold.js
   cd .claude/data-warehouse && node scripts/scaffold.js --help
   ```

3. **验证依赖可导入:**
   ```bash
   cd .claude/data-warehouse && node -e "import('gray-matter').then(() => console.log('gray-matter OK'))"
   cd .claude/data-warehouse && node -e "import('ajv').then(() => console.log('ajv OK'))"
   cd .claude/data-warehouse && node -e "import('yaml').then(() => console.log('yaml OK'))"
   ```

4. **添加 node_modules 到 .gitignore（如果尚未添加）**
  </action>
  <verify>
    - `npm install` 成功（exit code 0）
    - `node scripts/assemble.js --help` 输出帮助信息
    - `node scripts/validate.js --help` 输出帮助信息
    - `node scripts/scaffold.js --help` 输出帮助信息
    - 依赖导入测试全部通过
  </verify>
  <done>
    - node_modules 目录存在且包含所有依赖
    - 三个脚本都可以正常运行 --help
    - 依赖库可以正常导入
  </done>
</task>

</tasks>

<verification>
- `.claude/data-warehouse/scripts/` 目录包含 assemble.js, validate.js, scaffold.js
- package.json 声明了 gray-matter, yaml, ajv, ajv-formats, ajv-errors, commander
- 所有脚本无语法错误（node --check）
- 脚本支持 --json 输出模式
- `npm install` 成功完成
- `node scripts/assemble.js --help` 正常输出
- `node scripts/validate.js --help` 正常输出
- `node scripts/scaffold.js --help` 正常输出
</verification>

<success_criteria>
- [ ] package.json 创建，包含所有依赖
- [ ] assemble.js 实现组装逻辑，支持 context-level、platform、json、trace 参数
- [ ] validate.js 实现分级校验逻辑，支持 strict、json 参数
- [ ] scaffold.js 实现脚手架生成，自动更新配置
- [ ] 所有脚本使用 ESM 格式，无语法错误
- [ ] npm install 成功，所有依赖可用
- [ ] 三个脚本的 --help 命令正常工作
</success_criteria>

<output>
After completion, create `.planning/phases/08-tooling/08-03-SUMMARY.md`
</output>
