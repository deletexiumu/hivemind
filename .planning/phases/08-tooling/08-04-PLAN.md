---
phase: 08-tooling
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - .claude/commands/dw/design.md
  - .claude/commands/dw/review.md
  - .claude/commands/dw/generate-sql.md
  - .claude/commands/dw/define-metric.md
  - .claude/commands/dw/generate-dq.md
  - .claude/commands/dw/analyze-lineage.md
  - .claude/commands/dw/assemble.md
  - .claude/commands/dw/validate.md
  - .claude/commands/dw/new-scenario.md
autonomous: true

must_haves:
  truths:
    - "用户可以运行 /dw:design 触发设计场景"
    - "用户可以运行 /dw:review 触发评审场景"
    - "用户可以运行 /dw:assemble 组装提示"
    - "用户可以运行 /dw:validate 校验输入"
    - "所有命令包含中文描述和帮助信息"
  artifacts:
    - path: ".claude/commands/dw/design.md"
      provides: "/dw:design 命令"
      contains: "design-new-model"
    - path: ".claude/commands/dw/review.md"
      provides: "/dw:review 命令"
      contains: "review-existing-model"
    - path: ".claude/commands/dw/assemble.md"
      provides: "/dw:assemble 命令"
      contains: "assemble.js"
    - path: ".claude/commands/dw/validate.md"
      provides: "/dw:validate 命令"
      contains: "validate.js"
  key_links:
    - from: ".claude/commands/dw/*.md"
      to: "prompts/scenarios/*/prompt.md"
      via: "execution_context @引用"
      pattern: "@.*prompts/scenarios"
    - from: ".claude/commands/dw/assemble.md"
      to: "scripts/assemble.js"
      via: "Bash 调用"
      pattern: "node.*assemble\\.js"
---

<objective>
创建 `/dw:*` 命令文件（TOOLS-01），让用户可以通过斜杠命令使用数仓助手功能。

Purpose: 提供 Claude Code 原生的命令入口，与现有 `/gsd:*` 命令风格一致。命令文件引用场景提示和辅助脚本。

Output:
- 9 个命令文件（6 场景 + 3 工具命令）
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tooling/08-RESEARCH.md

# 参考现有 gsd 命令格式
@.claude/commands/gsd/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 6 个场景命令</name>
  <files>
    .claude/commands/dw/design.md
    .claude/commands/dw/review.md
    .claude/commands/dw/generate-sql.md
    .claude/commands/dw/define-metric.md
    .claude/commands/dw/generate-dq.md
    .claude/commands/dw/analyze-lineage.md
  </files>
  <action>
创建 `.claude/commands/dw/` 目录，然后创建 6 个场景命令文件。

**命令文件格式（以 design.md 为例）:**

```markdown
---
name: dw:design
description: 设计新的数仓模型（事实表/维度表）
argument-hint: "[业务事件描述]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
---

<objective>
根据业务需求设计星型模型，包含事实表、维度表、SCD 策略、分层落点。

**输出产物：**
- 建模规格书
- DDL 语句
- dbt schema.yml
- dbt SQL 模型
</objective>

<execution_context>
@./.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@./.claude/data-warehouse/prompts/scenarios/design-new-model/output-template.md
@./.claude/data-warehouse/prompts/scenarios/design-new-model/input-template.md
</execution_context>

<context>
# 运行时上下文（从 prompt.md frontmatter includes 加载）
@./.claude/data-warehouse/context/methodology/dimensional-modeling-core.md
@./.claude/data-warehouse/context/methodology/fact-table-types-core.md
@./.claude/data-warehouse/context/methodology/scd-strategies-core.md
@./.claude/data-warehouse/context/layers/layering-system-core.md
@./.claude/data-warehouse/context/platform/hive-constraints-core.md
@./.claude/data-warehouse/context/platform/dbt-hive-limitations-core.md
@./.claude/data-warehouse/docs/naming-core.md
</context>

<process>
1. **解析用户输入**
   - 如果 $ARGUMENTS 非空，解析为业务需求
   - 如果为空，询问业务事件和粒度

2. **执行两段式交互**
   - Stage 1：生成建模规格书 + 待确认问题
   - 等待用户确认
   - Stage 2：生成完整产物

3. **输出产物**
   - 按 output-template.md 格式输出
   - 使用 `### File: {path}` 标记可落盘文件
</process>

<success_criteria>
- [ ] 输入已解析（业务事件 + 粒度）
- [ ] 规格书已确认
- [ ] 产物完整（DDL + schema.yml + dbt SQL）
</success_criteria>
```

**6 个场景命令差异点：**

| 命令 | 场景 | 主要输入 | 主要输出 |
|------|------|---------|---------|
| design.md | design-new-model | 业务事件、粒度 | DDL、dbt 模板 |
| review.md | review-existing-model | 模型代码 | 问题清单、修复建议 |
| generate-sql.md | generate-sql | 取数需求 | Hive SQL、口径说明 |
| define-metric.md | define-metrics | 指标描述 | 指标定义、Semantic Layer YAML |
| generate-dq.md | generate-dq-rules | 模型定义 | dbt tests 配置 |
| analyze-lineage.md | analyze-lineage | 目标模型 | 血缘图、影响评估 |

每个命令文件的 `<context>` 部分引用对应场景 prompt.md frontmatter 中的 includes 列表。
  </action>
  <verify>
    - 6 个命令文件存在于 `.claude/commands/dw/`
    - 每个文件包含 frontmatter（name, description, allowed-tools）
    - 每个文件引用对应的 prompt.md 和上下文文件
  </verify>
  <done>
    - 6 个场景命令创建完成
    - 命令格式与 `/gsd:*` 风格一致
    - execution_context 引用正确的场景提示
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建 3 个工具命令</name>
  <files>
    .claude/commands/dw/assemble.md
    .claude/commands/dw/validate.md
    .claude/commands/dw/new-scenario.md
  </files>
  <action>
**assemble.md:**

```markdown
---
name: dw:assemble
description: 根据场景组装完整提示
argument-hint: "<scenario> [--context-level=standard] [--json]"
allowed-tools:
  - Read
  - Bash
  - Glob
---

<objective>
根据场景配置组装完整提示包，包含系统提示、上下文、场景提示。

支持输出格式：
- 默认：Markdown（直接可用）
- --json：JSON（含 token breakdown、trace）
</objective>

<execution_context>
@./.claude/data-warehouse/config/scenarios.yaml
@./.claude/data-warehouse/config/assembly-rules.yaml
</execution_context>

<process>
1. 解析场景参数
2. 调用组装脚本：
   ```bash
   cd .claude/data-warehouse && node scripts/assemble.js $ARGUMENTS
   ```
3. 返回组装结果
</process>
```

**validate.md:**

```markdown
---
name: dw:validate
description: 校验场景输入/输出是否符合规格
argument-hint: "<scenario> --input=<file> [--output=<file>] [--strict]"
allowed-tools:
  - Read
  - Bash
---

<objective>
校验用户输入或模型输出是否符合场景规格。

校验级别：
- CRITICAL：必填缺失 → 阻断
- WARNING：规范不符 → 警告
- INFO：建议 → 提示
</objective>

<process>
1. 解析参数
2. 调用校验脚本：
   ```bash
   cd .claude/data-warehouse && node scripts/validate.js $ARGUMENTS
   ```
3. 返回校验报告
</process>
```

**new-scenario.md:**

```markdown
---
name: dw:new-scenario
description: 创建新场景的脚手架文件
argument-hint: "<scenario-id> [--name=\"场景名称\"]"
allowed-tools:
  - Read
  - Write
  - Bash
---

<objective>
为新场景生成完整的脚手架文件，包括：
- prompt.md
- output-template.md
- input-template.md
- examples/ 目录
- JSON Schema

并自动更新配置文件。
</objective>

<process>
1. 调用脚手架脚本：
   ```bash
   cd .claude/data-warehouse && node scripts/scaffold.js $ARGUMENTS
   ```
2. 列出创建的文件
3. 提示下一步：填充具体内容
</process>
```
  </action>
  <verify>
    - 3 个工具命令文件存在
    - assemble.md 调用 scripts/assemble.js
    - validate.md 调用 scripts/validate.js
    - new-scenario.md 调用 scripts/scaffold.js
  </verify>
  <done>
    - assemble.md 提供 /dw:assemble 命令
    - validate.md 提供 /dw:validate 命令
    - new-scenario.md 提供 /dw:new-scenario 命令
  </done>
</task>

</tasks>

<verification>
- `.claude/commands/dw/` 目录包含 9 个命令文件
- 所有命令文件包含有效的 YAML frontmatter
- 场景命令引用对应的 prompt.md 和上下文
- 工具命令正确调用对应脚本
</verification>

<success_criteria>
- [ ] 9 个命令文件创建完成
- [ ] 命令格式与 `/gsd:*` 风格一致
- [ ] 场景命令的 execution_context 引用正确
- [ ] 工具命令正确调用辅助脚本
- [ ] 所有命令包含中文描述
</success_criteria>

<output>
After completion, create `.planning/phases/08-tooling/08-04-SUMMARY.md`
</output>
