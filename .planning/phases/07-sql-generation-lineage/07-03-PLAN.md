---
phase: 07-sql-generation-lineage
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .claude/data-warehouse/prompts/scenarios/generate-sql/examples/simple-select.md
  - .claude/data-warehouse/prompts/scenarios/generate-sql/examples/aggregation-with-join.md
  - .claude/data-warehouse/prompts/scenarios/generate-sql/examples/time-window-query.md
autonomous: true

must_haves:
  truths:
    - "案例展示完整的两段式交互（Stage 1 确认 + Stage 2 生成）"
    - "案例覆盖简单取数、聚合 JOIN、时间窗口三种场景"
    - "所有案例的 SQL 包含分区过滤和中文注释"
    - "每个案例包含 Validator 自检结果"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/examples/simple-select.md"
      provides: "简单取数案例"
      contains: "Stage 1|Stage 2|分区过滤|Validator"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/examples/aggregation-with-join.md"
      provides: "聚合 + JOIN 案例"
      contains: "LEFT JOIN|SCD2|GROUP BY"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/examples/time-window-query.md"
      provides: "时间窗口案例"
      contains: "DATE_SUB|动态日期|滚动窗口"
  key_links:
    - from: "examples/*.md"
      to: "prompt.md"
      via: "案例遵循主提示规范"
      pattern: "两段式交互"
    - from: "examples/*.md"
      to: "output-template.md"
      via: "案例输出遵循模板"
      pattern: "口径说明|性能提示|Validator"
---

<objective>
创建 SQL 生成场景的 3 个案例：简单取数、聚合 + JOIN、时间窗口查询。

Purpose: 为用户提供不同复杂度的参考案例，展示两段式交互和 Validator 自检。
Output: 3 个完整案例文件，覆盖简单、中等、复杂场景。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sql-generation-lineage/07-RESEARCH.md

# 本阶段已创建的文件（Wave 1 完成后）
@.claude/data-warehouse/prompts/scenarios/generate-sql/prompt.md
@.claude/data-warehouse/prompts/scenarios/generate-sql/output-template.md
@.claude/data-warehouse/prompts/scenarios/generate-sql/time-expressions.md

# 案例格式参考
@.claude/data-warehouse/prompts/scenarios/design-new-model/examples/e-commerce-order.md
@.claude/data-warehouse/prompts/scenarios/analyze-lineage/examples/table-level.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建简单取数案例 simple-select.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/examples/simple-select.md</files>
  <action>
创建一个简单的取数案例，展示基础的 SQL 生成流程：

**Frontmatter：**
```yaml
type: scenario-example
scenario: generate-sql
example: simple-select
complexity: simple
version: 1.0.0
```

**案例结构（参考已有案例格式）：**

1. **场景说明：**
   - 业务场景：获取最近 7 天的订单明细（单表查询，无 JOIN）
   - 复杂度：简单
   - 涉及需求：SQLGEN-01, SQLGEN-02, SQLGEN-03

2. **用户输入：**
```markdown
帮我写一个 SQL，获取最近 7 天的订单明细，包括订单号、客户ID、订单金额、订单状态。
数据来源是 dwd_fact_order_detail 表，分区字段是 dt（string 格式 yyyy-MM-dd）。
```

3. **Stage 1 响应（理解确认）：**
```markdown
## 取数需求理解确认

### 业务目标
- **取数目的：** 获取订单明细数据
- **输出粒度：** 一行代表一条订单明细
- **输出形态：** SELECT 查询（预览）

### 数据源
| 表名 | 类型 | 作用 | 关键字段 |
|------|------|------|----------|
| `dwd_fact_order_detail` | 主表 | 订单明细事实表 | `order_id, customer_id, order_amt, order_status, dt` |

### 分区与时间
- **分区字段：** dt（string，yyyy-MM-dd）
- **分区范围：** 最近 7 天（动态计算）
- **时间字段（业务口径）：** 与分区字段一致

### 过滤条件
- **业务过滤：** 无额外过滤
- **质量过滤：** 默认排除 is_deleted = 1

---

请确认以上理解是否正确，回复"**生成**"获取完整 SQL。
```

4. **Stage 2 响应（完整产物）：**

**生成的 SQL（含中文注释）：**
```sql
-- ===============================================
-- 查询名称：最近7天订单明细
-- 生成时间：{{ CURRENT_TIMESTAMP }}
-- 口径版本：v1.0
-- ===============================================

-- 取数口径：
-- 1. 从 dwd_fact_order_detail 读取最近 7 天的订单数据
-- 2. 排除已删除的记录（is_deleted = 0）
-- 3. 返回订单基础信息字段

SELECT
    order_id,                    -- 订单ID
    customer_id,                 -- 客户ID
    order_amt,                   -- 订单金额
    order_status,                -- 订单状态
    dt                           -- 分区日期
FROM dwd_fact_order_detail
WHERE 1=1
    -- 分区过滤（最近 7 天，动态计算）
    AND dt >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, 7), 'yyyy-MM-dd')
    AND dt <  DATE_FORMAT(DATE_ADD(CURRENT_DATE, 1), 'yyyy-MM-dd')
    -- 质量过滤
    AND is_deleted = 0
ORDER BY dt DESC, order_id
LIMIT 1000  -- 预览限制
;
```

**Validator 自检结果：**
```markdown
## 自检结果（Validator）

### P0（阻断）
- [x] V-P0-01 分区过滤缺失：✅ 已包含 dt 分区过滤
- [x] V-P0-02 分区谓词不可裁剪：✅ 使用裸字段比较，可正常裁剪

### P1（警告）
- 无

### P2（提示）
- [x] V-P2-01 已增加 LIMIT 1000 预览限制：✅
```

**口径说明：**（简化版）

**性能提示：**（简化版）

**依赖说明：**（简化版）

5. **案例要点：**
   - 单表查询，无 JOIN
   - 动态日期函数（DATE_SUB + DATE_FORMAT）
   - 分区过滤强制包含
   - Validator 自检通过

**Token 控制：** 目标 800-1000 tokens。
  </action>
  <verify>
- 文件存在且可读
- 包含 Stage 1 理解确认
- 包含 Stage 2 完整产物（SQL + Validator + 口径说明）
- SQL 包含分区过滤和中文注释
- 使用动态日期函数（非硬编码）
  </verify>
  <done>
simple-select.md 案例创建完成，展示简单取数的两段式交互流程。
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建聚合 + JOIN 案例 aggregation-with-join.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/examples/aggregation-with-join.md</files>
  <action>
创建一个中等复杂度的案例，涉及聚合计算和维表 JOIN：

**Frontmatter：**
```yaml
type: scenario-example
scenario: generate-sql
example: aggregation-with-join
complexity: medium
version: 1.0.0
```

**案例场景：**
- 业务场景：统计上月 VIP 用户的消费金额（按城市聚合）
- 复杂度：中等
- 涉及需求：SQLGEN-01 ~ SQLGEN-06
- 涉及 SCD2 语义确认

**用户输入：**
```markdown
我需要统计上月 VIP 用户的消费金额，按城市维度聚合。

数据源：
- 订单表：dwd_fact_order_detail（分区 dt，string 格式）
- 客户维表：dim_customer（SCD2，有 is_current 字段）
- 城市维表：dim_city

VIP 定义：customer_level = 'VIP'
排除已取消订单（order_status != 'CANCELLED'）
```

**Stage 1 响应：**
展示完整的理解确认，特别强调：
- SCD2 语义确认（is_current = 1 当前版本）
- 聚合维度确认（city_name）
- 分区范围确认（上月整月）

**Stage 2 响应：**

**生成的 SQL：**
```sql
-- ===============================================
-- 查询名称：上月VIP用户消费金额（按城市）
-- 生成时间：{{ CURRENT_TIMESTAMP }}
-- 口径版本：v1.0
-- ===============================================

-- 取数口径：
-- 1. 从 dwd_fact_order_detail 读取上月订单数据
-- 2. 关联 dim_customer 获取 VIP 用户（SCD2 当前版本）
-- 3. 关联 dim_city 获取城市名称
-- 4. 过滤 VIP 用户、排除取消订单
-- 5. 按城市聚合求和

SELECT
    c.city_name,                                    -- 城市名称
    COUNT(DISTINCT o.order_id) AS order_cnt,        -- 订单数
    SUM(o.order_amt) AS total_amt,                  -- 消费总额
    COUNT(DISTINCT o.customer_id) AS vip_user_cnt   -- VIP 用户数
FROM dwd_fact_order_detail o
-- 关联客户维表（SCD2 当前版本）
INNER JOIN dim_customer cust
    ON o.customer_id = cust.customer_id
    AND cust.is_current = 1
-- 关联城市维表
LEFT JOIN dim_city c
    ON cust.city_id = c.city_id
WHERE 1=1
    -- 分区过滤（上月整月，动态计算）
    AND o.dt >= DATE_FORMAT(ADD_MONTHS(TRUNC(CURRENT_DATE, 'MM'), -1), 'yyyy-MM-dd')
    AND o.dt <  DATE_FORMAT(TRUNC(CURRENT_DATE, 'MM'), 'yyyy-MM-dd')
    -- 业务过滤
    AND cust.customer_level = 'VIP'
    AND o.order_status != 'CANCELLED'
    AND o.is_deleted = 0
GROUP BY c.city_name
ORDER BY total_amt DESC
;
```

**Validator 自检结果：**
```markdown
## 自检结果（Validator）

### P0（阻断）
- [x] V-P0-01 分区过滤缺失：✅ 已包含 o.dt 分区过滤
- [x] V-P0-02 分区谓词不可裁剪：✅ 使用裸字段比较

### P1（警告）
- [x] V-P1-02 SCD2 语义已锁定：✅ 使用 is_current = 1（当前口径）

### P2（提示）
- [ ] V-P2-02 建议：如数据量大，可考虑先过滤再 JOIN
```

**口径说明：**（完整版，含 SCD2 处理说明）

**性能提示：**（含 JOIN 顺序优化建议）

**依赖说明：**（列出 3 个表及关键字段）

**案例要点：**
- 多表 JOIN（事实表 + 两个维表）
- SCD2 语义锁定（is_current = 1）
- 聚合计算（SUM、COUNT DISTINCT）
- 动态月份计算（ADD_MONTHS + TRUNC）
- Validator 完整检查
  </action>
  <verify>
- 文件存在且可读
- 包含多表 JOIN（至少 2 个 JOIN）
- SQL 包含 SCD2 语义处理（is_current = 1）
- 包含聚合计算（GROUP BY + 聚合函数）
- 分区过滤使用动态月份计算
- Validator 包含 V-P1-02 SCD2 检查
  </verify>
  <done>
aggregation-with-join.md 案例创建完成，展示聚合 + JOIN + SCD2 的完整流程。
  </done>
</task>

<task type="auto">
  <name>Task 3: 创建时间窗口案例 time-window-query.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/examples/time-window-query.md</files>
  <action>
创建一个涉及复杂时间窗口的案例：

**Frontmatter：**
```yaml
type: scenario-example
scenario: generate-sql
example: time-window-query
complexity: complex
version: 1.0.0
```

**案例场景：**
- 业务场景：计算用户最近 30 天的订单趋势（滚动窗口 + 日期维度）
- 复杂度：复杂
- 涉及需求：SQLGEN-01 ~ SQLGEN-06
- 涉及 dt + hour 二级分区处理

**用户输入：**
```markdown
我需要分析用户最近 30 天的日订单趋势，按日期维度展示每天的订单数和金额。

数据源：dwd_fact_order_detail
分区：dt（string, yyyy-MM-dd）+ hour（int, 0-23）
需要落表到 ads_daily_order_trend（按 dt 分区）

这是一个每天 T+1 执行的定时任务，需要可重复执行。
```

**Stage 1 响应：**
展示完整的理解确认，特别强调：
- 输出形态：INSERT OVERWRITE（落表）
- 分区细节：dt + hour 二级分区
- 幂等策略：每天重跑覆盖最近 30 天
- 时间表达：动态计算

**Stage 2 响应：**

**生成的 SQL：**
```sql
-- ===============================================
-- 查询名称：日订单趋势统计（最近30天滚动）
-- 生成时间：{{ CURRENT_TIMESTAMP }}
-- 口径版本：v1.0
-- 执行周期：每日 T+1
-- ===============================================

-- 取数口径：
-- 1. 从 dwd_fact_order_detail 读取最近 30 天的订单数据
-- 2. 按日期维度聚合，计算每天的订单数和金额
-- 3. 覆盖写入 ads_daily_order_trend 表

INSERT OVERWRITE TABLE ads_daily_order_trend
PARTITION (dt)
SELECT
    order_date,                                 -- 订单日期（业务时间）
    COUNT(DISTINCT order_id) AS order_cnt,      -- 订单数
    SUM(order_amt) AS total_amt,                -- 订单金额
    COUNT(DISTINCT customer_id) AS user_cnt,    -- 下单用户数
    AVG(order_amt) AS avg_order_amt,            -- 平均客单价
    order_date AS dt                            -- 分区字段
FROM dwd_fact_order_detail
WHERE 1=1
    -- 分区过滤（最近 30 天 + 1 天缓冲，动态计算）
    -- 注意：分区范围略大于业务时间范围，覆盖跨天订单
    AND dt >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, 31), 'yyyy-MM-dd')
    AND dt <  DATE_FORMAT(DATE_ADD(CURRENT_DATE, 1), 'yyyy-MM-dd')
    -- 业务时间过滤（精确 30 天）
    AND order_date >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, 30), 'yyyy-MM-dd')
    AND order_date <  DATE_FORMAT(CURRENT_DATE, 'yyyy-MM-dd')
    -- 质量过滤
    AND is_deleted = 0
    AND order_status != 'CANCELLED'
GROUP BY order_date
;
```

**Validator 自检结果：**
```markdown
## 自检结果（Validator）

### P0（阻断）
- [x] V-P0-01 分区过滤缺失：✅ 已包含 dt 分区过滤
- [x] V-P0-02 分区谓词不可裁剪：✅ 使用裸字段比较

### P1（警告）
- [x] V-P1-04 时间口径说明：✅ 分区窗口（31天）覆盖业务窗口（30天），已在口径说明中声明

### P2（提示）
- 无
```

**口径说明：**（完整版，含分区覆盖策略说明）

**性能提示：**（含分区数估算、执行时间预估）

**依赖说明：**

**案例要点：**
- INSERT OVERWRITE 落表模式
- 分区覆盖策略（分区窗口 > 业务窗口）
- 可重复执行（幂等性）
- 动态日期函数
- 双重时间过滤（分区 + 业务时间）
  </action>
  <verify>
- 文件存在且可读
- SQL 使用 INSERT OVERWRITE（落表模式）
- 包含分区覆盖策略说明
- 使用动态日期函数（DATE_SUB + DATE_FORMAT）
- 包含双重时间过滤（分区 dt + 业务时间 order_date）
- Validator 包含 V-P1-04 时间口径检查
  </verify>
  <done>
time-window-query.md 案例创建完成，展示复杂时间窗口和落表模式的完整流程。
  </done>
</task>

</tasks>

<verification>
1. 目录结构验证：
   ```bash
   ls -la .claude/data-warehouse/prompts/scenarios/generate-sql/examples/
   ```
   预期输出：simple-select.md, aggregation-with-join.md, time-window-query.md

2. 案例完整性验证：
   - 每个案例包含：场景说明、用户输入、Stage 1、Stage 2
   - Stage 2 包含：SQL + Validator + 口径说明 + 性能提示 + 依赖说明

3. 复杂度覆盖验证：
   - 简单：单表查询
   - 中等：多表 JOIN + 聚合 + SCD2
   - 复杂：时间窗口 + 落表 + 分区覆盖
</verification>

<success_criteria>
1. 3 个案例文件全部创建完成
2. 每个案例展示完整的两段式交互
3. 所有 SQL 包含分区过滤和中文注释
4. 每个案例包含 Validator 自检结果
5. 案例复杂度覆盖简单、中等、复杂三个级别
</success_criteria>

<output>
After completion, create `.planning/phases/07-sql-generation-lineage/07-03-SUMMARY.md`
</output>
