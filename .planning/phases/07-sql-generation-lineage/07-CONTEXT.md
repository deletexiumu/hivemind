# Phase 7: SQL 生成 + 血缘增强 - Context

**Gathered:** 2026-02-01
**Status:** Ready for planning

<domain>
## Phase Boundary

实现"生成导数 SQL"场景的完整提示系统，包括：
1. **SQL 生成**：根据取数口径/过滤/时间窗，输出 Hive SQL + 口径说明 + 性能提示 + 依赖说明
2. **血缘增强**：识别 JOIN 关联关系、输出 Mermaid 格式血缘图、支持变更影响评估

已有基础（Phase 6 已完成）：
- 表级/字段级血缘分析（LINEAGE-01 ~ LINEAGE-03）
- 精度等级标记（A/B/C/D）
- dbt ref()/source() 识别

本阶段增强：
- SQL 生成场景（SQLGEN-01 ~ SQLGEN-06）
- 血缘增强能力（LINEAGE-04 ~ LINEAGE-06）

</domain>

<decisions>
## Implementation Decisions

### SQL 生成交互模式
- 采用**两段式交互**（与 Phase 4-6 一致）
  - Stage 1：确认理解（表、字段、分区范围、过滤条件、粒度、聚合方式）
  - Stage 2：生成完整 SQL 及配套文档
- **必确认项（全部）**：
  - 数据源表 + 关键字段
  - 分区范围 + 过滤条件
  - 粒度说明 + 聚合方式
- **缺失信息处理**：智能推断 + Stage 1 确认
  - 根据上下文推断合理默认值（如时间窗口、过滤条件）
  - 在 Stage 1 明确展示推断结果，让用户确认
- **时间表达处理**：使用动态计算
  - "最近 N 天"、"上月"等相对时间 → 生成 `DATE_SUB(CURRENT_DATE, N)` 等动态表达式
  - SQL 可重复执行，无需修改日期

### SQL 输出规范
- **注释密度**：Claude 自行决定
  - 根据 SQL 复杂度动态调整
  - 简单 SQL 精简注释，复杂 SQL 逻辑块注释
- **分区过滤强制**：警告 + 生成
  - 如果 SQL 缺少分区过滤条件，生成 SQL 但添加醒目警告标记
  - 警告位于 SQL 开头，注明全表扫描风险
- **代码风格**：Claude 自行决定
  - 遵循业界最佳实践（大写关键字、格式对齐等）
- **口径说明文档**：完整档案级
  - 计算步骤描述
  - 数据源（涉及的表和字段）
  - 假设和限制（数据新鲜度、已排除的数据等）
  - 版本和更新记录

### 性能提示深度
- **内容范围**：风险提示 + 优化建议
  - 识别大表 JOIN、全表扫描、笛卡尔积等风险
  - 给出具体优化方向（JOIN 顺序、分区裁剪等）
- **建议详细度**：提供具体代码片段
  - 不只是方向性建议
  - 直接给出优化后的 SQL 片段或改写示例
- **性能问题处理**：用户选择
  - 当检测到明显性能问题（如笛卡尔积）时
  - 同时提供原始版本和优化版本
  - 让用户选择是否接受风险或采用优化版

### 血缘分析精度
- **输出级别**：表级与字段级同等重要
  - 两个级别都完整展示
  - 表级作为总览，字段级作为详细映射
- **复杂 SQL 处理**：最大努力 + 置信度标记
  - 对复杂窗口函数、动态 SQL 等尽力分析
  - 使用精度等级标记（A/B/C/D，延续 Phase 6 决策）
  - D 级标记"需人工确认"
- **影响追踪层级**：全链路
  - 递归追踪所有受影响的下游，直到末端表
  - 按层级展示（一级下游、二级下游、...）
- **影响评估内容**：风险评估 + 处理建议
  - 列出所有受影响的表/字段
  - 标记每个下游的影响等级（高/中/低）
  - 给出具体操作建议（需重跑/需修改/需验证等）

### Claude's Discretion
- SQL 注释密度和位置
- SQL 代码格式化风格
- 推断缺失信息时的具体默认值
- 性能提示中资源估算的精度

</decisions>

<specifics>
## Specific Ideas

- 两段式交互已在 Phase 4-6 验证成熟，保持一致体验
- 动态时间表达确保 SQL 可重复执行（如定时任务）
- 警告 + 生成策略平衡安全性和灵活性（有时用户确实需要全表扫描）
- 全链路影响追踪支持数仓变更的完整影响评估

</specifics>

<deferred>
## Deferred Ideas

None — 讨论保持在阶段范围内

</deferred>

---

*Phase: 07-sql-generation-lineage*
*Context gathered: 2026-02-01*
