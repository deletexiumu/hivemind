---
phase: 07-sql-generation-lineage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/data-warehouse/prompts/scenarios/generate-sql/prompt.md
  - .claude/data-warehouse/prompts/scenarios/generate-sql/output-template.md
  - .claude/data-warehouse/prompts/scenarios/generate-sql/time-expressions.md
autonomous: true

must_haves:
  truths:
    - "用户输入取数口径/过滤/时间窗，系统生成 Hive SQL + 配套文档"
    - "生成的 SQL 强制包含分区过滤条件，缺失时有警告机制"
    - "SQL 附带中文注释说明计算逻辑"
    - "输出包含口径说明、性能提示、依赖说明、Validator 自检"
  artifacts:
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/prompt.md"
      provides: "SQL 生成主提示（两段式交互）"
      contains: "Stage 1|Stage 2|分区过滤|Validator"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/output-template.md"
      provides: "SQL 生成输出模板（完整套件）"
      contains: "口径说明|性能提示|依赖说明|自检结果"
    - path: ".claude/data-warehouse/prompts/scenarios/generate-sql/time-expressions.md"
      provides: "动态时间表达速查表"
      contains: "DATE_SUB|TRUNC|ADD_MONTHS"
  key_links:
    - from: "prompt.md"
      to: "output-template.md"
      via: "Stage 2 输出引用模板"
      pattern: "output-template"
    - from: "prompt.md"
      to: "time-expressions.md"
      via: "时间表达转换引用"
      pattern: "time-expressions"
---

<objective>
创建 SQL 生成场景的核心提示系统：主提示（两段式交互）、输出模板（含 Validator）、动态时间表达速查表。

Purpose: 实现 SQLGEN-01 ~ SQLGEN-06 需求的核心提示架构，为后续案例库提供基础。
Output: 3 个核心文件，构成完整的 SQL 生成提示系统。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sql-generation-lineage/07-RESEARCH.md

# 已有场景提示参考（保持一致性）
@.claude/data-warehouse/prompts/scenarios/design-new-model/prompt.md
@.claude/data-warehouse/prompts/scenarios/analyze-lineage/prompt.md
@.claude/data-warehouse/prompts/scenarios/analyze-lineage/output-template.md

# 上下文文件参考
@.claude/data-warehouse/context/platform/hive-constraints-core.md
@.claude/data-warehouse/context/layers/layering-system-core.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建 SQL 生成主提示 prompt.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/prompt.md</files>
  <action>
创建 SQL 生成场景的主提示文件，遵循 Research 文档的架构设计：

**Frontmatter 结构：**
```yaml
type: scenario-prompt
scenario: generate-sql
version: 1.0.0
token_budget: 1400
includes:
  - context/platform/hive-constraints-core
  - context/layers/layering-system-core
  - docs/naming-core
```

**核心内容（按 Research 07-RESEARCH.md 要求）：**

1. **INSTRUCTIONS 部分：**
   - 角色：高级 SQL 工程师 / Hive SQL 专家
   - 核心任务：根据取数口径生成 Hive SQL + 配套文档
   - 两段式交互说明（Stage 1 确认理解，Stage 2 生成完整产物）

2. **Stage 1 必问项清单（来自 Research）：**
   A. 取数目标：业务目标、输出粒度、输出形态、目标表、幂等策略
   B. 数据源：主表、关联表、关键时间字段、分区字段
   C. 分区细节：分区列清单、dt 类型/格式、hour 类型/范围、覆盖策略
   D. 时间范围：分区范围、时间粒度、时间表达
   E. 过滤与口径：业务过滤、数据质量过滤、VIP/有效口径、去重口径
   F. 维表/SCD2 语义：SCD2 取数语义、as-of 对齐字段、JOIN key 唯一性
   G. 计算逻辑：聚合函数、COUNT DISTINCT、分组维度、异常处理
   H. 成本约束：期望返回行数、是否允许大范围扫描、抽样需求

3. **决策指导原则：**
   - 分区过滤强制（缺失则警告 + 追问）
   - 动态时间表达优先（避免硬编码日期）
   - SCD2 语义必须锁定（is_current vs as-of）
   - Hive 3.x 语法优先

4. **TASK 部分（输入/输出说明）：**
   - 必填输入：取数需求描述
   - 可选输入：源表结构、分区信息、SCD2 字段
   - Stage 1 输出：确认理解（表、字段、分区范围、过滤条件、粒度）
   - Stage 2 输出：SQL + 口径说明 + 性能提示 + 依赖说明 + Validator

5. **Validator 检查清单（来自 Research）：**
   - P0（阻断）：V-P0-01 ~ V-P0-05（分区过滤缺失、谓词不可裁剪、类型不匹配、笛卡尔积、Hive 不支持）
   - P1（警告）：V-P1-01 ~ V-P1-04（JOIN 放大、SCD2 未锁定、聚合一致性、时间口径）
   - P2（提示）：V-P2-01 ~ V-P2-02（可运行性、性能建议）

6. **输出交付契约：**
   - 使用 `### File: {path}` 格式
   - 便于后续工具化自动落盘

**格式参考：** 保持与 design-new-model/prompt.md 和 analyze-lineage/prompt.md 一致的风格。

**Token 控制：** 目标 1300-1400 tokens。

**不要手写日期函数：** 引用 time-expressions.md 速查表。
  </action>
  <verify>
- 文件存在且可读
- 包含 frontmatter（type、scenario、version、token_budget、includes）
- 包含两段式交互说明（Stage 1 / Stage 2）
- 包含 8 类必问项清单（A-H）
- 包含 Validator 检查清单（P0/P1/P2）
- Token 预算符合规范（< 1500）
  </verify>
  <done>
prompt.md 文件创建完成，包含完整的两段式交互模式、8 类必问项、Validator 检查清单。
  </done>
</task>

<task type="auto">
  <name>Task 2: 创建 SQL 生成输出模板 output-template.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/output-template.md</files>
  <action>
创建 SQL 生成场景的输出模板文件，包含完整的 Stage 1 和 Stage 2 输出格式：

**Frontmatter 结构：**
```yaml
type: scenario-support
scenario: generate-sql
document: output-template
version: 1.0.0
token_budget: 900
```

**Stage 1 输出模板（理解确认）：**

```markdown
## 取数需求理解确认

### 业务目标
- **取数目的：** {用途描述}
- **输出粒度：** {一行代表什么}
- **输出形态：** {SELECT / INSERT OVERWRITE / CTAS}

### 数据源
| 表名 | 类型 | 作用 | 关键字段 |
|------|------|------|----------|
| `{table}` | 主表/维表 | {role} | `{fields}` |

### 分区与时间
- **分区字段：** {dt 类型/格式，是否有 hour}
- **分区范围：** {时间窗表达}
- **时间字段（业务口径）：** {order_time / create_date}

### 过滤条件
- **业务过滤：** {status = 'completed'}
- **质量过滤：** {is_deleted = 0}

### SCD2 语义（如有维表）
- **取数语义：** {is_current = 1 / as-of 历史口径}
- **对齐字段：** {order_time 对齐维表有效期}

### 计算逻辑
- **聚合方式：** {SUM / COUNT DISTINCT / AVG}
- **分组维度：** {GROUP BY fields}

---

请确认以上理解是否正确，或补充/修正信息后，回复"**生成**"获取完整 SQL。
```

**Stage 2 输出模板（完整产物）：**

参考 Research 中的 Pattern 4（SQL Output Bundle），包含：

1. **生成的 SQL（带中文注释）：**
```sql
-- ===============================================
-- 查询名称：{query_name}
-- 生成时间：{{ CURRENT_TIMESTAMP }}
-- 口径版本：v1.0
-- ===============================================

-- 取数口径：
-- 1. {step_1}
-- 2. {step_2}
-- ...

SELECT ...
```

2. **自检结果（Validator）：**（来自 Research Pattern 7）
```markdown
## 自检结果（Validator）

### P0（阻断）
- [x] V-P0-01 分区过滤缺失：✅ 已包含 {partition_column} 分区过滤
- [x] V-P0-02 分区谓词不可裁剪：✅ 使用裸字段比较

### P1（警告）
- [ ] V-P1-01 JOIN 放大风险：{details}

### P2（提示）
- [ ] V-P2-01 建议增加 LIMIT：{details}

### 修复建议（可复制片段）
{如有 P0/P1 问题，提供修复代码}
```

3. **口径说明文档：**（来自 Research）
```markdown
## 口径说明

### 1. 计算步骤
### 2. 数据源
### 3. 假设和限制
### 4. 版本记录
```

4. **性能提示：**
```markdown
## 性能提示

### 风险识别
### 优化建议
### 资源估算
```

5. **依赖说明：**
```markdown
## 依赖说明

### 表依赖
### 字段依赖
### 外键关系
```

**Token 控制：** 目标 800-900 tokens。
  </action>
  <verify>
- 文件存在且可读
- 包含 frontmatter
- 包含 Stage 1 输出模板（理解确认）
- 包含 Stage 2 输出模板（SQL + Validator + 口径说明 + 性能提示 + 依赖说明）
- Validator 模板包含 P0/P1/P2 三个级别
  </verify>
  <done>
output-template.md 文件创建完成，包含完整的 Stage 1 / Stage 2 输出格式和 Validator 模板。
  </done>
</task>

<task type="auto">
  <name>Task 3: 创建动态时间表达速查表 time-expressions.md</name>
  <files>.claude/data-warehouse/prompts/scenarios/generate-sql/time-expressions.md</files>
  <action>
创建动态时间表达速查表，供 SQL 生成时引用，避免硬编码日期：

**Frontmatter 结构：**
```yaml
type: scenario-support
scenario: generate-sql
document: time-expressions
version: 1.0.0
token_budget: 450
```

**核心内容（来自 Research Standard Stack + Pattern 3）：**

1. **时间表达转换表：**

| 自然语言 | Hive 表达式（dt 为 string yyyy-MM-dd） | 说明 |
|----------|----------------------------------------|------|
| 今天 | `CURRENT_DATE` | 当前日期 |
| 昨天 | `DATE_SUB(CURRENT_DATE, 1)` | T-1 |
| 最近 N 天 | `dt >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, N), 'yyyy-MM-dd')` | 滚动窗口 |
| 本周（周一至今） | `dt >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, PMOD(DATEDIFF(CURRENT_DATE, '1900-01-01') - 1, 7)), 'yyyy-MM-dd')` | 周一开始 |
| 本月 | `dt >= DATE_FORMAT(TRUNC(CURRENT_DATE, 'MM'), 'yyyy-MM-dd')` | 当月第一天至今 |
| 上月 | `dt >= DATE_FORMAT(ADD_MONTHS(TRUNC(CURRENT_DATE, 'MM'), -1), 'yyyy-MM-dd') AND dt < DATE_FORMAT(TRUNC(CURRENT_DATE, 'MM'), 'yyyy-MM-dd')` | 上月整月 |
| 本季度 | `dt >= DATE_FORMAT(TRUNC(CURRENT_DATE, 'Q'), 'yyyy-MM-dd')` | 当季第一天至今 |
| 本年 | `dt >= DATE_FORMAT(TRUNC(CURRENT_DATE, 'YY'), 'yyyy-MM-dd')` | 当年第一天至今 |

2. **dt 类型适配表：**

| dt 类型 | 格式 | 推荐谓词写法 |
|---------|------|--------------|
| string | `yyyy-MM-dd` | `dt >= DATE_FORMAT(DATE_SUB(CURRENT_DATE, N), 'yyyy-MM-dd')` |
| int | `yyyyMMdd` | `dt >= CAST(DATE_FORMAT(DATE_SUB(CURRENT_DATE, N), 'yyyyMMdd') AS INT)` |

3. **dt + hour 二级分区模板：**

```sql
-- 规则：dt/hour 必须"裸字段比较常量"
WHERE (
        dt >  {start_dt}
     OR (dt = {start_dt} AND hour >= {start_hour})
      )
  AND (
        dt <  {end_dt}
     OR (dt = {end_dt} AND hour <  {end_hour})
      )
```

4. **禁止写法（会破坏裁剪）：**

```sql
-- ❌ 对分区列做函数
WHERE to_date(dt) >= DATE_SUB(CURRENT_DATE, 7)

-- ❌ 对分区列 CAST
WHERE cast(dt as date) >= CURRENT_DATE

-- ❌ LIKE 命中分区列
WHERE dt like '2026-02%'
```

5. **Hive 3.x 关键日期函数：**

| 函数 | 用途 | 示例 |
|------|------|------|
| `DATE_SUB(date, N)` | 日期减 N 天 | `DATE_SUB(CURRENT_DATE, 7)` |
| `DATE_ADD(date, N)` | 日期加 N 天 | `DATE_ADD(CURRENT_DATE, 1)` |
| `TRUNC(date, 'MM')` | 截断到月初 | `TRUNC(CURRENT_DATE, 'MM')` |
| `TRUNC(date, 'Q')` | 截断到季初 | `TRUNC(CURRENT_DATE, 'Q')` |
| `ADD_MONTHS(date, N)` | 加减 N 月 | `ADD_MONTHS(CURRENT_DATE, -1)` |
| `LAST_DAY(date)` | 月末 | `LAST_DAY(ADD_MONTHS(CURRENT_DATE, -1))` |
| `DATE_FORMAT(date, fmt)` | 格式化 | `DATE_FORMAT(CURRENT_DATE, 'yyyy-MM-dd')` |

**Token 控制：** 目标 400-450 tokens。
  </action>
  <verify>
- 文件存在且可读
- 包含 frontmatter
- 包含时间表达转换表（至少 8 种常见表达）
- 包含 dt 类型适配表（string / int）
- 包含 dt + hour 二级分区模板
- 包含禁止写法示例
  </verify>
  <done>
time-expressions.md 文件创建完成，包含完整的动态时间表达转换表和分区谓词模板。
  </done>
</task>

</tasks>

<verification>
1. 目录结构验证：
   ```bash
   ls -la .claude/data-warehouse/prompts/scenarios/generate-sql/
   ```
   预期输出：prompt.md, output-template.md, time-expressions.md

2. 文件完整性验证：
   - prompt.md 包含 Stage 1/Stage 2、8 类必问项、Validator 清单
   - output-template.md 包含完整的输出格式（SQL + 5 个配套文档）
   - time-expressions.md 包含 8+ 时间表达转换

3. Token 预算验证：
   - prompt.md < 1500 tokens
   - output-template.md < 1000 tokens
   - time-expressions.md < 500 tokens
</verification>

<success_criteria>
1. 3 个核心文件全部创建完成
2. prompt.md 实现两段式交互模式，包含 8 类必问项
3. output-template.md 包含 Stage 1（确认）+ Stage 2（完整产物 + Validator）
4. time-expressions.md 包含动态时间表达转换表
5. 所有文件遵循已有场景提示的格式风格
6. Token 预算符合规范
</success_criteria>

<output>
After completion, create `.planning/phases/07-sql-generation-lineage/07-01-SUMMARY.md`
</output>
