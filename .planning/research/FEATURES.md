# 特性全景：数仓提示系统六大场景

**领域:** 数仓提示系统 (Hive + dbt + Kimball)
**研究日期:** 2026-01-30
**置信度:** MEDIUM（基于领域最佳实践与 dbt 官方文档）

---

## 场景概览

| 场景 | 输入 | 输出 | 复杂度 |
|------|------|------|--------|
| 1. 评审已有模型 | 模型 SQL / dbt 配置 / DDL / **样例数据** | 问题清单 + 严重级别 + 修复建议 | 中等 |
| 2. 设计新模型 | 业务事件 / 指标 / 粒度 / **样例数据** | 星型设计 + 事实/维度定义 + SCD策略 + 分层落点 | 高 |
| 3. 生成导数 SQL | 取数口径 / 过滤 / 时间窗 / **样例数据** | 符合规范的 SQL + 口径说明 + 性能提示 | 中等 |
| 4. 指标口径定义 | 业务需求 / 指标描述 / **样例数据** | 原子指标 + 派生指标 + 计算逻辑 + 版本管理 | 中等 |
| 5. 生成 DQ 规则 | 模型/表定义 / **样例数据** | dbt test 配置 + 自定义检测 SQL | 低-中 |
| 6. 数据血缘分析 | SQL / dbt 模型 | 字段级血缘 + 影响评估 + 变更传导 | 高 |

---

## 样例数据规范（Codex 讨论确认）

### 为什么样例数据重要

样例数据是验证模型设计正确性的关键输入，没有样例数据难以：
- 验证粒度是否一致、是否会重复计数
- 验证维度退化/桥表/多值维的处理是否正确
- 验证口径边界（状态、时间窗、去重规则）

### 样例数据组织方式

**原则：最小可复现用例（5-30行），非真实切片**

每个用例由三部分构成：

| 目录 | 内容 | 说明 |
|------|------|------|
| `input/` | 上游表样例（ODS/DWD 输入） | CSV 格式，覆盖边界条件 |
| `spec/` | 业务规则与口径 | YAML 格式，指标/维度含义、过滤、去重、时间字段 |
| `expected/` | 期望输出（DWS/ADS 结果） | CSV 格式，关键字段/关键聚合值 |

**边界条件覆盖清单：**
- 重复记录
- 缺失值/NULL
- 跨天/跨分区
- 状态变更
- 晚到数据
- 异常值

### 场景样例需求矩阵

| 场景 | 需要样例 | 样例类型 | 说明 |
|------|----------|----------|------|
| 评审已有模型 | **强烈建议** | 输入表+期望输出 | 验证粒度、JOIN、口径 |
| 设计新模型 | **强烈建议** | 输入表+期望输出 | 验证设计方案可行性 |
| 生成导数 SQL | **强烈建议** | 输入表+期望输出 | 验证 SQL 正确性 |
| 指标口径定义 | **强烈建议** | 输入表+期望输出 | 验证口径计算逻辑 |
| 生成 DQ 规则 | **建议** | 输入表（含脏数据） | 验证 DQ 规则有效性 |
| 数据血缘分析 | **可选** | dbt 项目结构样例 | 模型依赖图即可 |

### 样例目录结构示例

```
examples/
├── model_design/
│   └── order_star_01/
│       ├── input/
│       │   ├── ods_orders.csv
│       │   └── ods_order_items.csv
│       ├── spec/
│       │   └── spec.yml          # 粒度/键/口径/边界条件
│       └── expected/
│           └── dws_order_item_f.csv
├── model_review/
│   └── dim_customer_01/
│       ├── input/
│       │   └── ods_customers.csv
│       ├── model/
│       │   └── dim_customer.sql  # 待评审模型
│       └── expected/
│           └── issues.yml        # 期望发现的问题
└── sql_gen/
    └── gmv_daily_01/
        ├── input/
        │   └── dws_order_item_f.csv
        ├── spec/
        │   └── query_spec.yml    # 取数口径
        └── expected/
            └── result.csv
```

### 样例数据注意事项

| 风险 | 预防措施 |
|------|----------|
| 维护成本高 | 样例当作回归资产，能跑则跑（dbt seeds） |
| 隐私合规 | 必须脱敏，只保留结构与边界，不保留真实值分布 |
| 误导性 | 显式标注"仅验证语义，不代表性能" |

---

## 跨场景统一输入契约（Context Contract）

所有场景共享的最小必需信息集合，确保输入一致性：

### 必需信息

| 字段 | 说明 | 示例 |
|------|------|------|
| **目标层级** | ODS/DWD/DWS/ADS | `DWS` |
| **分区字段** | 时间分区字段名 | `dt` 或 `ds` |
| **分区周期** | T+1/T+0/小时级 | `T+1` |
| **grain声明** | 事实表粒度一句话描述 | "每笔订单明细一行" |
| **主键字段** | 唯一标识字段 | `order_id, item_id` |
| **时间口径字段** | 业务时间选择 | `pay_time`（非create_time） |
| **增量策略** | append/insert_overwrite | `insert_overwrite` |

### 可选信息

| 字段 | 说明 | 示例 |
|------|------|------|
| **晚到数据策略** | 延迟N天的处理方式 | "回刷最近7天分区" |
| **回刷窗口** | 历史数据修正范围 | "最近30天" |
| **去重规则** | 重复数据处理 | "按order_id取最新" |
| **代理键策略** | 维表主键生成方式 | `dbt_utils.generate_surrogate_key` |
| **SCD策略** | 维度变化处理 | "地址用Type2，名称用Type1" |

### 输入模板示例

```yaml
# context_contract.yml
target_layer: DWS
partition:
  field: dt
  granularity: daily
  schedule: T+1
grain: "每笔已支付订单明细一行"
primary_key: [order_id, item_id]
time_field: pay_time  # 业务时间口径
incremental_strategy: insert_overwrite
late_data:
  enabled: true
  lookback_days: 7
  action: "回刷受影响分区"
backfill_window_days: 30
```

---

## 场景 1: 评审已有模型

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| 模型 SQL | 是 | `.sql` 文件内容 | dbt model 或原始 SQL |
| dbt 配置 | 否 | `schema.yml` 片段 | 包含列定义、测试配置 |
| DDL | 否 | Hive DDL | 目标表结构定义 |
| 业务上下文 | 否 | 自然语言 | 模型用途、业务背景 |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| 问题清单 | Markdown 表格 | 编号 + 问题描述 + 位置定位 |
| 严重级别 | P0/P1/P2/P3 | P0=阻断性，P3=建议性 |
| 修复建议 | 代码片段 + 说明 | 每个问题对应修复方案 |
| 评审摘要 | 结构化文本 | 总体评价 + 通过/不通过判定 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **命名规范检查** | 命名是数仓治理的基础，不合规命名导致理解困难、维护成本高 | 低 |
| **分层合规检查** | ODS/DWD/DWS/ADS 跨层引用是常见反模式，必须检测 | 低 |
| **主键/粒度验证** | 事实表粒度不清是维度建模最严重问题 | 中 |
| **字段类型合理性** | 类型错误导致隐式转换、性能问题、精度丢失 | 低 |
| **注释完整性** | 无注释的字段是技术债，阻碍知识传承 | 低 |
| **dbt 配置完整性** | 缺少 description、tests 是治理不合格的标志 | 低 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **Kimball 建模合规评分** | 量化评估维度建模成熟度，提供改进路径 | 高 |
| **性能反模式检测** | 识别笛卡尔积、大表 JOIN 顺序错误、缺失分区过滤 | 高 |
| **业务语义一致性检查** | 对比数据字典，检测字段含义偏离 | 中 |
| **SCD 策略建议** | 根据维度特征自动推荐 SCD 类型 | 中 |
| **增量策略评估** | 分析增量逻辑正确性，识别数据漏录/重复风险 | 高 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **自动修复代码** | 自动修复可能引入新问题，需人工审核 | 提供修复建议，由人工执行 |
| **执行 SQL 验证** | 需要连接生产环境，超出提示系统范围 | 提供静态分析，真实验证由 dbt test 完成 |
| **多数据库方言支持** | 本版本聚焦 Hive，扩展方言增加复杂度 | 抽象核心逻辑，未来可扩展 |

---

## 场景 2: 设计新模型

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| 业务事件描述 | 是 | 自然语言 | 要建模的业务过程 |
| 分析维度 | 是 | 列表 | 需要支持的分析切面 |
| 核心指标 | 是 | 列表 | 需要度量的业务指标 |
| 数据粒度 | 否 | 说明 | 期望的最细粒度 |
| 源表信息 | 否 | DDL 或描述 | 可用的数据源 |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| 星型模型设计 | 图 + 文字 | 事实表 + 维度表关系 |
| 事实表定义 | DDL + schema.yml | 包含粒度声明、度量字段 |
| 维度表定义 | DDL + schema.yml | 包含 SCD 策略、自然键/代理键 |
| 分层落点建议 | 结构化说明 | DWD/DWS 层级分配及理由 |
| ETL 逻辑概要 | 伪代码 / dbt 模板 | 数据流转逻辑 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **事实表粒度声明** | 粒度是维度建模的核心，必须明确定义 | 低 |
| **维度表识别** | 从业务需求中提取维度是基本能力 | 中 |
| **主键设计** | 代理键 vs 自然键选择影响后续扩展 | 中 |
| **分层映射** | ODS/DWD/DWS/ADS 落点决定依赖链 | 低 |
| **标准字段模板** | etl_date、is_deleted 等标准字段必须包含 | 低 |
| **dbt 模型模板** | 输出可直接使用的 dbt model 骨架 | 中 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **SCD 策略智能推荐** | 根据维度变化特征自动推荐 Type 1/2/3 | 高 |
| **退化维度识别** | 自动识别应退化到事实表的低基数维度 | 中 |
| **一致性维度复用建议** | 推荐已有维度表，避免维度孤岛 | 高 |
| **增量策略设计** | 根据数据特征设计 incremental 策略 | 高 |
| **多粒度事实表规划** | 支持原子+聚合事实表的层级设计 | 高 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **全自动生成可执行 DDL** | 不同环境配置差异大，需人工调整 | 生成 dbt model 模板，由用户完善 |
| **可视化 ER 图** | 需要图形渲染能力，超出提示系统范围 | 提供 Mermaid 格式文本图 |
| **物理设计优化** | 分区/分桶策略依赖实际数据分布，需 DBA 决策 | 提供建议，不做最终决策 |

---

## 场景 3: 生成导数 SQL

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| 取数口径描述 | 是 | 自然语言 | 要查询的业务指标/维度 |
| 过滤条件 | 否 | 条件列表 | 业务筛选条件 |
| 时间窗口 | 否 | 日期范围 | 数据时间范围 |
| 目标表/模型 | 否 | 表名列表 | 数据来源表 |
| 输出格式 | 否 | 说明 | 期望的结果结构 |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| 查询 SQL | Hive SQL | 完整可执行 SQL |
| 口径说明 | 结构化文本 | 指标定义 + 计算逻辑解释 |
| 性能提示 | 列表 | 优化建议、预估扫描量 |
| 依赖说明 | 列表 | 涉及的表和关键字段 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **分区过滤强制** | Hive 全表扫描是生产事故级问题 | 低 |
| **JOIN 语法正确** | 多表关联是 SQL 生成的核心能力 | 中 |
| **聚合逻辑正确** | SUM/COUNT/AVG 等聚合语义准确 | 中 |
| **时间函数正确** | Hive 时间函数语法与标准 SQL 有差异 | 低 |
| **注释生成** | 每段逻辑附带中文注释，便于理解 | 低 |
| **口径说明文档** | 解释"为什么这样算"，便于业务确认 | 低 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **性能优化建议** | 自动识别大表 JOIN 顺序、分区裁剪机会 | 高 |
| **多方言适配** | 同一口径生成 Hive/Spark SQL/Presto 版本（v2可选，需验证） | 中 |
| **增量口径生成** | 支持生成增量计算逻辑（如 T+1 增量汇总） | 高 |
| **SQL 复杂度评估** | 预估执行成本，提示是否需要拆分 | 中 |
| **CTE 结构化输出** | 复杂查询自动拆分为可读的 WITH 语句 | 中 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **实时执行 SQL** | 需要数据库连接，超出提示系统范围 | 生成 SQL，由用户在平台执行 |
| **数据结果预览** | 需要访问实际数据 | 提供示例数据说明 |
| **跨数据源联邦查询** | 复杂度高，依赖基础设施 | 聚焦单数据源 Hive SQL |

---

## 场景 4: 指标口径定义

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| 指标名称 | 是 | 文本 | 中文业务名称 |
| 业务描述 | 是 | 自然语言 | 指标的业务含义 |
| 计算逻辑 | 否 | 公式/描述 | 初步的计算思路 |
| 适用场景 | 否 | 列表 | 指标使用场景 |
| 关联指标 | 否 | 列表 | 已有的相关指标 |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| 指标卡片 | 结构化 YAML | 完整指标定义 |
| 原子指标分解 | 列表 | 基础指标组件 |
| 派生指标定义 | 列表 | 时间周期 + 维度组合 |
| dbt Semantic Layer 配置 | YAML | MetricFlow 格式定义 |
| 口径说明文档 | Markdown | 业务可读的口径解释 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **指标唯一标识** | 防止指标重复定义、同名歧义 | 低 |
| **原子/派生/复合分类** | 指标体系的基础分层 | 低 |
| **计算公式标准化** | 消除口径歧义的核心 | 中 |
| **数据来源追溯** | 指标必须能追溯到源表/字段 | 中 |
| **业务负责人** | 指标治理的组织保障 | 低 |
| **版本管理** | 口径变更必须可追溯 | 中 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **dbt Semantic Layer 集成** | 输出可直接导入 dbt 的 metrics 配置 | 高 |
| **指标一致性检测** | 检测新指标与已有指标的口径冲突 | 高 |
| **指标依赖图** | 展示复合指标的计算依赖关系 | 中 |
| **多维度口径矩阵** | 自动生成"指标 x 维度"的口径组合 | 中 |
| **自然语言口径解释** | 将公式翻译为业务可理解的中文描述 | 中 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **指标值计算** | 需要执行 SQL，超出提示系统范围 | 定义口径，计算由数仓完成 |
| **指标平台对接** | 各企业指标平台差异大 | 输出标准格式，由用户导入 |
| **指标审批流程** | 组织流程，非提示系统职责 | 生成审批所需材料 |

---

## 场景 5: 生成 DQ 规则

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| 表/模型定义 | 是 | DDL / schema.yml | 目标表结构 |
| 业务规则 | 否 | 自然语言 | 业务层面的数据约束 |
| 数据分布特征 | 否 | 描述 | 已知的数据特征 |
| 严重级别要求 | 否 | 配置 | 哪些检测是 warn/error |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| dbt tests 配置 | schema.yml 片段 | 内置测试配置 |
| 自定义测试 SQL | singular test 文件 | 复杂业务规则检测 |
| dbt-expectations 配置 | YAML | 扩展测试配置 |
| 告警阈值建议 | 配置项 | warn_if / error_if 设置 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **主键唯一性** | 数据完整性的基础保障 | 低 |
| **非空检测** | 必填字段的基本约束 | 低 |
| **参照完整性** | 外键关系验证 | 低 |
| **枚举值检测** | 状态字段的有效值约束 | 低 |
| **数据新鲜度** | 检测数据是否按时更新 | 低 |
| **记录数阈值** | 防止数据量异常（过多/过少） | 低 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **业务规则智能提取** | 从字段名/注释推断应有的 DQ 规则 | 高 |
| **dbt-expectations 集成** | 支持时序、分布、正则等高级检测 | 中 |
| **跨表一致性检测** | 检测上下游数据一致性（如汇总 = 明细之和） | 高 |
| **异常值检测规则** | 基于统计分布生成异常检测 | 高 |
| **DQ 规则模板库** | 常见场景的开箱即用规则集 | 中 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **DQ 规则执行** | 需要运行 dbt test，超出提示系统范围 | 生成配置，由 dbt 执行 |
| **数据修复** | 自动修复可能引入新问题 | 提供修复建议，人工执行 |
| **ML 异常检测** | 需要训练数据和模型，复杂度过高 | 基于规则的静态检测 |

---

## 场景 6: 数据血缘分析

### 输入规格

| 输入项 | 必需 | 格式 | 说明 |
|--------|------|------|------|
| SQL / dbt 模型 | 是 | SQL 文件 | 待分析的代码 |
| 分析范围 | 否 | 表级/字段级 | 分析粒度 |
| 关注字段 | 否 | 字段列表 | 重点追踪的字段 |
| 上下文模型 | 否 | 模型列表 | 相关的上下游模型 |

### 输出规格

| 输出项 | 格式 | 说明 |
|--------|------|------|
| 血缘关系图 | Mermaid/文本 | 表/字段依赖关系 |
| 字段映射表 | 表格 | 源字段 -> 目标字段映射 |
| 变更影响评估 | 列表 | 某字段变更影响的下游 |
| 数据流向说明 | 结构化文本 | 关键数据的流转路径 |

### Table Stakes（必须有）

| 特性 | 为何必须 | 复杂度 |
|------|----------|--------|
| **表级血缘解析** | 最基本的依赖关系识别 | 中 |
| **字段级血缘解析** | 精确追踪数据来源 | 高 |
| **dbt ref 解析** | 理解 dbt 模型间依赖 | 低 |
| **JOIN 关系识别** | 多表关联是血缘的核心 | 中 |
| **转换逻辑识别** | 识别字段的计算/转换逻辑 | 高 |
| **文本格式输出** | 以结构化文本呈现血缘 | 低 |

### Differentiators（差异化）

| 特性 | 价值主张 | 复杂度 |
|------|----------|--------|
| **变更影响分析** | 评估某字段变更的下游影响范围 | 高 |
| **血缘链路完整性** | 从源到目标的完整追溯 | 高 |
| **聚合/窗口函数血缘** | 正确处理复杂 SQL 的字段来源 | 高 |
| **跨模型血缘** | 分析多个 dbt 模型组成的完整链路 | 高 |
| **Mermaid 图生成** | 输出可渲染的流程图代码 | 中 |

### Anti-Features（明确不做）

| 反特性 | 为何不做 | 替代方案 |
|--------|----------|----------|
| **可视化血缘图渲染** | 需要图形能力，超出提示系统范围 | 输出 Mermaid 格式，由用户渲染 |
| **实时血缘同步** | 需要持续监控，是数据治理平台能力 | 按需分析 |
| **数据采样追踪** | 需要访问实际数据 | 基于 SQL 静态分析 |

### 血缘分析边界与降级策略（Codex评审补充）

**支持的SQL结构（高置信度）：**

| SQL结构 | 支持程度 | 说明 |
|---------|---------|------|
| 简单SELECT | ✓ 完全支持 | 直接字段映射 |
| JOIN（INNER/LEFT/RIGHT） | ✓ 完全支持 | 多表关联追踪 |
| 标准聚合（SUM/COUNT/AVG） | ✓ 完全支持 | 聚合来源追踪 |
| CASE WHEN | ✓ 完全支持 | 条件分支追踪 |
| 简单CTE（WITH） | ✓ 完全支持 | 递进式追踪 |
| dbt ref() | ✓ 完全支持 | 模型依赖解析 |

**部分支持的SQL结构（需降级）：**

| SQL结构 | 支持程度 | 降级策略 |
|---------|---------|---------|
| 窗口函数（ROW_NUMBER/LAG/LEAD） | △ 部分支持 | 标记"窗口函数派生"，列出所有PARTITION BY/ORDER BY字段 |
| 嵌套子查询（>2层） | △ 部分支持 | 扁平化为CTE后分析，标记"复杂嵌套" |
| UNION/UNION ALL | △ 部分支持 | 分别追踪各分支，标记"多源合并" |
| LATERAL VIEW explode | △ 部分支持 | 标记"数组展开"，追踪原始array字段 |

**不支持/需人工介入的SQL结构：**

| SQL结构 | 说明 | 处理方式 |
|---------|------|---------|
| **SELECT *** | 无法确定具体字段 | 报错，要求明确字段列表 |
| **动态SQL/UDF** | 逻辑在运行时确定 | 标记"UDF黑盒"，需人工补充 |
| **复杂map/array/struct访问** | 如 `map['key']`、`struct.field` | 标记"复杂类型访问"，需人工确认 |
| **递归CTE** | Hive不支持，但其他方言可能有 | 报错，不支持 |

**降级输出示例：**

```markdown
## 字段级血缘分析结果

### 完全追溯字段
| 目标字段 | 来源 | 转换逻辑 |
|---------|------|---------|
| order_id | ods_orders.order_id | 直接映射 |
| total_amount | ods_orders.amount | SUM聚合 |

### 部分追溯字段（需人工确认）
| 目标字段 | 来源 | 置信度 | 备注 |
|---------|------|--------|------|
| rank_num | ods_orders.* | MEDIUM | 窗口函数派生，PARTITION BY customer_id |
| exploded_item | ods_orders.items | LOW | LATERAL VIEW explode，原始为array |

### 无法追溯字段
| 目标字段 | 原因 | 建议 |
|---------|------|------|
| custom_calc | UDF: my_udf() | 请补充UDF逻辑说明 |
```

---

## 场景间依赖关系

```
                    ┌─────────────────┐
                    │ 2. 设计新模型    │
                    │ (Design)        │
                    └────────┬────────┘
                             │ 输出模型定义
                             ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ 4. 指标口径定义  │◄──│ 3. 生成导数SQL  │──►│ 5. 生成DQ规则   │
│ (Metrics)       │   │ (Query Gen)     │   │ (DQ Rules)      │
└────────┬────────┘   └────────┬────────┘   └────────┬────────┘
         │                     │                     │
         │    指标定义驱动     │    SQL 依赖分析     │    规则关联
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               ▼
                    ┌─────────────────┐
                    │ 6. 血缘分析      │
                    │ (Lineage)       │
                    └────────┬────────┘
                             │ 血缘信息反馈
                             ▼
                    ┌─────────────────┐
                    │ 1. 评审已有模型  │
                    │ (Review)        │
                    └─────────────────┘
```

### 依赖说明

| 上游场景 | 下游场景 | 依赖类型 | 说明 |
|----------|----------|----------|------|
| 设计新模型 | 评审已有模型 | 产出-输入 | 设计完成后需要评审 |
| 设计新模型 | 生成DQ规则 | 产出-输入 | 新模型需要 DQ 规则 |
| 指标口径定义 | 生成导数SQL | 语义依赖 | SQL 需遵循指标口径 |
| 生成导数SQL | 血缘分析 | 产出-输入 | SQL 是血缘分析的输入 |
| 血缘分析 | 评审已有模型 | 信息增强 | 血缘信息辅助评审 |
| 评审已有模型 | 设计新模型 | 反馈循环 | 评审发现问题驱动重设计 |

### 实现优先级建议（MVP Wave）

基于依赖关系，建议实现顺序：

1. **MVP Wave 1: 基础能力**（可独立使用，快速验证）
   - 场景 1: 评审已有模型
   - 场景 5: 生成 DQ 规则

2. **MVP Wave 2: 核心建模**（依赖Wave 1验证）
   - 场景 2: 设计新模型（依赖评审能力验证设计质量）
   - 场景 4: 指标口径定义（为 SQL 生成提供语义基础）

3. **MVP Wave 3: 高级分析**（复杂度高，渐进增强）
   - 场景 3: 生成导数 SQL（需要指标口径支持）
   - 场景 6: 血缘分析（复杂度最高，可渐进增强）

**注意：** 此处"MVP Wave"指功能交付优先级，与ARCHITECTURE.md的"Build Phase 1-8"（架构构建顺序）是不同维度。

---

## MVP 建议

### 第一版必须包含

1. **评审已有模型** — 立即可用，价值明确
   - 命名规范检查
   - 分层合规检查
   - 字段类型/注释完整性
   - dbt 配置完整性

2. **生成 DQ 规则** — 复杂度低，收益高
   - 内置 dbt 测试生成（unique, not_null, accepted_values, relationships）
   - 数据新鲜度检测
   - 记录数阈值

### 第一版延后

- **设计新模型的 SCD 智能推荐** — 需要更多上下文
- **指标一致性检测** — 需要指标库基础
- **跨模型血缘分析** — 复杂度高，可渐进实现
- **性能优化建议** — 依赖执行计划，静态分析有限

---

## 信息来源

### 高置信度来源
- [dbt Data Tests 官方文档](https://docs.getdbt.com/docs/build/data-tests) — dbt 测试类型与配置
- [dbt Semantic Layer 官方文档](https://docs.getdbt.com/docs/use-dbt-semantic-layer/dbt-sl) — 指标定义方法
- [dbt Metrics Overview](https://docs.getdbt.com/docs/build/metrics-overview) — 五类指标定义

### 中置信度来源
- [AWS Text-to-SQL Best Practices](https://aws.amazon.com/blogs/machine-learning/best-practices-for-prompt-engineering-with-meta-llama-3-for-text-to-sql-use-cases/) — SQL 生成最佳实践
- [Google Cloud Text-to-SQL Techniques](https://cloud.google.com/blog/products/databases/techniques-for-improving-text-to-sql) — SQL 生成技术
- [dbt Data Quality Framework](https://www.getdbt.com/blog/building-a-data-quality-framework-with-dbt-and-dbt-cloud) — DQ 框架最佳实践
- [Atlan Data Lineage Tools 2026](https://atlan.com/data-lineage-tools/) — 血缘工具综述

### 低置信度来源（需验证）
- [指标口径标准化实践 - FineBI](https://www.finebi.com/blog/article/695a6bc42c6ebd90bce03440) — 中文指标管理实践
- [数仓指标体系建设 - CSDN](https://blog.csdn.net/zhangliushi/article/details/127157996) — 指标体系方法论

---

## 置信度评估

| 场景 | 置信度 | 说明 |
|------|--------|------|
| 评审已有模型 | MEDIUM | 基于 Kimball 方法论与 dbt 最佳实践，需验证中文环境适用性 |
| 设计新模型 | MEDIUM | Kimball 方法论成熟，但智能推荐需实践验证 |
| 生成导数 SQL | HIGH | Text-to-SQL 领域有充分研究，Hive 语法有明确规范 |
| 指标口径定义 | MEDIUM | dbt Semantic Layer 提供标准，但中文指标体系实践需验证 |
| 生成 DQ 规则 | HIGH | dbt tests 有明确规范，dbt-expectations 有成熟方案 |
| 血缘分析 | MEDIUM | 字段级血缘复杂度高，LLM 能力需实践验证 |

---

## 待解决问题

1. **dbt-hive 限制影响**: dbt-hive 不支持 ephemeral 和 snapshots，对 SCD 实现有何影响？
2. **中文字段注释**: Hive metastore 对中文注释的支持程度？
3. **血缘解析复杂 SQL**: 嵌套子查询、CTE、窗口函数的字段级血缘如何准确解析？
4. **指标版本管理**: dbt Semantic Layer 是否支持指标版本化？

---

*研究完成于 2026-01-30*
