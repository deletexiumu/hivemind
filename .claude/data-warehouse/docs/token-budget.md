---
type: context
title: Token 预算配置
status: active
version: 1.0.0
domain: global
owner: data-platform
updated_at: 2026-01-31
---

# Token 预算配置

> 本文档定义 HiveMind 数仓系统的 Token 预算分配和估算规则。

## 模型上下文预算

基于 Claude 200k 上下文窗口的预算分配：

| 项目 | Tokens | 说明 |
|------|-------:|------|
| model_context_window | 200,000 | 模型上下文上限 |
| reserve_system | 2,000 | 系统提示/框架提示预留 |
| reserve_tools | 1,000 | 工具定义预留（如有） |
| reserve_history | 10,000 | 对话历史预留（多轮场景） |
| reserve_output | 4,000 | 期望最大输出预留 |
| reserve_safety_buffer | 20,000 | 安全缓冲（~10%） |
| **available_for_inputs** | **163,000** | 可用于输入的 Tokens |

**计算公式：**
```
available_for_inputs = context_window - system - tools - history - output - buffer
                     = 200,000 - 2,000 - 1,000 - 10,000 - 4,000 - 20,000
                     = 163,000
```

---

## 单文件治理上限（File Caps）

| 文件类型 | 上限 Tokens | 目标 Tokens | 备注 |
|----------|----------:|----------:|------|
| prompt_file | 2,000 | 1,500 | 场景提示/系统提示 |
| context_file | 2,000 | 1,500 | 上下文/知识库 |
| glossary_file | 2,000 | 1,500 | 术语表 |
| example_block | 400 | 300 | few-shot 单块 |

**说明：**
- **上限**：硬限制，超过必须拆分
- **目标**：推荐值，留出 25% 安全余量

---

## 组装预算

不同场景的运行时组装预算：

| 场景 | max_assembled_tokens | 说明 |
|------|--------------------:|------|
| 简单查询 | 4,000 | 单提示 + 基础上下文 |
| 标准场景 | 8,000 | 提示 + 2-3 个上下文 |
| 复杂分析 | 15,000 | 提示 + 多上下文 + 示例 |
| 完整评审 | 25,000 | 全套上下文 + 代码输入 |

**组装公式：**
```
assembled_tokens = system_prompt
                 + scenario_prompt
                 + Σ(context_files)
                 + user_input
                 + examples
```

---

## Token 估算规则

### 保守估算原则

| 估算口径 | 规则 | 说明 |
|----------|------|------|
| **保守估算** | 1 token ≈ 1 中文字符 | 用于预算规划，含标点空格 |
| 经验估算 | 1 token ≈ 1.5-2 中文字符 | 实测范围，不作硬门槛 |
| 英文估算 | 1 token ≈ 4 字符 | 标准 BPE 估算 |

### 为什么用保守估算？

1. **中文 Token 密度波动大**：1.0-2.5 字符/token 均有可能
2. **混合内容不确定**：代码+中文+标点混排影响估算
3. **安全优先**：宁可高估也不超限
4. **精确检查延后**：Phase 8 工具提供 tokenizer 精确统计

### 快速估算表

| 中文字符数 | 保守估算 Tokens | 经验估算 Tokens |
|----------:|---------------:|---------------:|
| 500 | 500 | 250-330 |
| 1,000 | 1,000 | 500-670 |
| 1,500 | 1,500 | 750-1,000 |
| 2,000 | 2,000 | 1,000-1,330 |
| 3,000 | 3,000 | 1,500-2,000 |

---

## 超限处理策略

### 识别超限

| 指标 | 预警阈值 | 硬限制 |
|------|---------|--------|
| 单文件字符数（中文） | 1,500 | 2,000 |
| 单文件字符数（英文） | 6,000 | 8,000 |
| 组装后总量 | 场景预算 80% | 场景预算 100% |

### 处理流程

```
1. 检测 → 文件字符数 > 1,500（中文）
2. 预警 → 标记为待拆分
3. 分析 → 识别可拆分的独立模块
4. 拆分 → 创建多个 < 1,500 字符的文件
5. 关联 → 使用 includes 声明依赖
6. 验证 → 确认拆分后功能完整
```

### 拆分原则

| 原则 | 说明 |
|------|------|
| 单一职责 | 每个文件只处理一类内容 |
| 逻辑完整 | 拆分后每个文件可独立理解 |
| 最小依赖 | 减少文件间的循环引用 |
| 命名清晰 | 文件名反映内容 |

---

## 监控指标（Phase 8 实现）

### 计划中的监控能力

| 指标 | 说明 | 实现阶段 |
|------|------|---------|
| file_token_count | 单文件精确 Token 数 | Phase 8 |
| assembled_token_count | 组装后总 Token 数 | Phase 8 |
| token_budget_usage | 预算使用百分比 | Phase 8 |
| over_limit_files | 超限文件列表 | Phase 8 |

### 计划中的检查工具

```bash
# Phase 8 将提供的命令（当前不可用）
dw-check tokens prompts/scenarios/order-refund.md
dw-check tokens --all
dw-check assemble --scenario order-refund
```

---

## 预算配置快查表

| 配置项 | 值 | 单位 |
|--------|---:|------|
| 模型上下文 | 200,000 | tokens |
| 可用输入 | 163,000 | tokens |
| 单文件上限 | 2,000 | tokens |
| 单文件目标 | 1,500 | tokens |
| 示例块上限 | 400 | tokens |
| 保守估算 | 1:1 | token:中文字符 |
| 安全缓冲 | 10% | - |

---

## 附录：常见问题

### Q1: 为什么设置 2,000 token 而不是更大？

**A:** 可维护性优先。较小的文件更易于：
- 人工审查和修改
- 版本控制和差异对比
- 模块化组合
- 避免 Mega-Prompt 反模式

### Q2: 经验估算更准确，为什么不用？

**A:** 经验估算的范围太宽（1-2 字符/token），在预算规划时：
- 乐观估算 → 运行时超限 → 功能失效
- 保守估算 → 文件更小 → 更安全

### Q3: 什么时候用精确统计？

**A:** Phase 8 工具化后，以下场景使用精确统计：
- CI/CD 门禁检查
- 自动组装验证
- 容量规划分析

---

*Version: 1.0.0 | Updated: 2026-01-31 | Owner: data-platform*
