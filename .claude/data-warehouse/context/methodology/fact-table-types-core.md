---
type: context-core
source: context/methodology/fact-table-types.md
version: 1.0.0
updated_at: 2026-01-31
tokens_budget: 600-800
---

# 事实表类型精简版

## 类型决策树

```
需要记录什么?
├── 单个业务事件 → 事务事实表 (Append-only, 全维度可 SUM)
├── 固定周期状态 → 周期快照事实表 (每周期新增, 时间不可 SUM)
├── 流程生命周期 → 累积快照事实表 (可更新, 多时间戳)
└── 仅事件存在性 → 无事实事实表 (无度量, COUNT(*))
```

## 类型选择矩阵

| 类型 | 粒度 | 更新方式 | 典型场景 |
|------|------|----------|----------|
| **事务** | 事件时刻 | 只追加 | 订单明细、支付流水 |
| **周期快照** | 周期+实体 | 周期新增 | 日库存、月余额 |
| **累积快照** | 流程实例 | 可更新 | 订单履约进度 |
| **无事实** | 事件存在 | 只追加 | 学生选课、促销覆盖 |

---

## 可加性规则表

| 类型 | 时间可加 | 其他维度可加 | 正确聚合 | 示例 |
|------|:-------:|:-----------:|----------|------|
| **可加** | Y | Y | SUM | 销售金额、订单数量 |
| **半可加** | N | Y | 取最新/AVG | 余额、库存 |
| **不可加** | N | N | 加权平均 | 单价、折扣率 |

### 可加性警告

- 半可加度量: `SUM(balance) across days` = 错误
- 不可加度量: `SUM(unit_price)` = 错误，应 `SUM(amount)/SUM(qty)`

---

## 迟到事实处理

1. **定义回刷窗口**: 最近 7 天分区可回刷
2. **增量模型**: 使用 `insert_overwrite` 覆盖分区
3. **超期处理**: 超窗口数据记录日志，人工处理

---

## 检查清单

- [ ] 事实表类型是否与业务场景匹配
- [ ] 度量是否标注可加性（additive/semi/non）
- [ ] 半可加度量查询是否避免跨时间 SUM
- [ ] 迟到事实是否有回刷窗口策略

---

Source: fact-table-types.md | Updated: 2026-01-31
